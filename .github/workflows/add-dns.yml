name: Add DNS Record v6

on:
  workflow_dispatch:

jobs:
  add-dns:
    runs-on: ubuntu-latest
    steps:
      - name: Install Playwright
        run: |
          npm init -y
          npm install playwright
          npx playwright install chromium

      - name: Add CNAME portal.artvision.pro
        run: |
          cat > add_dns.js << 'EOF'
          const { chromium } = require("playwright");

          (async () => {
            const browser = await chromium.launch({ headless: true });
            const page = await browser.newPage();
            
            // –§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è –≤—Å–µ—Ö –ø–æ–ø–∞–ø–æ–≤
            async function closePopups() {
              const selectors = [
                "button:has-text(\"–ó–∞–∫—Ä—ã—Ç—å\")",
                "button:has-text(\"–ü–æ–Ω—è—Ç–Ω–æ\")",
                "[aria-label=\"Close\"]",
                ".modal-close",
                "button.close",
                // NPS popup close button
                "div:has-text(\"–ø–æ—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç–µ\") button",
                "div:has-text(\"–ø–æ—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç–µ\") >> xpath=following-sibling::button",
                "div:has-text(\"–ø–æ—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç–µ\") ~ button",
                // Generic X buttons
                "button:has-text(\"√ó\")",
                "button:has-text(\"‚úï\")",
              ];
              
              for (const sel of selectors) {
                try {
                  const btns = await page.$$(sel);
                  for (const btn of btns) {
                    await btn.click().catch(() => {});
                    await page.waitForTimeout(200);
                  }
                } catch {}
              }
              
              // –¢–∞–∫–∂–µ –ø—Ä–æ–±—É–µ–º –∑–∞–∫—Ä—ã—Ç—å –ø–æ –ø–æ–∑–∏—Ü–∏–∏ - X –æ–±—ã—á–Ω–æ —Å–ø—Ä–∞–≤–∞
              try {
                const closeX = await page.$("div[class*=\"nps\"] button, div[class*=\"survey\"] button, div[class*=\"feedback\"] button");
                if (closeX) await closeX.click();
              } catch {}
            }
            
            try {
              console.log("üîê –õ–æ–≥–∏–Ω...");
              await page.goto("https://hosting.timeweb.ru/login");
              await page.waitForTimeout(3000);
              await page.fill("input[type=\"text\"]", "cp02586");
              await page.fill("input[type=\"password\"]", "6CNgRdxX222");
              await page.click("button[type=\"submit\"]");
              await page.waitForTimeout(5000);
              
              await closePopups();
              
              console.log("üåê DNS —Ä–µ–¥–∞–∫—Ç–æ—Ä...");
              await page.goto("https://hosting.timeweb.ru/domains/settings/dns-editor?fqdn=artvision.pro");
              await page.waitForTimeout(4000);
              
              await closePopups();
              
              // –ó–∞–∫—Ä—ã–≤–∞–µ–º NPS –ø–æ–ø–∞–ø –ø–æ –∫–Ω–æ–ø–∫–µ X (–æ–Ω–∞ —Å–ø—Ä–∞–≤–∞ –æ—Ç –ø–æ–ø–∞–ø–∞)
              try {
                // –ù–∞—Ö–æ–¥–∏–º —ç–ª–µ–º–µ–Ω—Ç —Å —Ç–µ–∫—Å—Ç–æ–º –ø—Ä–æ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∏ –∫–ª–∏–∫–∞–µ–º X —Ä—è–¥–æ–º
                const npsClose = await page.$("div:has-text(\"–ø–æ—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç–µ\") >> xpath=ancestor::div[1]//button");
                if (npsClose) {
                  await npsClose.click();
                  console.log("‚úÖ NPS –ø–æ–ø–∞–ø –∑–∞–∫—Ä—ã—Ç");
                }
              } catch {}
              
              // –ï—â—ë —Ä–∞–∑ –ø—Ä–æ–±—É–µ–º –∑–∞–∫—Ä—ã—Ç—å –≤—Å–µ X
              try {
                const allX = await page.$$("button >> svg");
                for (const x of allX) {
                  const text = await x.textContent().catch(() => "");
                  if (!text || text.trim() === "") {
                    await x.click().catch(() => {});
                  }
                }
              } catch {}
              
              await page.waitForTimeout(1000);
              await page.screenshot({ path: "before_add.png", fullPage: true });
              
              console.log("‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å...");
              await page.click("text=–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å");
              await page.waitForTimeout(2000);
              
              await closePopups();
              
              // –û—Ç–∫—Ä—ã–≤–∞–µ–º dropdown —Ç–∏–ø–∞
              console.log("üìù –û—Ç–∫—Ä—ã–≤–∞—é dropdown...");
              const typeDropdown = await page.$("div[class*=\"select\"]:has-text(\"A\")");
              if (typeDropdown) {
                await typeDropdown.click();
                await page.waitForTimeout(1000);
              }
              
              // –ö–ª–∏–∫–∞–µ–º –Ω–∞ CNAME
              console.log("üìù –í—ã–±–∏—Ä–∞—é CNAME...");
              
              // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ div —Å —Ç–µ–∫—Å—Ç–æ–º CNAME –∏ –∫–ª–∏–∫–∞–µ–º –Ω–∞ —Ç–æ—Ç –∫–æ—Ç–æ—Ä—ã–π –≤ dropdown
              const cnameElements = await page.$$("div:text-is(\"CNAME\")");
              console.log("–ù–∞–π–¥–µ–Ω–æ CNAME —ç–ª–µ–º–µ–Ω—Ç–æ–≤:", cnameElements.length);
              
              // –ë–µ—Ä—ë–º –ø–µ—Ä–≤—ã–π –∫–æ—Ç–æ—Ä—ã–π –≤–∏–¥–∏–º—ã–π –∏ –≤ dropdown
              for (const el of cnameElements) {
                const isVisible = await el.isVisible();
                if (isVisible) {
                  await el.click();
                  console.log("‚úÖ –ö–ª–∏–∫–Ω—É–ª –Ω–∞ CNAME");
                  break;
                }
              }
              
              await page.waitForTimeout(1500);
              await page.screenshot({ path: "after_cname.png", fullPage: true });
              
              // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è
              console.log("‚úèÔ∏è –ó–∞–ø–æ–ª–Ω—è—é –ø–æ–ª—è...");
              
              // –í—Å–µ input –≤ —Ñ–æ—Ä–º–µ
              const allInputs = await page.$$("input:visible");
              console.log("–í–∏–¥–∏–º—ã—Ö inputs:", allInputs.length);
              
              // –ò—â–µ–º –ø—É—Å—Ç—ã–µ inputs
              let hostFilled = false;
              let valueFilled = false;
              
              for (const input of allInputs) {
                const val = await input.inputValue();
                const type = await input.getAttribute("type");
                
                if (val === "" && type !== "password" && type !== "hidden") {
                  if (!hostFilled) {
                    await input.fill("portal");
                    hostFilled = true;
                    console.log("‚úÖ –•–æ—Å—Ç: portal");
                  } else if (!valueFilled) {
                    await input.fill("cname.vercel-dns.com");
                    valueFilled = true;
                    console.log("‚úÖ –ó–Ω–∞—á–µ–Ω–∏–µ: cname.vercel-dns.com");
                    break;
                  }
                }
              }
              
              await page.screenshot({ path: "form_filled.png", fullPage: true });
              
              console.log("üíæ –°–æ—Ö—Ä–∞–Ω—è—é...");
              await page.click("button:has-text(\"–°–æ—Ö—Ä–∞–Ω–∏—Ç—å\")");
              await page.waitForTimeout(3000);
              
              await page.screenshot({ path: "result.png", fullPage: true });
              console.log("‚úÖ –ì–æ—Ç–æ–≤–æ!");
              
            } catch (e) {
              console.log("‚ùå –û—à–∏–±–∫–∞:", e.message);
              await page.screenshot({ path: "error.png", fullPage: true });
            }
            
            await browser.close();
          })();
          EOF
          
          node add_dns.js
          
      - name: Upload screenshots
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dns-screenshots
          path: "*.png"

