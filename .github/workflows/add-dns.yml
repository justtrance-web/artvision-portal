name: Add DNS v2

on:
  workflow_dispatch:

jobs:
  add-dns:
    runs-on: ubuntu-latest
    steps:
      - name: Install Playwright
        run: |
          npm init -y
          npm install playwright
          npx playwright install chromium

      - name: Add CNAME portal.artvision.pro
        run: |
          cat > add_dns.js << 'SCRIPT'
          const { chromium } = require("playwright");

          (async () => {
            const browser = await chromium.launch({ headless: true });
            const page = await browser.newPage();
            
            try {
              // 1. –õ–æ–≥–∏–Ω
              console.log("üîê –õ–æ–≥–∏–Ω –≤ Timeweb...");
              await page.goto("https://hosting.timeweb.ru/login", { waitUntil: "networkidle" });
              await page.screenshot({ path: "01_login.png" });
              
              // –ò—â–µ–º –ø–æ–ª—è –≤–≤–æ–¥–∞
              const inputs = await page.$$("input");
              console.log(`–ù–∞–π–¥–µ–Ω–æ ${inputs.length} –ø–æ–ª–µ–π –≤–≤–æ–¥–∞`);
              
              // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–µ—Ä–≤–æ–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –ø–æ–ª–µ (–ª–æ–≥–∏–Ω)
              await page.fill("input[type=\"text\"], input[name*=\"login\"], input[name*=\"user\"]", "cp02586");
              // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–∞—Ä–æ–ª—å
              await page.fill("input[type=\"password\"]", "6CNgRdxX222");
              await page.screenshot({ path: "02_filled.png" });
              
              // –ù–∞–∂–∏–º–∞–µ–º –∫–Ω–æ–ø–∫—É –≤—Ö–æ–¥–∞
              await page.click("button[type=\"submit\"], button:has-text(\"–í–æ–π—Ç–∏\"), .login-btn");
              await page.waitForTimeout(5000);
              await page.screenshot({ path: "03_after_login.png" });
              console.log("üìç –ü–æ—Å–ª–µ –ª–æ–≥–∏–Ω–∞:", page.url());
              
              // 2. –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø–æ–ø–∞–ø—ã
              const closeSelectors = [
                "button:has-text(\"–ó–∞–∫—Ä—ã—Ç—å\")",
                "button:has-text(\"–ü–æ–Ω—è—Ç–Ω–æ\")",
                "button:has-text(\"OK\")",
                ".modal-close",
                "[aria-label=\"Close\"]",
                ".close-button"
              ];
              for (const sel of closeSelectors) {
                try {
                  const btn = await page.$(sel);
                  if (btn) {
                    await btn.click();
                    await page.waitForTimeout(500);
                    console.log("–ó–∞–∫—Ä—ã–ª –ø–æ–ø–∞–ø:", sel);
                  }
                } catch {}
              }
              
              // 3. –ò–¥—ë–º –≤ DNS
              console.log("üåê –û—Ç–∫—Ä—ã–≤–∞—é DNS —Ä–µ–¥–∞–∫—Ç–æ—Ä...");
              await page.goto("https://hosting.timeweb.ru/domains/settings/dns-editor?fqdn=artvision.pro", { waitUntil: "networkidle" });
              await page.waitForTimeout(3000);
              await page.screenshot({ path: "04_dns_page.png" });
              
              // –°–Ω–æ–≤–∞ –∑–∞–∫—Ä—ã–≤–∞–µ–º –ø–æ–ø–∞–ø—ã
              for (const sel of closeSelectors) {
                try {
                  const btn = await page.$(sel);
                  if (btn) { await btn.click(); await page.waitForTimeout(300); }
                } catch {}
              }
              
              // 4. –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ —É–∂–µ portal
              const content = await page.content();
              if (content.toLowerCase().includes("portal") && content.toLowerCase().includes("cname.vercel")) {
                console.log("‚úÖ –ó–∞–ø–∏—Å—å portal —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!");
                await page.screenshot({ path: "05_already_exists.png" });
                await browser.close();
                return;
              }
              
              // 5. –ù–∞–∂–∏–º–∞–µ–º –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å
              console.log("‚ûï –ò—â—É –∫–Ω–æ–ø–∫—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è...");
              const addBtnSelectors = [
                "button:has-text(\"–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å\")",
                "button:has-text(\"–î–æ–±–∞–≤–∏—Ç—å\")",
                "a:has-text(\"–î–æ–±–∞–≤–∏—Ç—å\")",
                ".add-record",
                "[data-action=\"add\"]"
              ];
              
              let clicked = false;
              for (const sel of addBtnSelectors) {
                try {
                  const btn = await page.$(sel);
                  if (btn) {
                    await btn.click();
                    clicked = true;
                    console.log("–ù–∞–∂–∞–ª:", sel);
                    break;
                  }
                } catch {}
              }
              
              if (!clicked) {
                console.log("‚ùå –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");
                // –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –ø–æ —Ç–µ–∫—Å—Ç—É
                await page.click("text=–î–æ–±–∞–≤–∏—Ç—å").catch(() => {});
              }
              
              await page.waitForTimeout(2000);
              await page.screenshot({ path: "06_add_form.png" });
              
              // 6. –í—ã–±–∏—Ä–∞–µ–º —Ç–∏–ø CNAME
              console.log("üìù –í—ã–±–∏—Ä–∞—é CNAME...");
              const cnameSelectors = [
                "text=CNAME",
                "option:has-text(\"CNAME\")",
                "[value=\"CNAME\"]",
                "label:has-text(\"CNAME\")"
              ];
              for (const sel of cnameSelectors) {
                try {
                  await page.click(sel);
                  console.log("–í—ã–±—Ä–∞–ª CNAME:", sel);
                  break;
                } catch {}
              }
              await page.waitForTimeout(500);
              await page.screenshot({ path: "07_cname_selected.png" });
              
              // 7. –ó–∞–ø–æ–ª–Ω—è–µ–º —Ö–æ—Å—Ç –∏ –∑–Ω–∞—á–µ–Ω–∏–µ
              console.log("üìù –ó–∞–ø–æ–ª–Ω—è—é –ø–æ–ª—è...");
              
              // –ò—â–µ–º –≤—Å–µ input –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
              const allInputs = await page.$$("input[type=\"text\"], input:not([type])");
              console.log(`–ù–∞–π–¥–µ–Ω–æ ${allInputs.length} —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –ø–æ–ª–µ–π`);
              
              // –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ —Å–µ–ª–µ–∫—Ç–æ—Ä—ã –¥–ª—è —Ö–æ—Å—Ç–∞
              const hostSelectors = [
                "input[name*=\"host\"]",
                "input[name*=\"subdomain\"]",
                "input[placeholder*=\"—Ö–æ—Å—Ç\"]",
                "input[placeholder*=\"–ø–æ–¥–¥–æ–º–µ–Ω\"]"
              ];
              for (const sel of hostSelectors) {
                try {
                  await page.fill(sel, "portal");
                  console.log("–ó–∞–ø–æ–ª–Ω–∏–ª —Ö–æ—Å—Ç:", sel);
                  break;
                } catch {}
              }
              
              // –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ —Å–µ–ª–µ–∫—Ç–æ—Ä—ã –¥–ª—è –∑–Ω–∞—á–µ–Ω–∏—è
              const valueSelectors = [
                "input[name*=\"value\"]",
                "input[name*=\"target\"]",
                "input[name*=\"data\"]",
                "input[placeholder*=\"–∑–Ω–∞—á–µ–Ω–∏–µ\"]",
                "input[placeholder*=\"–∞–¥—Ä–µ—Å\"]"
              ];
              for (const sel of valueSelectors) {
                try {
                  await page.fill(sel, "cname.vercel-dns.com");
                  console.log("–ó–∞–ø–æ–ª–Ω–∏–ª –∑–Ω–∞—á–µ–Ω–∏–µ:", sel);
                  break;
                } catch {}
              }
              
              await page.screenshot({ path: "08_filled_form.png" });
              
              // 8. –°–æ—Ö—Ä–∞–Ω—è–µ–º
              console.log("üíæ –°–æ—Ö—Ä–∞–Ω—è—é...");
              const saveBtnSelectors = [
                "button:has-text(\"–°–æ—Ö—Ä–∞–Ω–∏—Ç—å\")",
                "button:has-text(\"–î–æ–±–∞–≤–∏—Ç—å\")",
                "button[type=\"submit\"]",
                ".save-btn"
              ];
              for (const sel of saveBtnSelectors) {
                try {
                  const btn = await page.$(sel);
                  if (btn) {
                    await btn.click();
                    console.log("–ù–∞–∂–∞–ª —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å:", sel);
                    break;
                  }
                } catch {}
              }
              
              await page.waitForTimeout(3000);
              await page.screenshot({ path: "09_result.png" });
              
              console.log("‚úÖ –ì–æ—Ç–æ–≤–æ!");
              
            } catch (e) {
              console.log("‚ùå –û—à–∏–±–∫–∞:", e.message);
              await page.screenshot({ path: "error.png", fullPage: true });
            }
            
            await browser.close();
          })();
          SCRIPT
          
          node add_dns.js
          
      - name: Upload screenshots
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dns-screenshots
          path: "*.png"

