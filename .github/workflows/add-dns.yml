name: Add DNS Record

on:
  workflow_dispatch:

jobs:
  add-dns:
    runs-on: ubuntu-latest
    steps:
      - name: Install Playwright
        run: |
          npm init -y
          npm install playwright
          npx playwright install chromium

      - name: Add CNAME portal.artvision.pro
        run: |
          cat > add_dns.js << 'EOF'
          const { chromium } = require("playwright");

          (async () => {
            const browser = await chromium.launch({ headless: true });
            const page = await browser.newPage();
            
            try {
              console.log("üîê –õ–æ–≥–∏–Ω –≤ Timeweb...");
              await page.goto("https://hosting.timeweb.ru/login");
              await page.waitForTimeout(2000);
              
              // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É
              await page.fill('input[name="username"], input[name="login"], input[type="text"]', "cp02586");
              await page.fill('input[name="password"], input[type="password"]', "6CNgRdxX222");
              await page.click('button[type="submit"]');
              await page.waitForTimeout(5000);
              
              console.log("üìç –°—Ç—Ä–∞–Ω–∏—Ü–∞:", page.url());
              
              // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø–æ–ø–∞–ø—ã
              const closeBtns = await page.$$('button:has-text("–ó–∞–∫—Ä—ã—Ç—å"), button:has-text("–ü–æ–Ω—è—Ç–Ω–æ"), .modal-close');
              for (const btn of closeBtns) {
                try { await btn.click(); } catch {}
              }
              await page.waitForTimeout(1000);
              
              // –ò–¥—ë–º –≤ DNS —Ä–µ–¥–∞–∫—Ç–æ—Ä
              console.log("üåê DNS —Ä–µ–¥–∞–∫—Ç–æ—Ä...");
              await page.goto("https://hosting.timeweb.ru/domains/settings/dns-editor?fqdn=artvision.pro");
              await page.waitForTimeout(3000);
              
              // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø–æ–ø–∞–ø—ã —Å–Ω–æ–≤–∞
              const closeBtns2 = await page.$$('button:has-text("–ó–∞–∫—Ä—ã—Ç—å"), button:has-text("–ü–æ–Ω—è—Ç–Ω–æ")');
              for (const btn of closeBtns2) {
                try { await btn.click(); } catch {}
              }
              
              // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ —É–∂–µ portal
              const html = await page.content();
              if (html.includes("portal") && html.includes("cname.vercel")) {
                console.log("‚úÖ –ó–∞–ø–∏—Å—å portal —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!");
                await browser.close();
                return;
              }
              
              // –ù–∞–∂–∏–º–∞–µ–º "–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å"
              console.log("‚ûï –î–æ–±–∞–≤–ª—è—é –∑–∞–ø–∏—Å—å...");
              await page.click('text=–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å, button:has-text("–î–æ–±–∞–≤–∏—Ç—å")');
              await page.waitForTimeout(2000);
              
              // –í—ã–±–∏—Ä–∞–µ–º CNAME
              await page.click('text=CNAME');
              await page.waitForTimeout(500);
              
              // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è
              await page.fill('input[placeholder*="—Ö–æ—Å—Ç"], input[name*="host"], input:near(:text("–•–æ—Å—Ç"))', "portal");
              await page.fill('input[placeholder*="–∑–Ω–∞—á–µ–Ω–∏–µ"], input[name*="value"], input:near(:text("–ó–Ω–∞—á–µ–Ω–∏–µ"))', "cname.vercel-dns.com");
              
              // –°–æ—Ö—Ä–∞–Ω—è–µ–º
              await page.click('button:has-text("–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"), button[type="submit"]');
              await page.waitForTimeout(3000);
              
              console.log("‚úÖ DNS –∑–∞–ø–∏—Å—å –¥–æ–±–∞–≤–ª–µ–Ω–∞!");
              
              // –°–∫—Ä–∏–Ω—à–æ—Ç
              await page.screenshot({ path: "dns_result.png", fullPage: true });
              
            } catch (e) {
              console.log("‚ùå –û—à–∏–±–∫–∞:", e.message);
              await page.screenshot({ path: "error.png", fullPage: true });
            }
            
            await browser.close();
          })();
          EOF
          
          node add_dns.js
          
      - name: Upload screenshot
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: screenshots
          path: "*.png"

