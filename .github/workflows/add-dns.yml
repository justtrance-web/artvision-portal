name: Add DNS Record v2

on:
  workflow_dispatch:

jobs:
  add-dns:
    runs-on: ubuntu-latest
    steps:
      - name: Install Playwright
        run: |
          npm init -y
          npm install playwright
          npx playwright install chromium

      - name: Add CNAME portal.artvision.pro
        run: |
          cat > add_dns.js << 'EOF'
          const { chromium } = require("playwright");

          (async () => {
            const browser = await chromium.launch({ headless: true });
            const page = await browser.newPage();
            
            try {
              // –õ–æ–≥–∏–Ω
              console.log("üîê –õ–æ–≥–∏–Ω –≤ Timeweb...");
              await page.goto("https://hosting.timeweb.ru/login");
              await page.waitForTimeout(3000);
              
              // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É –ª–æ–≥–∏–Ω–∞
              await page.fill("input[type=\"text\"]", "cp02586");
              await page.fill("input[type=\"password\"]", "6CNgRdxX222");
              await page.click("button[type=\"submit\"]");
              await page.waitForTimeout(5000);
              
              console.log("üìç URL –ø–æ—Å–ª–µ –ª–æ–≥–∏–Ω–∞:", page.url());
              
              // –ò–¥—ë–º –≤ DNS
              console.log("üåê –û—Ç–∫—Ä—ã–≤–∞—é DNS —Ä–µ–¥–∞–∫—Ç–æ—Ä...");
              await page.goto("https://hosting.timeweb.ru/domains/settings/dns-editor?fqdn=artvision.pro");
              await page.waitForTimeout(4000);
              
              // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø–æ–ø–∞–ø—ã
              try {
                const closeButtons = await page.$$("button:has-text(\"–ó–∞–∫—Ä—ã—Ç—å\"), button:has-text(\"–ü–æ–Ω—è—Ç–Ω–æ\"), .modal__close, [aria-label=\"Close\"]");
                for (const btn of closeButtons) {
                  await btn.click().catch(() => {});
                  await page.waitForTimeout(300);
                }
              } catch {}
              
              // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ —É–∂–µ portal
              const html = await page.content();
              if (html.includes("portal.artvision.pro")) {
                console.log("‚úÖ –ó–∞–ø–∏—Å—å portal —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!");
                await page.screenshot({ path: "already_exists.png", fullPage: true });
                await browser.close();
                return;
              }
              
              // –ù–∞–∂–∏–º–∞–µ–º "+ –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å"
              console.log("‚ûï –ù–∞–∂–∏–º–∞—é –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å...");
              await page.click("text=–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å");
              await page.waitForTimeout(2000);
              
              // –°–∫—Ä–∏–Ω—à–æ—Ç —Ñ–æ—Ä–º—ã
              await page.screenshot({ path: "form_opened.png", fullPage: true });
              
              // –í—ã–±–∏—Ä–∞–µ–º —Ç–∏–ø CNAME (–∫–ª–∏–∫–∞–µ–º –Ω–∞ –≤–∫–ª–∞–¥–∫—É –∏–ª–∏ —Å–µ–ª–µ–∫—Ç)
              console.log("üìù –í—ã–±–∏—Ä–∞—é —Ç–∏–ø CNAME...");
              const cnameTab = await page.$("text=CNAME");
              if (cnameTab) {
                await cnameTab.click();
                await page.waitForTimeout(500);
              }
              
              // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è
              console.log("‚úèÔ∏è –ó–∞–ø–æ–ª–Ω—è—é –ø–æ–ª—è...");
              
              // –ò—â–µ–º –∏–Ω–ø—É—Ç—ã –≤ —Ñ–æ—Ä–º–µ
              const inputs = await page.$$("input[type=\"text\"]");
              console.log("–ù–∞–π–¥–µ–Ω–æ –∏–Ω–ø—É—Ç–æ–≤:", inputs.length);
              
              // –ü–µ—Ä–≤—ã–π –∏–Ω–ø—É—Ç –æ–±—ã—á–Ω–æ —Ö–æ—Å—Ç, –≤—Ç–æ—Ä–æ–π - –∑–Ω–∞—á–µ–Ω–∏–µ
              if (inputs.length >= 2) {
                await inputs[0].fill("portal");
                await inputs[1].fill("cname.vercel-dns.com");
              } else {
                // –ü—Ä–æ–±—É–µ–º –ø–æ placeholder
                await page.fill("input[placeholder*=\"—Ö–æ—Å—Ç\"], input[placeholder*=\"–•–æ—Å—Ç\"], input[name*=\"host\"]", "portal");
                await page.fill("input[placeholder*=\"–∑–Ω–∞—á\"], input[placeholder*=\"–ó–Ω–∞—á\"], input[name*=\"value\"]", "cname.vercel-dns.com");
              }
              
              await page.screenshot({ path: "form_filled.png", fullPage: true });
              
              // –°–æ—Ö—Ä–∞–Ω—è–µ–º
              console.log("üíæ –°–æ—Ö—Ä–∞–Ω—è—é...");
              await page.click("button:has-text(\"–°–æ—Ö—Ä–∞–Ω–∏—Ç—å\"), button:has-text(\"–î–æ–±–∞–≤–∏—Ç—å\"), button[type=\"submit\"]");
              await page.waitForTimeout(3000);
              
              await page.screenshot({ path: "result.png", fullPage: true });
              console.log("‚úÖ –ì–æ—Ç–æ–≤–æ!");
              
            } catch (e) {
              console.log("‚ùå –û—à–∏–±–∫–∞:", e.message);
              await page.screenshot({ path: "error.png", fullPage: true });
            }
            
            await browser.close();
          })();
          EOF
          
          node add_dns.js
          
      - name: Upload screenshots
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dns-screenshots
          path: "*.png"

