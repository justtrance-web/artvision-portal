name: Add DNS Record v3

on:
  workflow_dispatch:

jobs:
  add-dns:
    runs-on: ubuntu-latest
    steps:
      - name: Install Playwright
        run: |
          npm init -y
          npm install playwright
          npx playwright install chromium

      - name: Add CNAME portal.artvision.pro
        run: |
          cat > add_dns.js << 'EOF'
          const { chromium } = require("playwright");

          (async () => {
            const browser = await chromium.launch({ headless: true });
            const page = await browser.newPage();
            
            try {
              // –õ–æ–≥–∏–Ω
              console.log("üîê –õ–æ–≥–∏–Ω –≤ Timeweb...");
              await page.goto("https://hosting.timeweb.ru/login");
              await page.waitForTimeout(3000);
              
              await page.fill("input[type=\"text\"]", "cp02586");
              await page.fill("input[type=\"password\"]", "6CNgRdxX222");
              await page.click("button[type=\"submit\"]");
              await page.waitForTimeout(5000);
              
              // DNS —Ä–µ–¥–∞–∫—Ç–æ—Ä
              console.log("üåê –û—Ç–∫—Ä—ã–≤–∞—é DNS —Ä–µ–¥–∞–∫—Ç–æ—Ä...");
              await page.goto("https://hosting.timeweb.ru/domains/settings/dns-editor?fqdn=artvision.pro");
              await page.waitForTimeout(4000);
              
              // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø–æ–ø–∞–ø—ã
              try {
                const closeButtons = await page.$$("button:has-text(\"–ó–∞–∫—Ä—ã—Ç—å\"), button:has-text(\"–ü–æ–Ω—è—Ç–Ω–æ\")");
                for (const btn of closeButtons) {
                  await btn.click().catch(() => {});
                  await page.waitForTimeout(300);
                }
              } catch {}
              
              // –ù–∞–∂–∏–º–∞–µ–º "+ –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å"
              console.log("‚ûï –ù–∞–∂–∏–º–∞—é –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å...");
              await page.click("text=–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å");
              await page.waitForTimeout(2000);
              
              // –í–ê–ñ–ù–û: –í—ã–±–∏—Ä–∞–µ–º —Ç–∏–ø CNAME –≤ —Å–µ–ª–µ–∫—Ç–µ
              console.log("üìù –í—ã–±–∏—Ä–∞—é —Ç–∏–ø CNAME...");
              
              // –ö–ª–∏–∫–∞–µ–º –Ω–∞ —Å–µ–ª–µ–∫—Ç —Ç–∏–ø–∞ (–æ–Ω –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç "A")
              await page.click("div:has-text(\"–¢–∏–ø\") >> xpath=following-sibling::*//select | select");
              await page.waitForTimeout(500);
              
              // –ò–ª–∏ —á–µ—Ä–µ–∑ –∫–ª–∏–∫ –Ω–∞ —Å–∞–º —Å–µ–ª–µ–∫—Ç
              const selectElement = await page.$("select");
              if (selectElement) {
                await selectElement.selectOption("CNAME");
                console.log("‚úÖ CNAME –≤—ã–±—Ä–∞–Ω —á–µ—Ä–µ–∑ select");
              } else {
                // –ï—Å–ª–∏ —ç—Ç–æ –∫–∞—Å—Ç–æ–º–Ω—ã–π dropdown
                await page.click("text=A >> xpath=ancestor::*[contains(@class,\"select\")]");
                await page.waitForTimeout(500);
                await page.click("text=CNAME");
                console.log("‚úÖ CNAME –≤—ã–±—Ä–∞–Ω —á–µ—Ä–µ–∑ dropdown");
              }
              
              await page.waitForTimeout(1000);
              await page.screenshot({ path: "after_cname_select.png", fullPage: true });
              
              // –ó–∞–ø–æ–ª–Ω—è–µ–º –•–æ—Å—Ç
              console.log("‚úèÔ∏è –ó–∞–ø–æ–ª–Ω—è—é –•–æ—Å—Ç: portal");
              const hostInput = await page.$("input[placeholder*=\"–•–æ—Å—Ç\"], input[name*=\"host\"], input:below(:text(\"–•–æ—Å—Ç\"))");
              if (hostInput) {
                await hostInput.fill("portal");
              } else {
                // –ò—â–µ–º –ø–µ—Ä–≤—ã–π –ø—É—Å—Ç–æ–π input –ø–æ—Å–ª–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞ –•–æ—Å—Ç
                await page.fill("input >> nth=0", "portal");
              }
              
              await page.waitForTimeout(500);
              
              // –ó–∞–ø–æ–ª–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ CNAME  
              console.log("‚úèÔ∏è –ó–∞–ø–æ–ª–Ω—è—é –∑–Ω–∞—á–µ–Ω–∏–µ: cname.vercel-dns.com");
              const valueInput = await page.$("input[placeholder*=\"–ó–Ω–∞—á–µ–Ω–∏–µ\"], input[name*=\"value\"], input:below(:text(\"–ó–Ω–∞—á–µ–Ω–∏–µ\"))");
              if (valueInput) {
                await valueInput.fill("cname.vercel-dns.com");
              } else {
                await page.fill("input >> nth=1", "cname.vercel-dns.com");
              }
              
              await page.screenshot({ path: "form_filled.png", fullPage: true });
              
              // –°–æ—Ö—Ä–∞–Ω—è–µ–º
              console.log("üíæ –°–æ—Ö—Ä–∞–Ω—è—é...");
              await page.click("button:has-text(\"–°–æ—Ö—Ä–∞–Ω–∏—Ç—å\")");
              await page.waitForTimeout(3000);
              
              await page.screenshot({ path: "result.png", fullPage: true });
              console.log("‚úÖ –ì–æ—Ç–æ–≤–æ!");
              
            } catch (e) {
              console.log("‚ùå –û—à–∏–±–∫–∞:", e.message);
              await page.screenshot({ path: "error.png", fullPage: true });
            }
            
            await browser.close();
          })();
          EOF
          
          node add_dns.js
          
      - name: Upload screenshots
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dns-screenshots
          path: "*.png"

