name: Daily Tasks Notification

on:
  schedule:
    # 10:30 MSK = 07:30 UTC
    - cron: '30 7 * * 1-5'  # –ü–Ω-–ü—Ç –≤ 10:30 –ø–æ –ú–æ—Å–∫–≤–µ
  workflow_dispatch:  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –¥–ª—è —Ç–µ—Å—Ç–∞

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Get today's tasks from Asana
        id: tasks
        run: |
          TODAY=$(date +%Y-%m-%d)
          
          # –ü–æ–ª—É—á–∞–µ–º –∑–∞–¥–∞—á–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
          TASKS=$(curl -s -X GET \
            "https://app.asana.com/api/1.0/tasks?project=${{ secrets.ASANA_PROJECT }}&opt_fields=name,due_on,assignee.name,completed&completed_since=now" \
            -H "Authorization: Bearer ${{ secrets.ASANA_TOKEN }}" | \
            python3 -c "
import sys, json
from datetime import datetime

data = json.load(sys.stdin)
today = datetime.now().strftime('%Y-%m-%d')
tasks = data.get('data', [])

# –§–∏–ª—å—Ç—Ä—É–µ–º –∑–∞–¥–∞—á–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è –∏ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ
today_tasks = []
overdue_tasks = []

for t in tasks:
    if t.get('completed'):
        continue
    due = t.get('due_on')
    if due == today:
        today_tasks.append(t)
    elif due and due < today:
        overdue_tasks.append(t)

# –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
msg = 'üåÖ *–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ!*\n\n'

if overdue_tasks:
    msg += 'üî¥ *–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ:*\n'
    for t in overdue_tasks[:5]:
        assignee = t.get('assignee', {}).get('name', '?') if t.get('assignee') else '‚Äî'
        msg += f\"‚Ä¢ {t['name']} ({assignee})\n\"
    msg += '\n'

if today_tasks:
    msg += 'üìã *–ù–∞ —Å–µ–≥–æ–¥–Ω—è:*\n'
    for t in today_tasks[:10]:
        assignee = t.get('assignee', {}).get('name', '?') if t.get('assignee') else '‚Äî'
        msg += f\"‚Ä¢ {t['name']} ({assignee})\n\"
else:
    msg += '‚ú® –ù–∞ —Å–µ–≥–æ–¥–Ω—è –∑–∞–¥–∞—á –Ω–µ—Ç!\n'

msg += '\n_–•–æ—Ä–æ—à–µ–≥–æ –¥–Ω—è!_ üöÄ'
print(msg)
")
          
          echo "message<<EOFMSG" >> $GITHUB_OUTPUT
          echo "$TASKS" >> $GITHUB_OUTPUT
          echo "EOFMSG" >> $GITHUB_OUTPUT

      - name: Send to Telegram
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=161261652" \
            -d "parse_mode=Markdown" \
            --data-urlencode "text=${{ steps.tasks.outputs.message }}"
          
          # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º Anton —Ç–æ–∂–µ
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=161261562" \
            -d "parse_mode=Markdown" \
            --data-urlencode "text=${{ steps.tasks.outputs.message }}"
