name: Daily Tasks Notification

on:
  schedule:
    - cron: '30 7 * * 1-5'
  workflow_dispatch:

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Get tasks and notify
        env:
          ASANA_TOKEN: ${{ secrets.ASANA_TOKEN }}
          ASANA_PROJECT: ${{ secrets.ASANA_PROJECT }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        run: |
          TODAY=$(date +%Y-%m-%d)
          
          curl -s "https://app.asana.com/api/1.0/tasks?project=${ASANA_PROJECT}&opt_fields=name,due_on,assignee.name,completed&completed_since=now" \
            -H "Authorization: Bearer ${ASANA_TOKEN}" > /tmp/tasks.json
          
          python3 -c "
          import json
          from datetime import datetime
          
          with open('/tmp/tasks.json') as f:
              data = json.load(f)
          
          today = datetime.now().strftime('%Y-%m-%d')
          tasks = data.get('data', [])
          
          today_tasks = []
          overdue = []
          
          for t in tasks:
              if t.get('completed'): continue
              due = t.get('due_on')
              if due == today: today_tasks.append(t)
              elif due and due < today: overdue.append(t)
          
          msg = ['ðŸŒ… *Ð”Ð¾Ð±Ñ€Ð¾Ðµ ÑƒÑ‚Ñ€Ð¾!*', '']
          
          if overdue:
              msg.append('ðŸ”´ *ÐŸÑ€Ð¾ÑÑ€Ð¾Ñ‡ÐµÐ½Ð¾:*')
              for t in overdue[:5]:
                  a = t.get('assignee',{}).get('name','â€”') if t.get('assignee') else 'â€”'
                  msg.append(f\"â€¢ {t['name']} ({a})\")
              msg.append('')
          
          if today_tasks:
              msg.append('ðŸ“‹ *ÐÐ° ÑÐµÐ³Ð¾Ð´Ð½Ñ:*')
              for t in today_tasks[:10]:
                  a = t.get('assignee',{}).get('name','â€”') if t.get('assignee') else 'â€”'
                  msg.append(f\"â€¢ {t['name']} ({a})\")
          else:
              msg.append('âœ¨ ÐÐ° ÑÐµÐ³Ð¾Ð´Ð½Ñ Ð·Ð°Ð´Ð°Ñ‡ Ð½ÐµÑ‚!')
          
          msg.extend(['', '_Ð¥Ð¾Ñ€Ð¾ÑˆÐµÐ³Ð¾ Ð´Ð½Ñ!_ ðŸš€'])
          
          with open('/tmp/message.txt', 'w') as f:
              f.write('\n'.join(msg))
          "
          
          MESSAGE=$(cat /tmp/message.txt)
          
          for CHAT_ID in 161261652 161261562; do
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -d "chat_id=${CHAT_ID}" \
              -d "parse_mode=Markdown" \
              --data-urlencode "text=${MESSAGE}"
          done
          
          echo "âœ… Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ñ‹"
