name: Setup Portal

on:
  workflow_dispatch:

jobs:
  setup-supabase:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Run SQL via Management API
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          # SQL для выполнения
          SQL=$(cat << 'ENDSQL'
          CREATE TABLE IF NOT EXISTS clients (
              id TEXT PRIMARY KEY,
              name TEXT NOT NULL,
              domain TEXT,
              type TEXT NOT NULL,
              status TEXT NOT NULL DEFAULT 'presale',
              telegram_chat_id BIGINT,
              created_at TIMESTAMPTZ DEFAULT NOW()
          );

          CREATE TABLE IF NOT EXISTS reports (
              id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
              client_id TEXT REFERENCES clients(id),
              title TEXT NOT NULL,
              type TEXT NOT NULL,
              file_url TEXT,
              month TEXT,
              created_at TIMESTAMPTZ DEFAULT NOW()
          );

          CREATE TABLE IF NOT EXISTS positions (
              id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
              client_id TEXT REFERENCES clients(id),
              keyword TEXT NOT NULL,
              position INTEGER,
              url TEXT,
              search_engine TEXT DEFAULT 'yandex',
              region TEXT DEFAULT 'spb',
              checked_at TIMESTAMPTZ DEFAULT NOW()
          );

          INSERT INTO clients (id, name, domain, type, status) VALUES
          ('tvorim', 'Творим Совершенство', 'tvorimsovershenstvo.ru', 'dental', 'active'),
          ('atribeaute', 'Atribeaute Clinique', 'atribeaute.ru', 'dental', 'active'),
          ('ant', 'ANT Partners', 'ant-partners.ru', 'legal', 'active'),
          ('vlpco', 'VLPCo', 'vlpco.ru', 'ecommerce', 'active'),
          ('burenie', 'Бурение скважин', 'burenie-skv.ru', 'industrial', 'active'),
          ('escooter', 'Электросамокаты СПб', NULL, 'repair', 'presale'),
          ('geely', 'Geely A2Auto', 'geely-a2auto.ru', 'automotive', 'presale')
          ON CONFLICT (id) DO NOTHING;
          ENDSQL
          )
          
          echo "Executing SQL via Supabase API..."
          
          # Supabase Management API для SQL
          curl -X POST "https://api.supabase.com/v1/projects/fgnegxazufjriauvfkfy/database/query" \
            -H "Authorization: Bearer $SUPABASE_ACCESS_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{\"query\": $(echo "$SQL" | jq -Rs .)}"
          
          echo ""
          echo "Checking tables..."
          curl -X POST "https://api.supabase.com/v1/projects/fgnegxazufjriauvfkfy/database/query" \
            -H "Authorization: Bearer $SUPABASE_ACCESS_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"query": "SELECT tablename FROM pg_tables WHERE schemaname = '\''public'\''"}' 
