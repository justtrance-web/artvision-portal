name: Setup DNS

on:
  workflow_dispatch:

jobs:
  setup-dns:
    runs-on: ubuntu-latest
    steps:
      - name: Install Playwright
        run: |
          npm init -y
          npm install playwright
          npx playwright install chromium
      
      - name: Add CNAME record
        run: |
          cat > setup_dns.js << 'SCRIPT'
          const { chromium } = require('playwright');

          (async () => {
            const browser = await chromium.launch({ headless: true });
            const page = await browser.newPage();
            
            try {
              // –õ–æ–≥–∏–Ω
              console.log('üåê –õ–æ–≥–∏–Ω—é—Å—å –≤ Timeweb...');
              await page.goto('https://hosting.timeweb.ru/login', { timeout: 60000 });
              await page.waitForTimeout(2000);
              await page.fill('input[name="username"]', 'cp02586');
              await page.fill('input[name="password"]', '6CNgRdxX222');
              await page.click('button[type="submit"]');
              await page.waitForTimeout(5000);
              console.log('‚úÖ –í–æ—à–ª–∏:', page.url());
              
              // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ DNS —Ä–µ–¥–∞–∫—Ç–æ—Ä
              console.log('üîç –û—Ç–∫—Ä—ã–≤–∞—é DNS artvision.pro...');
              await page.goto('https://hosting.timeweb.ru/domains/settings/dns-editor?fqdn=artvision.pro');
              await page.waitForTimeout(3000);
              
              // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø–æ–ø–∞–ø –µ—Å–ª–∏ –µ—Å—Ç—å
              const closeBtn = await page.$('button:has-text("–ó–∞–∫—Ä—ã—Ç—å")');
              if (closeBtn) {
                await closeBtn.click();
                await page.waitForTimeout(500);
              }
              
              // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ —É–∂–µ portal
              const content = await page.content();
              if (content.includes('portal.artvision.pro') || content.includes('portal\t')) {
                console.log('‚ö†Ô∏è –ó–∞–ø–∏—Å—å portal —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!');
                await page.screenshot({ path: 'already_exists.png', fullPage: true });
                await browser.close();
                return;
              }
              
              // –ù–∞–∂–∏–º–∞–µ–º "–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å"
              console.log('‚ûï –ù–∞–∂–∏–º–∞—é "–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å"...');
              await page.click('button:has-text("–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å")');
              await page.waitForTimeout(1500);
              await page.screenshot({ path: '01_form_opened.png', fullPage: true });
              
              // –í—ã–±–∏—Ä–∞–µ–º —Ç–∏–ø CNAME
              console.log('üìù –í—ã–±–∏—Ä–∞—é —Ç–∏–ø CNAME...');
              // –ù–∞—Ö–æ–¥–∏–º select —Å —Ç–∏–ø–æ–º
              const typeSelect = await page.$('select');
              if (typeSelect) {
                await typeSelect.click();
                await page.waitForTimeout(300);
                // –í—ã–±–∏—Ä–∞–µ–º CNAME
                await typeSelect.selectOption('CNAME');
                await page.waitForTimeout(500);
              } else {
                // –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ select, –∞ –∫–∞—Å—Ç–æ–º–Ω—ã–π dropdown
                const typeDropdown = await page.$('[class*="select"], [class*="dropdown"]');
                if (typeDropdown) {
                  await typeDropdown.click();
                  await page.waitForTimeout(300);
                  await page.click('text=CNAME');
                  await page.waitForTimeout(500);
                }
              }
              
              await page.screenshot({ path: '02_type_selected.png', fullPage: true });
              
              // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ö–æ—Å—Ç = portal
              console.log('üìù –í–≤–æ–∂—É —Ö–æ—Å—Ç: portal');
              // –ü–æ–ª–µ —Ö–æ—Å—Ç–∞ - –ø–µ—Ä–≤—ã–π input –ø–æ—Å–ª–µ —Ç–∏–ø–∞
              const inputs = await page.$$('input[type="text"], input:not([type])');
              for (const input of inputs) {
                const placeholder = await input.getAttribute('placeholder');
                const name = await input.getAttribute('name');
                console.log('Input:', name, placeholder);
                
                // –ü–æ–ª–µ —Ö–æ—Å—Ç–∞ –æ–±—ã—á–Ω–æ –ø–µ—Ä–≤–æ–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ
                if (placeholder?.includes('–•–æ—Å—Ç') || placeholder?.includes('–ø–æ–¥–¥–æ–º–µ–Ω') || name?.includes('host') || name?.includes('name')) {
                  await input.fill('portal');
                  console.log('‚úÖ –ó–∞–ø–æ–ª–Ω–∏–ª —Ö–æ—Å—Ç');
                  break;
                }
              }
              
              // –ò—â–µ–º –ø–æ–ª–µ –¥–ª—è –≤–≤–æ–¥–∞ —Ö–æ—Å—Ç–∞ —Ä—è–¥–æ–º —Å .artvision.pro
              const hostInput = await page.$('input:near(:text(".artvision.pro"))');
              if (hostInput) {
                await hostInput.fill('portal');
                console.log('‚úÖ –ó–∞–ø–æ–ª–Ω–∏–ª —Ö–æ—Å—Ç (near –º–µ—Ç–æ–¥)');
              }
              
              await page.waitForTimeout(500);
              
              // –ó–∞–ø–æ–ª–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ CNAME
              console.log('üìù –í–≤–æ–∂—É –∑–Ω–∞—á–µ–Ω–∏–µ: cname.vercel-dns.com');
              // –ü–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ CNAME –¥–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è –ø–æ–ª–µ –¥–ª—è –¥–æ–º–µ–Ω–∞
              const valueInputs = await page.$$('input');
              for (const input of valueInputs) {
                const placeholder = await input.getAttribute('placeholder');
                const value = await input.inputValue();
                
                // –ü–æ–ª–µ –∑–Ω–∞—á–µ–Ω–∏—è - –æ–±—ã—á–Ω–æ –≤—Ç–æ—Ä–æ–µ –∏–ª–∏ —Å placeholder –ø—Ä–æ –¥–æ–º–µ–Ω
                if (!value && (placeholder?.toLowerCase().includes('–¥–æ–º–µ–Ω') || placeholder?.toLowerCase().includes('–∑–Ω–∞—á–µ–Ω–∏–µ') || placeholder?.toLowerCase().includes('target'))) {
                  await input.fill('cname.vercel-dns.com');
                  console.log('‚úÖ –ó–∞–ø–æ–ª–Ω–∏–ª –∑–Ω–∞—á–µ–Ω–∏–µ');
                  break;
                }
              }
              
              // –ü—Ä–æ–±—É–µ–º –∑–∞–ø–æ–ª–Ω–∏—Ç—å –≤—Å–µ –ø—É—Å—Ç—ã–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –∏–Ω–ø—É—Ç—ã –ø–æ –ø–æ—Ä—è–¥–∫—É
              const allInputs = await page.$$('input:visible');
              let filledHost = false;
              let filledValue = false;
              
              for (const input of allInputs) {
                const type = await input.getAttribute('type');
                if (type === 'hidden') continue;
                
                const value = await input.inputValue();
                if (value) continue; // –£–∂–µ –∑–∞–ø–æ–ª–Ω–µ–Ω
                
                if (!filledHost) {
                  await input.fill('portal');
                  filledHost = true;
                  console.log('–ó–∞–ø–æ–ª–Ω–∏–ª –ø–µ—Ä–≤—ã–π –ø—É—Å—Ç–æ–π –∏–Ω–ø—É—Ç: portal');
                } else if (!filledValue) {
                  await input.fill('cname.vercel-dns.com');
                  filledValue = true;
                  console.log('–ó–∞–ø–æ–ª–Ω–∏–ª –≤—Ç–æ—Ä–æ–π –ø—É—Å—Ç–æ–π –∏–Ω–ø—É—Ç: cname.vercel-dns.com');
                  break;
                }
              }
              
              await page.screenshot({ path: '03_form_filled.png', fullPage: true });
              
              // –ù–∞–∂–∏–º–∞–µ–º –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
              console.log('üíæ –°–æ—Ö—Ä–∞–Ω—è—é...');
              await page.click('button:has-text("–°–æ—Ö—Ä–∞–Ω–∏—Ç—å")');
              await page.waitForTimeout(3000);
              
              await page.screenshot({ path: '04_result.png', fullPage: true });
              
              // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
              const finalContent = await page.content();
              if (finalContent.includes('portal')) {
                console.log('‚úÖ –ó–∞–ø–∏—Å—å portal –¥–æ–±–∞–≤–ª–µ–Ω–∞!');
              } else {
                console.log('‚ö†Ô∏è –ù–µ —É–≤–µ—Ä–µ–Ω –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ, –ø—Ä–æ–≤–µ—Ä—å —Å–∫—Ä–∏–Ω—à–æ—Ç');
              }
              
            } catch (e) {
              console.error('‚ùå –û—à–∏–±–∫–∞:', e.message);
              await page.screenshot({ path: 'error.png', fullPage: true });
            }
            
            await browser.close();
          })();
          SCRIPT
          
          node setup_dns.js
      
      - name: Upload screenshots
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: screenshots
          path: "*.png"
