name: Setup DNS

on:
  workflow_dispatch:

jobs:
  setup-dns:
    runs-on: ubuntu-latest
    steps:
      - name: Install Playwright
        run: |
          npm init -y
          npm install playwright
          npx playwright install chromium
      
      - name: Add CNAME record
        run: |
          cat > setup_dns.js << 'SCRIPT'
          const { chromium } = require('playwright');

          (async () => {
            const browser = await chromium.launch({ headless: true });
            const page = await browser.newPage();
            
            try {
              console.log('ðŸŒ Ð›Ð¾Ð³Ð¸Ð½ÑŽÑÑŒ...');
              await page.goto('https://hosting.timeweb.ru/login');
              await page.waitForTimeout(2000);
              await page.fill('input[name="username"]', 'cp02586');
              await page.fill('input[name="password"]', '6CNgRdxX222');
              await page.click('button[type="submit"]');
              await page.waitForTimeout(5000);
              console.log('âœ… Ð’Ð¾ÑˆÐ»Ð¸');
              
              console.log('ðŸ” ÐžÑ‚ÐºÑ€Ñ‹Ð²Ð°ÑŽ DNS...');
              await page.goto('https://hosting.timeweb.ru/domains/settings/dns-editor?fqdn=artvision.pro');
              await page.waitForTimeout(4000);
              
              // Ð—Ð°ÐºÑ€Ñ‹Ð²Ð°ÐµÐ¼ Ð¿Ð¾Ð¿Ð°Ð¿Ñ‹
              await page.evaluate(() => {
                document.querySelectorAll('[class*="nps"], [class*="survey"]').forEach(el => el.remove());
              });
              for (let i = 0; i < 3; i++) {
                await page.keyboard.press('Escape');
                await page.waitForTimeout(300);
              }
              try { await page.click('button:has-text("Ð—Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ")', { timeout: 1000 }); } catch {}
              
              await page.screenshot({ path: '01_clean.png', fullPage: true });
              
              // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ portal
              const html = await page.content();
              if (html.includes('portal.artvision.pro')) {
                console.log('âš ï¸ Ð—Ð°Ð¿Ð¸ÑÑŒ portal Ð£Ð–Ð• Ð•Ð¡Ð¢Ð¬!');
                await browser.close();
                return;
              }
              
              // ÐÐ°Ð¶Ð¸Ð¼Ð°ÐµÐ¼ "Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ð·Ð°Ð¿Ð¸ÑÑŒ"
              console.log('âž• Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ð·Ð°Ð¿Ð¸ÑÑŒ...');
              await page.click('button:has-text("Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ð·Ð°Ð¿Ð¸ÑÑŒ")');
              await page.waitForTimeout(2000);
              await page.waitForSelector('text=ÐÐ¾Ð²Ð°Ñ Ð·Ð°Ð¿Ð¸ÑÑŒ', { timeout: 5000 });
              
              await page.screenshot({ path: '02_modal.png', fullPage: true });
              
              // Ð’Ñ‹Ð±Ð¸Ñ€Ð°ÐµÐ¼ CNAME Ñ‡ÐµÑ€ÐµÐ· selectOption Ð½Ð° ÐŸÐ•Ð Ð’ÐžÐœ select Ð½Ð° ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ðµ
              console.log('ðŸ“ Ð’Ñ‹Ð±Ð¸Ñ€Ð°ÑŽ CNAME...');
              await page.selectOption('select', 'CNAME');
              console.log('âœ… CNAME Ð²Ñ‹Ð±Ñ€Ð°Ð½');
              
              await page.waitForTimeout(1000);
              await page.screenshot({ path: '03_cname_selected.png', fullPage: true });
              
              // Ð—Ð°Ð¿Ð¾Ð»Ð½ÑÐµÐ¼ Ñ…Ð¾ÑÑ‚ - Ð¿ÐµÑ€Ð²Ð¾Ðµ ÐŸÐ£Ð¡Ð¢ÐžÐ• Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ð¾Ðµ Ð¿Ð¾Ð»Ðµ
              console.log('ðŸ“ Ð—Ð°Ð¿Ð¾Ð»Ð½ÑÑŽ Ñ…Ð¾ÑÑ‚: portal');
              const hostInput = page.locator('input[type="text"]').first();
              await hostInput.fill('portal');
              console.log('âœ… Ð¥Ð¾ÑÑ‚ Ð·Ð°Ð¿Ð¾Ð»Ð½ÐµÐ½');
              
              await page.waitForTimeout(500);
              
              // Ð—Ð°Ð¿Ð¾Ð»Ð½ÑÐµÐ¼ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ - Ð²Ñ‚Ð¾Ñ€Ð¾Ðµ Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ð¾Ðµ Ð¿Ð¾Ð»Ðµ
              console.log('ðŸ“ Ð—Ð°Ð¿Ð¾Ð»Ð½ÑÑŽ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ: cname.vercel-dns.com');
              const valueInput = page.locator('input[type="text"]').nth(1);
              await valueInput.fill('cname.vercel-dns.com');
              console.log('âœ… Ð—Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ Ð·Ð°Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¾');
              
              await page.screenshot({ path: '04_filled.png', fullPage: true });
              
              // ÐÐ°Ð¶Ð¸Ð¼Ð°ÐµÐ¼ Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ
              console.log('ðŸ’¾ Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÑŽ...');
              await page.click('button:has-text("Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ")');
              console.log('âœ… ÐšÐ½Ð¾Ð¿ÐºÐ° Ð½Ð°Ð¶Ð°Ñ‚Ð°');
              
              await page.waitForTimeout(4000);
              await page.screenshot({ path: '05_result.png', fullPage: true });
              
              // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚
              const result = await page.content();
              if (result.includes('portal') && !result.includes('ÐÐ¾Ð²Ð°Ñ Ð·Ð°Ð¿Ð¸ÑÑŒ')) {
                console.log('âœ…âœ…âœ… Ð£Ð¡ÐŸÐ•Ð¥! Ð—Ð°Ð¿Ð¸ÑÑŒ portal Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð°!');
              } else if (result.includes('ÐÐ¾Ð²Ð°Ñ Ð·Ð°Ð¿Ð¸ÑÑŒ')) {
                console.log('âš ï¸ Ð¤Ð¾Ñ€Ð¼Ð° Ð²ÑÑ‘ ÐµÑ‰Ñ‘ Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚Ð°');
              } else {
                console.log('â“ ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒ ÑÐºÑ€Ð¸Ð½ÑˆÐ¾Ñ‚');
              }
              
            } catch (e) {
              console.error('âŒ', e.message);
              await page.screenshot({ path: 'error.png', fullPage: true });
            }
            
            await browser.close();
          })();
          SCRIPT
          
          node setup_dns.js
      
      - name: Upload screenshots
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: screenshots
          path: "*.png"
