name: Setup DNS

on:
  workflow_dispatch:

jobs:
  setup-dns:
    runs-on: ubuntu-latest
    steps:
      - name: Install Playwright
        run: |
          npm init -y
          npm install playwright
          npx playwright install chromium
      
      - name: Add CNAME record
        run: |
          cat > setup_dns.js << 'SCRIPT'
          const { chromium } = require('playwright');

          (async () => {
            const browser = await chromium.launch({ headless: true });
            const page = await browser.newPage();
            
            try {
              // –õ–æ–≥–∏–Ω
              console.log('üåê –û—Ç–∫—Ä—ã–≤–∞—é Timeweb...');
              await page.goto('https://hosting.timeweb.ru/login', { timeout: 60000 });
              await page.waitForTimeout(2000);
              
              console.log('üîë –õ–æ–≥–∏–Ω—é—Å—å...');
              await page.fill('input[name="username"]', 'cp02586');
              await page.fill('input[name="password"]', '6CNgRdxX222');
              await page.click('button[type="submit"]');
              await page.waitForTimeout(5000);
              
              console.log('URL:', page.url());
              
              // –ò–¥—ë–º –ø—Ä—è–º–æ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É DNS artvision.pro
              console.log('üîç –û—Ç–∫—Ä—ã–≤–∞—é DNS artvision.pro...');
              
              // –°–Ω–∞—á–∞–ª–∞ –Ω–∞–π–¥—ë–º ID –¥–æ–º–µ–Ω–∞ –∏–ª–∏ –ø—Ä—è–º—É—é —Å—Å—ã–ª–∫—É
              await page.goto('https://hosting.timeweb.ru/domains');
              await page.waitForTimeout(3000);
              
              // –ò—â–µ–º artvision.pro –≤ —Ç–∞–±–ª–∏—Ü–µ –∏ –∫–ª–∏–∫–∞–µ–º
              const rows = await page.$$('tr');
              for (const row of rows) {
                const text = await row.textContent();
                if (text && text.includes('artvision.pro')) {
                  console.log('‚úÖ –ù–∞—à—ë–ª —Å—Ç—Ä–æ–∫—É —Å artvision.pro');
                  
                  // –ò—â–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –¥–æ–º–µ–Ω
                  const link = await row.$('a');
                  if (link) {
                    const href = await link.getAttribute('href');
                    console.log('–°—Å—ã–ª–∫–∞:', href);
                    await link.click();
                    break;
                  }
                }
              }
              
              await page.waitForTimeout(3000);
              await page.screenshot({ path: '01_domain_page.png', fullPage: true });
              console.log('URL –¥–æ–º–µ–Ω–∞:', page.url());
              
              // –ò—â–µ–º –≤–∫–ª–∞–¥–∫—É –∏–ª–∏ —Å—Å—ã–ª–∫—É DNS
              console.log('üîç –ò—â—É DNS...');
              
              // –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ —Å—Å—ã–ª–∫—É/–∫–Ω–æ–ø–∫—É DNS
              const dnsLink = await page.$('a:has-text("DNS"), button:has-text("DNS"), [href*="dns"]');
              if (dnsLink) {
                await dnsLink.click();
                await page.waitForTimeout(2000);
                await page.screenshot({ path: '02_dns_page.png', fullPage: true });
              } else {
                // –ü—Ä–æ–±—É–µ–º –¥—Ä—É–≥–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã
                const tabs = await page.$$('a, button');
                for (const tab of tabs) {
                  const text = await tab.textContent();
                  if (text && text.toLowerCase().includes('dns')) {
                    console.log('–ù–∞—à—ë–ª DNS —Ç–∞–±:', text);
                    await tab.click();
                    await page.waitForTimeout(2000);
                    break;
                  }
                }
                await page.screenshot({ path: '02_dns_page.png', fullPage: true });
              }
              
              console.log('URL DNS:', page.url());
              
              // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ —É–∂–µ –∑–∞–ø–∏—Å—å portal
              const content = await page.content();
              if (content.includes('portal')) {
                console.log('‚ö†Ô∏è –ó–∞–ø–∏—Å—å portal —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!');
              }
              
              // –ò—â–µ–º –∫–Ω–æ–ø–∫—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏
              console.log('‚ûï –ò—â—É –∫–Ω–æ–ø–∫—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è...');
              const addBtn = await page.$('button:has-text("–î–æ–±–∞–≤–∏—Ç—å"), a:has-text("–î–æ–±–∞–≤–∏—Ç—å"), button:has-text("Add")');
              
              if (addBtn) {
                await addBtn.click();
                await page.waitForTimeout(2000);
                await page.screenshot({ path: '03_add_form.png', fullPage: true });
                
                // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ñ–æ—Ä–º—É
                const formInputs = await page.$$eval('input, select', els => els.map(e => ({
                  name: e.name,
                  id: e.id,
                  type: e.type || e.tagName,
                  placeholder: e.placeholder
                })));
                console.log('–§–æ—Ä–º–∞:', JSON.stringify(formInputs, null, 2));
                
                // –ü—Ä–æ–±—É–µ–º –≤—ã–±—Ä–∞—Ç—å CNAME
                const typeSelect = await page.$('select[name*="type"], select');
                if (typeSelect) {
                  await typeSelect.selectOption({ label: 'CNAME' });
                  await page.waitForTimeout(500);
                }
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è
                // –ò–º—è –∑–∞–ø–∏—Å–∏ = portal
                const nameInput = await page.$('input[name*="name"], input[name*="subdomain"], input[placeholder*="–∏–º—è"], input[placeholder*="name"]');
                if (nameInput) {
                  await nameInput.fill('portal');
                }
                
                // –ó–Ω–∞—á–µ–Ω–∏–µ = cname.vercel-dns.com
                const valueInput = await page.$('input[name*="value"], input[name*="target"], input[name*="content"]');
                if (valueInput) {
                  await valueInput.fill('cname.vercel-dns.com');
                }
                
                await page.screenshot({ path: '04_filled_form.png', fullPage: true });
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º
                const saveBtn = await page.$('button:has-text("–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"), button:has-text("–î–æ–±–∞–≤–∏—Ç—å"), button[type="submit"]');
                if (saveBtn) {
                  console.log('üíæ –°–æ—Ö—Ä–∞–Ω—è—é –∑–∞–ø–∏—Å—å...');
                  await saveBtn.click();
                  await page.waitForTimeout(3000);
                  await page.screenshot({ path: '05_result.png', fullPage: true });
                  console.log('‚úÖ –ó–∞–ø–∏—Å—å –¥–æ–±–∞–≤–ª–µ–Ω–∞!');
                }
              } else {
                console.log('‚ùå –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                
                // –í—ã–≤–æ–¥–∏–º –≤—Å–µ –∫–Ω–æ–ø–∫–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
                const allButtons = await page.$$eval('button, a.btn', els => els.map(e => e.textContent?.trim()));
                console.log('–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–Ω–æ–ø–∫–∏:', allButtons);
              }
              
            } catch (e) {
              console.error('‚ùå –û—à–∏–±–∫–∞:', e.message);
              await page.screenshot({ path: 'error.png', fullPage: true });
            }
            
            await browser.close();
          })();
          SCRIPT
          
          node setup_dns.js
      
      - name: Upload screenshots
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: screenshots
          path: "*.png"
