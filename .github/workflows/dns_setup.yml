name: Setup DNS

on:
  workflow_dispatch:

jobs:
  setup-dns:
    runs-on: ubuntu-latest
    steps:
      - name: Install Playwright
        run: |
          npm init -y
          npm install playwright
          npx playwright install chromium
      
      - name: Setup DNS in Timeweb
        run: |
          cat > setup_dns.js << 'SCRIPT'
          const { chromium } = require('playwright');

          (async () => {
            const browser = await chromium.launch({ headless: true });
            const page = await browser.newPage();
            
            console.log('üåê –û—Ç–∫—Ä—ã–≤–∞—é Timeweb...');
            await page.goto('https://hosting.timeweb.ru/login');
            await page.waitForLoadState('networkidle');
            
            console.log('üîë –õ–æ–≥–∏–Ω—é—Å—å...');
            await page.fill('input[name="login"]', 'cp02586');
            await page.fill('input[name="password"]', '6CNgRdxX222');
            await page.click('button[type="submit"]');
            
            await page.waitForLoadState('networkidle');
            await page.waitForTimeout(3000);
            
            console.log('URL –ø–æ—Å–ª–µ –ª–æ–≥–∏–Ω–∞:', page.url());
            await page.screenshot({ path: 'step1_after_login.png' });
            
            // –ò—â–µ–º —Ä–∞–∑–¥–µ–ª –¥–æ–º–µ–Ω–æ–≤
            console.log('üîç –ò—â—É —Ä–∞–∑–¥–µ–ª –¥–æ–º–µ–Ω–æ–≤...');
            
            // –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
            const domainLinks = await page.$$('a[href*="domain"], a:has-text("–î–æ–º–µ–Ω—ã"), a:has-text("–¥–æ–º–µ–Ω")');
            console.log('–ù–∞–π–¥–µ–Ω–æ —Å—Å—ã–ª–æ–∫ –Ω–∞ –¥–æ–º–µ–Ω—ã:', domainLinks.length);
            
            if (domainLinks.length > 0) {
              await domainLinks[0].click();
              await page.waitForLoadState('networkidle');
              await page.waitForTimeout(2000);
            } else {
              // –ü—Ä–æ–±—É–µ–º –ø—Ä—è–º–æ–π URL
              await page.goto('https://hosting.timeweb.ru/domains');
              await page.waitForLoadState('networkidle');
            }
            
            await page.screenshot({ path: 'step2_domains.png' });
            console.log('URL –¥–æ–º–µ–Ω–æ–≤:', page.url());
            
            // –ò—â–µ–º artvision.pro
            console.log('üîç –ò—â—É artvision.pro...');
            const content = await page.content();
            
            if (content.includes('artvision.pro')) {
              console.log('‚úÖ –ù–∞—à—ë–ª artvision.pro!');
              
              // –ö–ª–∏–∫–∞–µ–º –Ω–∞ –¥–æ–º–µ–Ω
              const domainLink = await page.$('a:has-text("artvision.pro"), tr:has-text("artvision.pro") a');
              if (domainLink) {
                await domainLink.click();
                await page.waitForLoadState('networkidle');
                await page.waitForTimeout(2000);
              }
              
              await page.screenshot({ path: 'step3_domain_page.png' });
              
              // –ò—â–µ–º DNS –∑–∞–ø–∏—Å–∏
              const dnsLink = await page.$('a:has-text("DNS"), a[href*="dns"], button:has-text("DNS")');
              if (dnsLink) {
                console.log('üîç –û—Ç–∫—Ä—ã–≤–∞—é DNS...');
                await dnsLink.click();
                await page.waitForLoadState('networkidle');
                await page.waitForTimeout(2000);
              }
              
              await page.screenshot({ path: 'step4_dns.png' });
              
              // –ü—Ä–æ–±—É–µ–º –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å
              const addButton = await page.$('button:has-text("–î–æ–±–∞–≤–∏—Ç—å"), a:has-text("–î–æ–±–∞–≤–∏—Ç—å"), button:has-text("Add")');
              if (addButton) {
                console.log('‚ûï –î–æ–±–∞–≤–ª—è—é –∑–∞–ø–∏—Å—å...');
                await addButton.click();
                await page.waitForTimeout(1000);
                await page.screenshot({ path: 'step5_add_form.png' });
              }
              
            } else {
              console.log('‚ùå artvision.pro –Ω–µ –Ω–∞–π–¥–µ–Ω –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ');
              console.log('–°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–ø–µ—Ä–≤—ã–µ 2000 —Å–∏–º–≤–æ–ª–æ–≤):');
              console.log(content.substring(0, 2000));
            }
            
            await browser.close();
            console.log('‚úÖ –ì–æ—Ç–æ–≤–æ!');
          })();
          SCRIPT
          
          node setup_dns.js
      
      - name: Upload screenshots
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: screenshots
          path: "*.png"
