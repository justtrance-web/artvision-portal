name: Setup DNS

on:
  workflow_dispatch:

jobs:
  setup-dns:
    runs-on: ubuntu-latest
    steps:
      - name: Install Playwright
        run: |
          npm init -y
          npm install playwright
          npx playwright install chromium
      
      - name: Analyze and Add CNAME
        run: |
          cat > setup_dns.js << 'SCRIPT'
          const { chromium } = require('playwright');

          (async () => {
            const browser = await chromium.launch({ headless: true });
            const page = await browser.newPage();
            
            try {
              console.log('üåê –õ–æ–≥–∏–Ω—é—Å—å...');
              await page.goto('https://hosting.timeweb.ru/login');
              await page.waitForTimeout(2000);
              await page.fill('input[name="username"]', 'cp02586');
              await page.fill('input[name="password"]', '6CNgRdxX222');
              await page.click('button[type="submit"]');
              await page.waitForTimeout(5000);
              console.log('‚úÖ –í–æ—à–ª–∏');
              
              console.log('üîç –û—Ç–∫—Ä—ã–≤–∞—é DNS...');
              await page.goto('https://hosting.timeweb.ru/domains/settings/dns-editor?fqdn=artvision.pro');
              await page.waitForTimeout(4000);
              
              // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø–æ–ø–∞–ø—ã
              await page.evaluate(() => {
                document.querySelectorAll('[class*="nps"], [class*="survey"]').forEach(el => el.remove());
              });
              for (let i = 0; i < 3; i++) {
                await page.keyboard.press('Escape');
                await page.waitForTimeout(300);
              }
              try { await page.click('button:has-text("–ó–∞–∫—Ä—ã—Ç—å")', { timeout: 1000 }); } catch {}
              
              // –ü—Ä–æ–≤–µ—Ä—è–µ–º portal
              const html = await page.content();
              if (html.includes('portal.artvision.pro')) {
                console.log('‚ö†Ô∏è –ó–∞–ø–∏—Å—å portal –£–ñ–ï –ï–°–¢–¨!');
                await browser.close();
                return;
              }
              
              // –ù–∞–∂–∏–º–∞–µ–º "–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å"
              console.log('‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å...');
              await page.click('button:has-text("–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å")');
              await page.waitForTimeout(3000);
              
              await page.screenshot({ path: '01_modal.png', fullPage: true });
              
              // –ê–ù–ê–õ–ò–ó–ò–†–£–ï–ú —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ñ–æ—Ä–º—ã
              console.log('üìä –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é —Ñ–æ—Ä–º—É...');
              const formInfo = await page.evaluate(() => {
                const result = {
                  selects: [],
                  inputs: [],
                  buttons: []
                };
                
                // –ù–∞–π–¥—ë–º –≤—Å–µ select
                document.querySelectorAll('select').forEach((s, i) => {
                  result.selects.push({
                    index: i,
                    name: s.name,
                    className: s.className,
                    options: Array.from(s.options).map(o => o.value),
                    visible: s.offsetParent !== null
                  });
                });
                
                // –ù–∞–π–¥—ë–º –≤—Å–µ input
                document.querySelectorAll('input').forEach((inp, i) => {
                  if (inp.type !== 'hidden') {
                    result.inputs.push({
                      index: i,
                      type: inp.type,
                      name: inp.name,
                      placeholder: inp.placeholder,
                      visible: inp.offsetParent !== null
                    });
                  }
                });
                
                // –ù–∞–π–¥—ë–º –∫–Ω–æ–ø–∫–∏
                document.querySelectorAll('button').forEach((btn, i) => {
                  result.buttons.push({
                    index: i,
                    text: btn.textContent?.trim().substring(0, 30),
                    visible: btn.offsetParent !== null
                  });
                });
                
                return result;
              });
              
              console.log('Selects:', JSON.stringify(formInfo.selects, null, 2));
              console.log('Inputs:', JSON.stringify(formInfo.inputs.slice(0, 10), null, 2));
              console.log('Buttons:', JSON.stringify(formInfo.buttons.filter(b => b.text?.includes('–°–æ—Ö—Ä–∞–Ω') || b.text?.includes('–î–æ–±–∞–≤')), null, 2));
              
              // –í—ã–±–∏—Ä–∞–µ–º CNAME —á–µ—Ä–µ–∑ JS –Ω–∞–ø—Ä—è–º—É—é
              console.log('üìù –í—ã–±–∏—Ä–∞—é CNAME —á–µ—Ä–µ–∑ JS...');
              await page.evaluate(() => {
                const selects = document.querySelectorAll('select');
                for (const select of selects) {
                  if (select.offsetParent !== null) { // visible
                    select.value = 'CNAME';
                    select.dispatchEvent(new Event('change', { bubbles: true }));
                    console.log('Changed select to CNAME');
                    break;
                  }
                }
              });
              
              await page.waitForTimeout(1000);
              await page.screenshot({ path: '02_cname.png', fullPage: true });
              
              // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è —á–µ—Ä–µ–∑ JS
              console.log('üìù –ó–∞–ø–æ–ª–Ω—è—é –ø–æ–ª—è...');
              await page.evaluate(() => {
                const inputs = document.querySelectorAll('input[type="text"]');
                let filled = 0;
                for (const input of inputs) {
                  if (input.offsetParent !== null && !input.value) {
                    if (filled === 0) {
                      input.value = 'portal';
                      input.dispatchEvent(new Event('input', { bubbles: true }));
                      filled++;
                    } else if (filled === 1) {
                      input.value = 'cname.vercel-dns.com';
                      input.dispatchEvent(new Event('input', { bubbles: true }));
                      break;
                    }
                  }
                }
              });
              
              await page.waitForTimeout(500);
              await page.screenshot({ path: '03_filled.png', fullPage: true });
              
              // –°–æ—Ö—Ä–∞–Ω—è–µ–º
              console.log('üíæ –°–æ—Ö—Ä–∞–Ω—è—é...');
              await page.evaluate(() => {
                const btns = document.querySelectorAll('button');
                for (const btn of btns) {
                  if (btn.textContent?.includes('–°–æ—Ö—Ä–∞–Ω–∏—Ç—å') && btn.offsetParent !== null) {
                    btn.click();
                    break;
                  }
                }
              });
              
              await page.waitForTimeout(4000);
              await page.screenshot({ path: '04_result.png', fullPage: true });
              
              const result = await page.content();
              if (result.includes('portal') && !result.includes('–ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å')) {
                console.log('‚úÖ‚úÖ‚úÖ –£–°–ü–ï–•!');
              }
              
            } catch (e) {
              console.error('‚ùå', e.message);
              await page.screenshot({ path: 'error.png', fullPage: true });
            }
            
            await browser.close();
          })();
          SCRIPT
          
          node setup_dns.js
      
      - name: Upload screenshots
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: screenshots
          path: "*.png"
