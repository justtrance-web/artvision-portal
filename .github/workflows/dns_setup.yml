name: Setup DNS

on:
  workflow_dispatch:

jobs:
  setup-dns:
    runs-on: ubuntu-latest
    steps:
      - name: Install Playwright
        run: |
          npm init -y
          npm install playwright
          npx playwright install chromium
      
      - name: Add CNAME record
        run: |
          cat > setup_dns.js << 'SCRIPT'
          const { chromium } = require('playwright');

          (async () => {
            const browser = await chromium.launch({ headless: true });
            const page = await browser.newPage();
            
            try {
              // –õ–æ–≥–∏–Ω
              console.log('üåê –û—Ç–∫—Ä—ã–≤–∞—é Timeweb...');
              await page.goto('https://hosting.timeweb.ru/login', { timeout: 60000 });
              await page.waitForTimeout(2000);
              
              console.log('üîë –õ–æ–≥–∏–Ω—é—Å—å...');
              await page.fill('input[name="username"]', 'cp02586');
              await page.fill('input[name="password"]', '6CNgRdxX222');
              await page.click('button[type="submit"]');
              await page.waitForTimeout(5000);
              
              // –ò–¥—ë–º —Å—Ä–∞–∑—É –Ω–∞ DNS —Ä–µ–¥–∞–∫—Ç–æ—Ä
              console.log('üîç –û—Ç–∫—Ä—ã–≤–∞—é DNS artvision.pro...');
              await page.goto('https://hosting.timeweb.ru/domains/settings/dns-editor?fqdn=artvision.pro');
              await page.waitForTimeout(3000);
              await page.screenshot({ path: '01_dns_page.png', fullPage: true });
              
              // –ó–∞–∫—Ä—ã–≤–∞–µ–º popup –µ—Å–ª–∏ –µ—Å—Ç—å
              const closeBtn = await page.$('button:has-text("–ó–∞–∫—Ä—ã—Ç—å")');
              if (closeBtn) {
                await closeBtn.click();
                await page.waitForTimeout(500);
              }
              
              // –ö–ª–∏–∫–∞–µ–º "+ –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å"
              console.log('‚ûï –ö–ª–∏–∫–∞—é –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å...');
              await page.click('text=–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å');
              await page.waitForTimeout(2000);
              await page.screenshot({ path: '02_form_opened.png', fullPage: true });
              
              // –í—ã–±–∏—Ä–∞–µ–º —Ç–∏–ø CNAME
              console.log('üìù –í—ã–±–∏—Ä–∞—é —Ç–∏–ø CNAME...');
              
              // –ö–ª–∏–∫–∞–µ–º –Ω–∞ dropdown —Ç–∏–ø–∞
              const typeDropdown = await page.$('select, [role="combobox"], .select');
              if (typeDropdown) {
                await typeDropdown.click();
                await page.waitForTimeout(500);
              }
              
              // –ü—Ä–æ–±—É–µ–º –≤—ã–±—Ä–∞—Ç—å CNAME —Ä–∞–∑–Ω—ã–º–∏ —Å–ø–æ—Å–æ–±–∞–º–∏
              // –í–∞—Ä–∏–∞–Ω—Ç 1: select option
              try {
                await page.selectOption('select', 'CNAME');
              } catch (e) {
                console.log('Select –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª, –ø—Ä–æ–±—É—é –∫–ª–∏–∫...');
              }
              
              // –í–∞—Ä–∏–∞–Ω—Ç 2: –∫–ª–∏–∫ –ø–æ –ø—É–Ω–∫—Ç—É
              const cnameOption = await page.$('text=CNAME, option[value="CNAME"]');
              if (cnameOption) {
                await cnameOption.click();
                await page.waitForTimeout(500);
              }
              
              await page.screenshot({ path: '03_type_selected.png', fullPage: true });
              
              // –ó–∞–ø–æ–ª–Ω—è–µ–º –•–æ—Å—Ç = portal
              console.log('üìù –ó–∞–ø–æ–ª–Ω—è—é —Ö–æ—Å—Ç: portal');
              const hostInput = await page.$('input[placeholder*="–•–æ—Å—Ç"], input[name*="host"], input[name*="subdomain"]');
              if (hostInput) {
                await hostInput.fill('portal');
              } else {
                // –ò—â–µ–º –ø–µ—Ä–≤—ã–π input –≤ —Ñ–æ—Ä–º–µ
                const inputs = await page.$$('.modal input, dialog input, form input');
                if (inputs.length > 0) {
                  await inputs[0].fill('portal');
                }
              }
              
              // –ó–∞–ø–æ–ª–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ = cname.vercel-dns.com
              console.log('üìù –ó–∞–ø–æ–ª–Ω—è—é –∑–Ω–∞—á–µ–Ω–∏–µ: cname.vercel-dns.com');
              const valueInput = await page.$('input[placeholder*="–ó–Ω–∞—á–µ–Ω–∏–µ"], input[name*="value"], input[name*="target"], input[name*="content"]');
              if (valueInput) {
                await valueInput.fill('cname.vercel-dns.com');
              } else {
                const inputs = await page.$$('.modal input, dialog input, form input');
                if (inputs.length > 1) {
                  await inputs[1].fill('cname.vercel-dns.com');
                }
              }
              
              await page.screenshot({ path: '04_filled.png', fullPage: true });
              
              // –°–æ—Ö—Ä–∞–Ω—è–µ–º
              console.log('üíæ –°–æ—Ö—Ä–∞–Ω—è—é...');
              await page.click('button:has-text("–°–æ—Ö—Ä–∞–Ω–∏—Ç—å")');
              await page.waitForTimeout(3000);
              await page.screenshot({ path: '05_saved.png', fullPage: true });
              
              // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
              const pageContent = await page.content();
              if (pageContent.includes('portal')) {
                console.log('‚úÖ –ó–∞–ø–∏—Å—å portal –Ω–∞–π–¥–µ–Ω–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ!');
              } else {
                console.log('‚ö†Ô∏è –ó–∞–ø–∏—Å—å portal –Ω–µ –≤–∏–¥–Ω–∞, –ø—Ä–æ–≤–µ—Ä—å —Å–∫—Ä–∏–Ω—à–æ—Ç');
              }
              
              console.log('‚úÖ –ì–æ—Ç–æ–≤–æ!');
              
            } catch (e) {
              console.error('‚ùå –û—à–∏–±–∫–∞:', e.message);
              await page.screenshot({ path: 'error.png', fullPage: true });
            }
            
            await browser.close();
          })();
          SCRIPT
          
          node setup_dns.js
      
      - name: Upload screenshots
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: screenshots
          path: "*.png"
