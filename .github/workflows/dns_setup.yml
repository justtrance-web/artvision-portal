name: Setup DNS

on:
  workflow_dispatch:

jobs:
  setup-dns:
    runs-on: ubuntu-latest
    steps:
      - name: Install Playwright
        run: |
          npm init -y
          npm install playwright
          npx playwright install chromium
      
      - name: Add CNAME record
        run: |
          cat > setup_dns.js << 'SCRIPT'
          const { chromium } = require('playwright');

          (async () => {
            const browser = await chromium.launch({ headless: true });
            const page = await browser.newPage();
            
            try {
              // –õ–æ–≥–∏–Ω
              console.log('üåê –õ–æ–≥–∏–Ω—é—Å—å...');
              await page.goto('https://hosting.timeweb.ru/login');
              await page.waitForTimeout(2000);
              await page.fill('input[name="username"]', 'cp02586');
              await page.fill('input[name="password"]', '6CNgRdxX222');
              await page.click('button[type="submit"]');
              await page.waitForTimeout(5000);
              console.log('‚úÖ –í–æ—à–ª–∏');
              
              // DNS —Ä–µ–¥–∞–∫—Ç–æ—Ä
              console.log('üîç –û—Ç–∫—Ä—ã–≤–∞—é DNS...');
              await page.goto('https://hosting.timeweb.ru/domains/settings/dns-editor?fqdn=artvision.pro');
              await page.waitForTimeout(3000);
              
              // –ó–∞–∫—Ä—ã–≤–∞–µ–º –í–°–ï popups
              console.log('üßπ –ó–∞–∫—Ä—ã–≤–∞—é –ø–æ–ø–∞–ø—ã...');
              
              // –ó–∞–∫—Ä—ã—Ç—å NPS –æ–ø—Ä–æ—Å (X –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É)
              await page.evaluate(() => {
                // –£–¥–∞–ª—è–µ–º –≤—Å–µ overlay –∏ backdrop
                document.querySelectorAll('[class*="backdrop"], [class*="overlay"], [class*="modal"]').forEach(el => {
                  if (!el.querySelector('form')) el.remove();
                });
                // –ö–ª–∏–∫–∞–µ–º –≤—Å–µ –∫–Ω–æ–ø–∫–∏ –∑–∞–∫—Ä—ã—Ç–∏—è
                document.querySelectorAll('button:has(svg), [class*="close"]').forEach(btn => {
                  if (btn.closest('[class*="nps"], [class*="survey"], [class*="popup"]')) {
                    btn.click();
                  }
                });
              });
              await page.waitForTimeout(1000);
              
              // –ò—â–µ–º –∏ –∑–∞–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ó–∞–∫—Ä—ã—Ç—å"
              const closeButtons = await page.$$('button:has-text("–ó–∞–∫—Ä—ã—Ç—å"), a:has-text("–ó–∞–∫—Ä—ã—Ç—å")');
              for (const btn of closeButtons) {
                try { await btn.click({ force: true }); } catch {}
              }
              await page.waitForTimeout(500);
              
              // –ó–∞–∫—Ä—ã–≤–∞–µ–º X –Ω–∞ NPS
              const xButtons = await page.$$('[class*="close"], button svg');
              for (const btn of xButtons) {
                try { await btn.click({ force: true }); } catch {}
              }
              await page.waitForTimeout(500);
              
              await page.screenshot({ path: '01_clean.png', fullPage: true });
              
              // –ü—Ä–æ–≤–µ—Ä—è–µ–º portal
              const html = await page.content();
              if (html.includes('portal.artvision.pro')) {
                console.log('‚ö†Ô∏è –ó–∞–ø–∏—Å—å portal —É–∂–µ –µ—Å—Ç—å!');
                await browser.close();
                return;
              }
              
              // –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å —á–µ—Ä–µ–∑ JS - –º–∏–Ω—É—è overlay
              console.log('‚ûï –û—Ç–∫—Ä—ã–≤–∞—é —Ñ–æ—Ä–º—É —á–µ—Ä–µ–∑ JS...');
              await page.evaluate(() => {
                // –ù–∞—Ö–æ–¥–∏–º –∫–Ω–æ–ø–∫—É –∏ –∫–ª–∏–∫–∞–µ–º –Ω–∞–ø—Ä—è–º—É—é
                const addBtn = Array.from(document.querySelectorAll('button')).find(b => b.textContent.includes('–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å'));
                if (addBtn) addBtn.click();
              });
              await page.waitForTimeout(2000);
              
              await page.screenshot({ path: '02_form.png', fullPage: true });
              
              // –í—ã–±–∏—Ä–∞–µ–º CNAME —á–µ—Ä–µ–∑ JS
              console.log('üìù –í—ã–±–∏—Ä–∞—é CNAME...');
              await page.evaluate(() => {
                const select = document.querySelector('select');
                if (select) {
                  select.value = 'CNAME';
                  select.dispatchEvent(new Event('change', { bubbles: true }));
                }
              });
              await page.waitForTimeout(1000);
              
              await page.screenshot({ path: '03_cname_selected.png', fullPage: true });
              
              // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ö–æ—Å—Ç —á–µ—Ä–µ–∑ JS
              console.log('üìù –ó–∞–ø–æ–ª–Ω—è—é portal...');
              await page.evaluate(() => {
                const inputs = document.querySelectorAll('input[type="text"], input:not([type="hidden"])');
                inputs.forEach(input => {
                  const parent = input.closest('div');
                  if (parent && parent.textContent.includes('.artvision.pro')) {
                    input.value = 'portal';
                    input.dispatchEvent(new Event('input', { bubbles: true }));
                  }
                });
              });
              await page.waitForTimeout(500);
              
              // –ó–∞–ø–æ–ª–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ CNAME
              console.log('üìù –ó–∞–ø–æ–ª–Ω—è—é cname.vercel-dns.com...');
              await page.evaluate(() => {
                const inputs = document.querySelectorAll('input');
                let foundHost = false;
                inputs.forEach(input => {
                  if (input.type === 'hidden') return;
                  if (!foundHost && input.value === '') {
                    // –ü–µ—Ä–≤—ã–π –ø—É—Å—Ç–æ–π - —Ö–æ—Å—Ç
                    input.value = 'portal';
                    input.dispatchEvent(new Event('input', { bubbles: true }));
                    foundHost = true;
                  } else if (foundHost && input.value === '') {
                    // –í—Ç–æ—Ä–æ–π –ø—É—Å—Ç–æ–π - –∑–Ω–∞—á–µ–Ω–∏–µ
                    input.value = 'cname.vercel-dns.com';
                    input.dispatchEvent(new Event('input', { bubbles: true }));
                  }
                });
              });
              await page.waitForTimeout(500);
              
              await page.screenshot({ path: '04_filled.png', fullPage: true });
              
              // –°–æ—Ö—Ä–∞–Ω—è–µ–º —á–µ—Ä–µ–∑ JS
              console.log('üíæ –°–æ—Ö—Ä–∞–Ω—è—é...');
              await page.evaluate(() => {
                const saveBtn = Array.from(document.querySelectorAll('button')).find(b => b.textContent.includes('–°–æ—Ö—Ä–∞–Ω–∏—Ç—å'));
                if (saveBtn) saveBtn.click();
              });
              await page.waitForTimeout(3000);
              
              await page.screenshot({ path: '05_result.png', fullPage: true });
              
              // –ü—Ä–æ–≤–µ—Ä—è–µ–º
              const finalHtml = await page.content();
              if (finalHtml.includes('portal')) {
                console.log('‚úÖ –ó–∞–ø–∏—Å—å portal –¥–æ–±–∞–≤–ª–µ–Ω–∞!');
              } else {
                console.log('‚ùì –ü—Ä–æ–≤–µ—Ä—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞ —Å–∫—Ä–∏–Ω—à–æ—Ç–µ');
              }
              
            } catch (e) {
              console.error('‚ùå', e.message);
              await page.screenshot({ path: 'error.png', fullPage: true });
            }
            
            await browser.close();
          })();
          SCRIPT
          
          node setup_dns.js
      
      - name: Upload screenshots
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: screenshots
          path: "*.png"
