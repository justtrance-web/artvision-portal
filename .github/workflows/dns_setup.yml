name: Setup DNS

on:
  workflow_dispatch:

jobs:
  setup-dns:
    runs-on: ubuntu-latest
    steps:
      - name: Install Playwright
        run: |
          npm init -y
          npm install playwright
          npx playwright install chromium
      
      - name: Add CNAME record
        run: |
          cat > setup_dns.js << 'SCRIPT'
          const { chromium } = require('playwright');

          (async () => {
            const browser = await chromium.launch({ headless: true });
            const page = await browser.newPage();
            
            try {
              console.log('üåê Timeweb...');
              await page.goto('https://hosting.timeweb.ru/login', { timeout: 60000 });
              await page.waitForTimeout(2000);
              
              console.log('üîë Login...');
              await page.fill('input[name="username"]', 'cp02586');
              await page.fill('input[name="password"]', '6CNgRdxX222');
              await page.click('button[type="submit"]');
              await page.waitForTimeout(5000);
              
              console.log('üîç DNS...');
              await page.goto('https://hosting.timeweb.ru/domains/settings/dns-editor?fqdn=artvision.pro');
              await page.waitForTimeout(3000);
              
              let content = await page.content();
              if (content.includes('portal.artvision.pro')) {
                console.log('‚úÖ portal –£–ñ–ï –µ—Å—Ç—å!');
                await browser.close();
                return;
              }
              
              console.log('‚ûï –§–æ—Ä–º–∞...');
              await page.click('button:has-text("–î–æ–±–∞–≤–∏—Ç—å")');
              await page.waitForTimeout(2000);
              
              // –û—Ç–∫—Ä—ã–≤–∞–µ–º dropdown
              console.log('üìù Dropdown...');
              await page.evaluate(() => {
                const btn = document.querySelector('[data-test-id="Type-selected-value"]');
                if (btn) btn.parentElement.click();
              });
              await page.waitForTimeout(1000);
              await page.screenshot({ path: '01_dropdown.png', fullPage: true });
              
              // –ö–ª–∏–∫–∞–µ–º –Ω–∞ CNAME - –æ–Ω 4-–π –≤ —Å–ø–∏—Å–∫–µ (A, AAAA, MX, CNAME)
              console.log('üìù CNAME...');
              await page.evaluate(() => {
                // –ò—â–µ–º —ç–ª–µ–º–µ–Ω—Ç —Å —Ç–æ—á–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º CNAME
                const items = document.querySelectorAll('[class*="option"], [class*="item"], li, div');
                for (const item of items) {
                  if (item.textContent?.trim() === 'CNAME') {
                    item.click();
                    console.log('Clicked CNAME');
                    return true;
                  }
                }
                return false;
              });
              await page.waitForTimeout(1000);
              await page.screenshot({ path: '02_cname.png', fullPage: true });
              
              // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ç–∏–ø –∏–∑–º–µ–Ω–∏–ª—Å—è
              const typeValue = await page.evaluate(() => {
                const hidden = document.querySelector('input[name="Type"]');
                return hidden?.value;
              });
              console.log('Type value:', typeValue);
              
              // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è - —Ç–æ–ª—å–∫–æ text inputs
              console.log('üìù –ü–æ–ª—è...');
              const textInputs = await page.$$('input[type="text"]');
              console.log('Text inputs:', textInputs.length);
              
              // –ü–µ—Ä–≤—ã–π text input - —Ö–æ—Å—Ç
              if (textInputs.length > 0) {
                await textInputs[0].fill('portal');
                console.log('  portal -> input 0');
              }
              
              // –í—Ç–æ—Ä–æ–π text input - target
              if (textInputs.length > 1) {
                await textInputs[1].fill('cname.vercel-dns.com');
                console.log('  cname.vercel-dns.com -> input 1');
              }
              
              await page.screenshot({ path: '03_filled.png', fullPage: true });
              
              // –°–æ—Ö—Ä–∞–Ω—è–µ–º
              console.log('üíæ Save...');
              await page.click('button:has-text("–°–æ—Ö—Ä–∞–Ω–∏—Ç—å")');
              await page.waitForTimeout(3000);
              await page.screenshot({ path: '04_result.png', fullPage: true });
              
              content = await page.content();
              if (content.includes('portal')) {
                console.log('‚úÖ –£–°–ü–ï–•!');
              } else {
                console.log('‚ö†Ô∏è –ü—Ä–æ–≤–µ—Ä—å —Å–∫—Ä–∏–Ω—à–æ—Ç—ã');
              }
              
            } catch (e) {
              console.error('‚ùå:', e.message);
              await page.screenshot({ path: 'error.png', fullPage: true });
            }
            
            await browser.close();
          })();
          SCRIPT
          
          node setup_dns.js
      
      - name: Upload screenshots
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: screenshots
          path: "*.png"
