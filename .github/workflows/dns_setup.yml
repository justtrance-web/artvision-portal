name: Setup DNS

on:
  workflow_dispatch:

jobs:
  setup-dns:
    runs-on: ubuntu-latest
    steps:
      - name: Install Playwright
        run: |
          npm init -y
          npm install playwright
          npx playwright install chromium
      
      - name: Setup DNS in Timeweb
        run: |
          cat > setup_dns.js << 'SCRIPT'
          const { chromium } = require('playwright');

          (async () => {
            const browser = await chromium.launch({ headless: true });
            const page = await browser.newPage();
            
            try {
              console.log('üåê –û—Ç–∫—Ä—ã–≤–∞—é Timeweb...');
              await page.goto('https://hosting.timeweb.ru/login', { timeout: 60000 });
              await page.waitForTimeout(3000);
              
              await page.screenshot({ path: '01_login_page.png', fullPage: true });
              
              // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ñ–æ—Ä–º—É
              const html = await page.content();
              console.log('=== –ê–ù–ê–õ–ò–ó –§–û–†–ú–´ ===');
              
              // –ò—â–µ–º –≤—Å–µ input
              const inputs = await page.$$eval('input', els => els.map(e => ({
                name: e.name,
                id: e.id,
                type: e.type,
                placeholder: e.placeholder
              })));
              console.log('Inputs:', JSON.stringify(inputs, null, 2));
              
              // –ò—â–µ–º –≤—Å–µ –∫–Ω–æ–ø–∫–∏
              const buttons = await page.$$eval('button', els => els.map(e => ({
                text: e.textContent?.trim(),
                type: e.type
              })));
              console.log('Buttons:', JSON.stringify(buttons, null, 2));
              
              // –ü—Ä–æ–±—É–µ–º –∑–∞–ø–æ–ª–Ω–∏—Ç—å —Ñ–æ—Ä–º—É
              console.log('üîë –ó–∞–ø–æ–ª–Ω—è—é —Ñ–æ—Ä–º—É...');
              
              // –ò—â–µ–º –ø–æ–ª–µ –ª–æ–≥–∏–Ω–∞ —Ä–∞–∑–Ω—ã–º–∏ —Å–ø–æ—Å–æ–±–∞–º–∏
              const loginField = await page.$('input[name="login"], input[type="text"], input[placeholder*="–õ–æ–≥–∏–Ω"], input[id*="login"]');
              const passField = await page.$('input[name="password"], input[type="password"]');
              
              if (loginField && passField) {
                await loginField.fill('cp02586');
                await passField.fill('6CNgRdxX222');
                await page.screenshot({ path: '02_filled_form.png' });
                
                console.log('üì§ –û—Ç–ø—Ä–∞–≤–ª—è—é —Ñ–æ—Ä–º—É...');
                
                // –ò—â–µ–º –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏
                const submitBtn = await page.$('button[type="submit"], input[type="submit"], button:has-text("–í–æ–π—Ç–∏")');
                if (submitBtn) {
                  await submitBtn.click();
                } else {
                  await page.keyboard.press('Enter');
                }
                
                await page.waitForTimeout(5000);
                await page.screenshot({ path: '03_after_login.png', fullPage: true });
                
                console.log('URL –ø–æ—Å–ª–µ –ª–æ–≥–∏–Ω–∞:', page.url());
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ø–µ—à–Ω–æ—Å—Ç—å
                if (page.url().includes('login')) {
                  console.log('‚ùå –í—Å—ë –µ—â—ë –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –ª–æ–≥–∏–Ω–∞');
                } else {
                  console.log('‚úÖ –í–æ—à–ª–∏!');
                  
                  // –ò–¥—ë–º –∫ –¥–æ–º–µ–Ω–∞–º
                  await page.goto('https://hosting.timeweb.ru/domains', { timeout: 30000 });
                  await page.waitForTimeout(3000);
                  await page.screenshot({ path: '04_domains.png', fullPage: true });
                  
                  const domainContent = await page.content();
                  if (domainContent.includes('artvision.pro')) {
                    console.log('‚úÖ –ù–∞—à—ë–ª artvision.pro!');
                    
                    // –ö–ª–∏–∫–∞–µ–º –Ω–∞ –¥–æ–º–µ–Ω
                    await page.click('text=artvision.pro');
                    await page.waitForTimeout(2000);
                    await page.screenshot({ path: '05_domain_detail.png', fullPage: true });
                    
                    // –ò—â–µ–º DNS
                    const dnsTab = await page.$('text=DNS, a[href*="dns"]');
                    if (dnsTab) {
                      await dnsTab.click();
                      await page.waitForTimeout(2000);
                      await page.screenshot({ path: '06_dns.png', fullPage: true });
                      
                      console.log('üìã DNS —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –æ—Ç–∫—Ä—ã—Ç–∞');
                      
                      // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–ø–∏—Å—å
                      const addBtn = await page.$('text=–î–æ–±–∞–≤–∏—Ç—å, button:has-text("–î–æ–±–∞–≤–∏—Ç—å")');
                      if (addBtn) {
                        await addBtn.click();
                        await page.waitForTimeout(1000);
                        await page.screenshot({ path: '07_add_form.png', fullPage: true });
                        
                        // –ó–∞–ø–æ–ª–Ω—è–µ–º CNAME
                        // –ù—É–∂–Ω–æ –ø–æ–Ω—è—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ñ–æ—Ä–º—ã
                      }
                    }
                  } else {
                    console.log('‚ùå artvision.pro –Ω–µ –Ω–∞–π–¥–µ–Ω');
                    console.log('–ö–æ–Ω—Ç–µ–Ω—Ç:', domainContent.substring(0, 3000));
                  }
                }
              } else {
                console.log('‚ùå –ü–æ–ª—è —Ñ–æ—Ä–º—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
                console.log('HTML:', html.substring(0, 5000));
              }
              
            } catch (e) {
              console.error('–û—à–∏–±–∫–∞:', e.message);
              await page.screenshot({ path: 'error.png', fullPage: true });
            }
            
            await browser.close();
          })();
          SCRIPT
          
          node setup_dns.js
      
      - name: Upload screenshots
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: screenshots
          path: "*.png"
