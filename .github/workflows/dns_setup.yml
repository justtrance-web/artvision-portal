name: Setup DNS

on:
  workflow_dispatch:

jobs:
  setup-dns:
    runs-on: ubuntu-latest
    steps:
      - name: Install Playwright
        run: |
          npm init -y
          npm install playwright
          npx playwright install chromium
      
      - name: Add CNAME record
        run: |
          cat > setup_dns.js << 'SCRIPT'
          const { chromium } = require('playwright');

          (async () => {
            const browser = await chromium.launch({ headless: true });
            const page = await browser.newPage();
            
            try {
              console.log('üåê –õ–æ–≥–∏–Ω—é—Å—å...');
              await page.goto('https://hosting.timeweb.ru/login');
              await page.waitForTimeout(2000);
              await page.fill('input[name="username"]', 'cp02586');
              await page.fill('input[name="password"]', '6CNgRdxX222');
              await page.click('button[type="submit"]');
              await page.waitForTimeout(5000);
              console.log('‚úÖ –í–æ—à–ª–∏');
              
              console.log('üîç –û—Ç–∫—Ä—ã–≤–∞—é DNS...');
              await page.goto('https://hosting.timeweb.ru/domains/settings/dns-editor?fqdn=artvision.pro');
              await page.waitForTimeout(4000);
              
              // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø–æ–ø–∞–ø—ã —á–µ—Ä–µ–∑ ESC –∏ –∫–ª–∏–∫–∏
              for (let i = 0; i < 3; i++) {
                await page.keyboard.press('Escape');
                await page.waitForTimeout(300);
              }
              
              // –ó–∞–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ó–∞–∫—Ä—ã—Ç—å"
              try {
                await page.click('button:has-text("–ó–∞–∫—Ä—ã—Ç—å")', { timeout: 2000 });
              } catch {}
              
              // –ó–∞–∫—Ä—ã–≤–∞–µ–º NPS (X —Å–ø—Ä–∞–≤–∞)
              try {
                await page.locator('[class*="close"], svg').first().click({ timeout: 1000 });
              } catch {}
              
              await page.waitForTimeout(1000);
              await page.screenshot({ path: '01_clean.png', fullPage: true });
              
              // –ü—Ä–æ–≤–µ—Ä—è–µ–º portal
              const html = await page.content();
              if (html.includes('portal.artvision.pro')) {
                console.log('‚ö†Ô∏è –ó–∞–ø–∏—Å—å portal —É–∂–µ –µ—Å—Ç—å!');
                await browser.close();
                return;
              }
              
              // –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å
              console.log('‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å...');
              await page.click('button:has-text("–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å")', { force: true });
              await page.waitForTimeout(2000);
              
              await page.screenshot({ path: '02_form.png', fullPage: true });
              
              // –ö–ª–∏–∫–∞–µ–º –Ω–∞ dropdown —Å —Ç–∏–ø–æ–º "A"
              console.log('üìù –û—Ç–∫—Ä—ã–≤–∞—é dropdown —Ç–∏–ø–∞...');
              // –ò—â–µ–º —ç–ª–µ–º–µ–Ω—Ç —Å —Ç–µ–∫—Å—Ç–æ–º "A" –≤–Ω—É—Ç—Ä–∏ —Ñ–æ—Ä–º—ã "–ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å"
              await page.click('text=A >> nth=0', { force: true });
              await page.waitForTimeout(1000);
              
              await page.screenshot({ path: '03_dropdown_open.png', fullPage: true });
              
              // –í—ã–±–∏—Ä–∞–µ–º CNAME
              console.log('üìù –í—ã–±–∏—Ä–∞—é CNAME...');
              await page.click('text=CNAME', { force: true });
              await page.waitForTimeout(1000);
              
              await page.screenshot({ path: '04_cname_selected.png', fullPage: true });
              
              // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ö–æ—Å—Ç
              console.log('üìù –í–≤–æ–∂—É portal...');
              // –ü–æ–ª–µ –ø–µ—Ä–µ–¥ .artvision.pro
              const inputs = await page.locator('input:visible').all();
              console.log('–ù–∞–π–¥–µ–Ω–æ inputs:', inputs.length);
              
              // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–µ—Ä–≤–æ–µ –ø—É—Å—Ç–æ–µ –ø–æ–ª–µ (—Ö–æ—Å—Ç)
              for (const input of inputs) {
                const val = await input.inputValue();
                const type = await input.getAttribute('type');
                if (type === 'hidden') continue;
                if (!val || val === '') {
                  await input.fill('portal');
                  console.log('‚úÖ –ó–∞–ø–æ–ª–Ω–∏–ª —Ö–æ—Å—Ç');
                  break;
                }
              }
              
              await page.waitForTimeout(500);
              
              // –ó–∞–ø–æ–ª–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ (–≤—Ç–æ—Ä–æ–µ –ø—É—Å—Ç–æ–µ –ø–æ–ª–µ)
              console.log('üìù –í–≤–æ–∂—É cname.vercel-dns.com...');
              const inputs2 = await page.locator('input:visible').all();
              let filledHost = false;
              for (const input of inputs2) {
                const val = await input.inputValue();
                const type = await input.getAttribute('type');
                if (type === 'hidden') continue;
                
                if (val === 'portal') {
                  filledHost = true;
                  continue;
                }
                if (filledHost && (!val || val === '')) {
                  await input.fill('cname.vercel-dns.com');
                  console.log('‚úÖ –ó–∞–ø–æ–ª–Ω–∏–ª –∑–Ω–∞—á–µ–Ω–∏–µ');
                  break;
                }
              }
              
              await page.screenshot({ path: '05_filled.png', fullPage: true });
              
              // –°–æ—Ö—Ä–∞–Ω—è–µ–º
              console.log('üíæ –°–æ—Ö—Ä–∞–Ω—è—é...');
              await page.click('button:has-text("–°–æ—Ö—Ä–∞–Ω–∏—Ç—å")', { force: true });
              await page.waitForTimeout(4000);
              
              await page.screenshot({ path: '06_result.png', fullPage: true });
              
              // –ü—Ä–æ–≤–µ—Ä—è–µ–º
              const result = await page.content();
              if (result.includes('portal') && !result.includes('–ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å')) {
                console.log('‚úÖ‚úÖ‚úÖ –£–°–ü–ï–•! –ó–∞–ø–∏—Å—å portal –¥–æ–±–∞–≤–ª–µ–Ω–∞!');
              } else {
                console.log('‚ùì –ü—Ä–æ–≤–µ—Ä—å —Å–∫—Ä–∏–Ω—à–æ—Ç');
              }
              
            } catch (e) {
              console.error('‚ùå', e.message);
              await page.screenshot({ path: 'error.png', fullPage: true });
            }
            
            await browser.close();
          })();
          SCRIPT
          
          node setup_dns.js
      
      - name: Upload screenshots
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: screenshots
          path: "*.png"
