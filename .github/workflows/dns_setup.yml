name: Setup DNS

on:
  workflow_dispatch:

jobs:
  setup-dns:
    runs-on: ubuntu-latest
    steps:
      - name: Install Playwright
        run: |
          npm init -y
          npm install playwright
          npx playwright install chromium
      
      - name: Add CNAME record
        run: |
          cat > setup_dns.js << 'SCRIPT'
          const { chromium } = require('playwright');

          (async () => {
            const browser = await chromium.launch({ headless: true });
            const page = await browser.newPage();
            
            try {
              console.log('üåê –õ–æ–≥–∏–Ω—é—Å—å...');
              await page.goto('https://hosting.timeweb.ru/login');
              await page.waitForTimeout(2000);
              await page.fill('input[name="username"]', 'cp02586');
              await page.fill('input[name="password"]', '6CNgRdxX222');
              await page.click('button[type="submit"]');
              await page.waitForTimeout(5000);
              console.log('‚úÖ –í–æ—à–ª–∏');
              
              console.log('üîç –û—Ç–∫—Ä—ã–≤–∞—é DNS —Ä–µ–¥–∞–∫—Ç–æ—Ä...');
              await page.goto('https://hosting.timeweb.ru/domains/settings/dns-editor?fqdn=artvision.pro');
              await page.waitForTimeout(4000);
              
              // –ê–ì–†–ï–°–°–ò–í–ù–û –∑–∞–∫—Ä—ã–≤–∞–µ–º –í–°–ï –ø–æ–ø–∞–ø—ã —á–µ—Ä–µ–∑ JS
              console.log('üßπ –ó–∞–∫—Ä—ã–≤–∞—é –ø–æ–ø–∞–ø—ã...');
              await page.evaluate(() => {
                // –£–¥–∞–ª—è–µ–º NPS survey
                document.querySelectorAll('[class*="nps"], [class*="survey"], [class*="feedback"]').forEach(el => el.remove());
                // –£–¥–∞–ª—è–µ–º –≤—Å–µ backdrop/overlay –∫—Ä–æ–º–µ –º–æ–¥–∞–ª–æ–∫ —Å —Ñ–æ—Ä–º–∞–º–∏
                document.querySelectorAll('[class*="backdrop"], [class*="overlay"]').forEach(el => {
                  if (!el.closest('[class*="modal"]') || !el.querySelector('input')) {
                    el.remove();
                  }
                });
                // –ö–ª–∏–∫–∞–µ–º –≤—Å–µ –∫–Ω–æ–ø–∫–∏ –∑–∞–∫—Ä—ã—Ç–∏—è
                document.querySelectorAll('button').forEach(btn => {
                  const text = btn.textContent?.toLowerCase() || '';
                  if (text.includes('–∑–∞–∫—Ä—ã—Ç—å') || text.includes('close')) {
                    btn.click();
                  }
                });
              });
              await page.waitForTimeout(1000);
              
              // ESC –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö
              for (let i = 0; i < 3; i++) {
                await page.keyboard.press('Escape');
                await page.waitForTimeout(300);
              }
              
              await page.screenshot({ path: '01_clean.png', fullPage: true });
              
              // –ü—Ä–æ–≤–µ—Ä—è–µ–º portal
              const html = await page.content();
              if (html.includes('portal.artvision.pro') || html.match(/portal\s*CNAME/i)) {
                console.log('‚ö†Ô∏è –ó–∞–ø–∏—Å—å portal –£–ñ–ï –ï–°–¢–¨!');
                await browser.close();
                return;
              }
              
              // –ù–∞–∂–∏–º–∞–µ–º "–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å"
              console.log('‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å...');
              await page.evaluate(() => {
                const btn = Array.from(document.querySelectorAll('button')).find(b => 
                  b.textContent?.includes('–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å')
                );
                if (btn) btn.click();
              });
              await page.waitForTimeout(2000);
              
              await page.screenshot({ path: '02_form.png', fullPage: true });
              
              // –í—ã–±–∏—Ä–∞–µ–º CNAME –≤ select/dropdown
              console.log('üìù –í—ã–±–∏—Ä–∞—é CNAME...');
              
              // –ü—Ä–æ–±—É–µ–º —á–µ—Ä–µ–∑ –æ–±—ã—á–Ω—ã–π select
              const selected = await page.evaluate(() => {
                const select = document.querySelector('select');
                if (select) {
                  select.value = 'CNAME';
                  select.dispatchEvent(new Event('change', { bubbles: true }));
                  return true;
                }
                return false;
              });
              
              if (!selected) {
                // –ï—Å–ª–∏ –Ω–µ—Ç select, –∫–ª–∏–∫–∞–µ–º –Ω–∞ dropdown –∏ –≤—ã–±–∏—Ä–∞–µ–º CNAME
                await page.click('[class*="select"], [class*="dropdown"]', { force: true });
                await page.waitForTimeout(500);
                await page.click('text=CNAME', { force: true });
              }
              
              await page.waitForTimeout(1000);
              await page.screenshot({ path: '03_cname.png', fullPage: true });
              
              // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è —á–µ—Ä–µ–∑ JS
              console.log('üìù –ó–∞–ø–æ–ª–Ω—è—é –ø–æ–ª—è...');
              await page.evaluate(() => {
                const inputs = Array.from(document.querySelectorAll('input:not([type="hidden"])'));
                let hostFilled = false;
                
                for (const input of inputs) {
                  if (input.type === 'hidden' || input.value) continue;
                  
                  // –ù–∞—Ö–æ–¥–∏–º –∏–Ω–ø—É—Ç —Ä—è–¥–æ–º —Å .artvision.pro
                  const parent = input.closest('div');
                  const nearby = parent?.textContent || '';
                  
                  if (!hostFilled && (nearby.includes('.artvision.pro') || nearby.includes('–•–æ—Å—Ç'))) {
                    input.value = 'portal';
                    input.dispatchEvent(new Event('input', { bubbles: true }));
                    hostFilled = true;
                    console.log('–ó–∞–ø–æ–ª–Ω–∏–ª —Ö–æ—Å—Ç');
                  } else if (hostFilled && !input.value) {
                    input.value = 'cname.vercel-dns.com';
                    input.dispatchEvent(new Event('input', { bubbles: true }));
                    console.log('–ó–∞–ø–æ–ª–Ω–∏–ª –∑–Ω–∞—á–µ–Ω–∏–µ');
                    break;
                  }
                }
              });
              
              await page.waitForTimeout(500);
              await page.screenshot({ path: '04_filled.png', fullPage: true });
              
              // –°–æ—Ö—Ä–∞–Ω—è–µ–º —á–µ—Ä–µ–∑ JS (–æ–±—Ö–æ–¥–∏–º overlay)
              console.log('üíæ –°–æ—Ö—Ä–∞–Ω—è—é...');
              const saved = await page.evaluate(() => {
                const btn = Array.from(document.querySelectorAll('button')).find(b => 
                  b.textContent?.includes('–°–æ—Ö—Ä–∞–Ω–∏—Ç—å')
                );
                if (btn) {
                  btn.click();
                  return true;
                }
                return false;
              });
              
              if (saved) {
                console.log('‚úÖ –ö–Ω–æ–ø–∫–∞ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞–∂–∞—Ç–∞!');
              } else {
                console.log('‚ùå –ö–Ω–æ–ø–∫–∞ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
              }
              
              await page.waitForTimeout(4000);
              await page.screenshot({ path: '05_result.png', fullPage: true });
              
              // –ü—Ä–æ–≤–µ—Ä—è–µ–º
              const result = await page.content();
              if (result.includes('portal') && !result.includes('–ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å')) {
                console.log('‚úÖ‚úÖ‚úÖ –£–°–ü–ï–•!');
              }
              
            } catch (e) {
              console.error('‚ùå', e.message);
              await page.screenshot({ path: 'error.png', fullPage: true });
            }
            
            await browser.close();
          })();
          SCRIPT
          
          node setup_dns.js
      
      - name: Upload screenshots
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: screenshots
          path: "*.png"
