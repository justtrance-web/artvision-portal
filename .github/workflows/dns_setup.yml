name: Setup DNS

on:
  workflow_dispatch:

jobs:
  setup-dns:
    runs-on: ubuntu-latest
    steps:
      - name: Install Playwright
        run: |
          npm init -y
          npm install playwright
          npx playwright install chromium
      
      - name: Add CNAME record
        run: |
          cat > setup_dns.js << 'SCRIPT'
          const { chromium } = require('playwright');

          (async () => {
            const browser = await chromium.launch({ headless: true });
            const page = await browser.newPage();
            
            try {
              console.log('ğŸŒ Ğ›Ğ¾Ğ³Ğ¸Ğ½ÑÑÑŒ...');
              await page.goto('https://hosting.timeweb.ru/login');
              await page.waitForTimeout(2000);
              await page.fill('input[name="username"]', 'cp02586');
              await page.fill('input[name="password"]', '6CNgRdxX222');
              await page.click('button[type="submit"]');
              await page.waitForTimeout(5000);
              console.log('âœ… Ğ’Ğ¾ÑˆĞ»Ğ¸');
              
              console.log('ğŸ” ĞÑ‚ĞºÑ€Ñ‹Ğ²Ğ°Ñ DNS...');
              await page.goto('https://hosting.timeweb.ru/domains/settings/dns-editor?fqdn=artvision.pro');
              await page.waitForTimeout(4000);
              
              // Ğ—Ğ°ĞºÑ€Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ¿Ğ¾Ğ¿Ğ°Ğ¿Ñ‹ Ñ‡ĞµÑ€ĞµĞ· ESC
              await page.keyboard.press('Escape');
              await page.waitForTimeout(500);
              await page.keyboard.press('Escape');
              await page.waitForTimeout(500);
              
              await page.screenshot({ path: '01_dns_page.png', fullPage: true });
              
              // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ portal
              const html = await page.content();
              if (html.includes('portal.artvision.pro') || html.includes('>portal<')) {
                console.log('âš ï¸ Ğ—Ğ°Ğ¿Ğ¸ÑÑŒ portal ÑƒĞ¶Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚!');
                await browser.close();
                return;
              }
              
              // ĞšĞ»Ğ¸ĞºĞ°ĞµĞ¼ "Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ" Ñ force
              console.log('â• Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ...');
              await page.click('text=Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ', { force: true });
              await page.waitForTimeout(2000);
              
              await page.screenshot({ path: '02_form_open.png', fullPage: true });
              
              // ĞšĞ»Ğ¸ĞºĞ°ĞµĞ¼ Ğ½Ğ° dropdown Ñ‚Ğ¸Ğ¿Ğ° Ğ¸ Ğ²Ñ‹Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ CNAME
              console.log('ğŸ“ Ğ’Ñ‹Ğ±Ğ¸Ñ€Ğ°Ñ CNAME...');
              
              // ĞĞ°Ñ…Ğ¾Ğ´Ğ¸Ğ¼ select
              const selectLocator = page.locator('select').first();
              await selectLocator.selectOption('CNAME');
              await page.waitForTimeout(1000);
              
              await page.screenshot({ path: '03_cname_type.png', fullPage: true });
              
              // Ğ¢ĞµĞ¿ĞµÑ€ÑŒ Ñ„Ğ¾Ñ€Ğ¼Ğ° Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ° Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒÑÑ - Ğ¿Ğ¾Ğ»Ğµ Ğ´Ğ»Ñ Ğ´Ğ¾Ğ¼ĞµĞ½Ğ° Ğ²Ğ¼ĞµÑÑ‚Ğ¾ IP
              // Ğ—Ğ°Ğ¿Ğ¾Ğ»Ğ½ÑĞµĞ¼ Ñ…Ğ¾ÑÑ‚
              console.log('ğŸ“ Ğ’Ğ²Ğ¾Ğ¶Ñƒ portal...');
              
              // ĞŸĞµÑ€Ğ²Ğ¾Ğµ Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ²Ğ¾Ğµ Ğ¿Ğ¾Ğ»Ğµ - Ñ…Ğ¾ÑÑ‚
              const hostInput = page.locator('input[type="text"]').first();
              await hostInput.fill('portal');
              await page.waitForTimeout(500);
              
              // Ğ’Ñ‚Ğ¾Ñ€Ğ¾Ğµ Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ²Ğ¾Ğµ Ğ¿Ğ¾Ğ»Ğµ - Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ (Ğ´Ğ¾Ğ¼ĞµĞ½ Ğ´Ğ»Ñ CNAME)
              console.log('ğŸ“ Ğ’Ğ²Ğ¾Ğ¶Ñƒ cname.vercel-dns.com...');
              const valueInput = page.locator('input[type="text"]').nth(1);
              await valueInput.fill('cname.vercel-dns.com');
              await page.waitForTimeout(500);
              
              await page.screenshot({ path: '04_filled.png', fullPage: true });
              
              // Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼
              console.log('ğŸ’¾ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑÑ...');
              await page.click('button:has-text("Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ")', { force: true });
              await page.waitForTimeout(3000);
              
              await page.screenshot({ path: '05_result.png', fullPage: true });
              
              // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼
              const result = await page.content();
              if (result.includes('portal')) {
                console.log('âœ… Ğ£Ğ¡ĞŸĞ•Ğ¥! Ğ—Ğ°Ğ¿Ğ¸ÑÑŒ portal Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ°!');
              } else {
                console.log('â“ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒ ÑĞºÑ€Ğ¸Ğ½ÑˆĞ¾Ñ‚');
              }
              
            } catch (e) {
              console.error('âŒ', e.message);
              await page.screenshot({ path: 'error.png', fullPage: true });
            }
            
            await browser.close();
          })();
          SCRIPT
          
          node setup_dns.js
      
      - name: Upload screenshots
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: screenshots
          path: "*.png"
