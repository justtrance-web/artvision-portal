name: Setup DNS

on:
  workflow_dispatch:

jobs:
  setup-dns:
    runs-on: ubuntu-latest
    steps:
      - name: Install Playwright
        run: |
          npm init -y
          npm install playwright
          npx playwright install chromium
      
      - name: Add CNAME record
        run: |
          cat > setup_dns.js << 'SCRIPT'
          const { chromium } = require('playwright');

          (async () => {
            const browser = await chromium.launch({ headless: true });
            const page = await browser.newPage();
            
            try {
              console.log('üåê –õ–æ–≥–∏–Ω—é—Å—å...');
              await page.goto('https://hosting.timeweb.ru/login');
              await page.waitForTimeout(2000);
              await page.fill('input[name="username"]', 'cp02586');
              await page.fill('input[name="password"]', '6CNgRdxX222');
              await page.click('button[type="submit"]');
              await page.waitForTimeout(5000);
              console.log('‚úÖ –í–æ—à–ª–∏');
              
              console.log('üîç –û—Ç–∫—Ä—ã–≤–∞—é DNS...');
              await page.goto('https://hosting.timeweb.ru/domains/settings/dns-editor?fqdn=artvision.pro');
              await page.waitForTimeout(4000);
              
              // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø–æ–ø–∞–ø—ã
              console.log('üßπ –ó–∞–∫—Ä—ã–≤–∞—é –ø–æ–ø–∞–ø—ã...');
              await page.evaluate(() => {
                document.querySelectorAll('[class*="nps"], [class*="survey"]').forEach(el => el.remove());
              });
              for (let i = 0; i < 3; i++) {
                await page.keyboard.press('Escape');
                await page.waitForTimeout(300);
              }
              try { await page.click('button:has-text("–ó–∞–∫—Ä—ã—Ç—å")', { timeout: 1000 }); } catch {}
              await page.waitForTimeout(1000);
              
              await page.screenshot({ path: '01_clean.png', fullPage: true });
              
              // –ü—Ä–æ–≤–µ—Ä—è–µ–º portal
              const html = await page.content();
              if (html.includes('portal.artvision.pro')) {
                console.log('‚ö†Ô∏è –ó–∞–ø–∏—Å—å portal –£–ñ–ï –ï–°–¢–¨!');
                await browser.close();
                return;
              }
              
              // –ù–∞–∂–∏–º–∞–µ–º "–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å"
              console.log('‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å...');
              await page.click('button:has-text("–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å")');
              await page.waitForTimeout(2000);
              
              // –ñ–¥—ë–º –ø–æ—è–≤–ª–µ–Ω–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
              await page.waitForSelector('text=–ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å', { timeout: 5000 });
              console.log('‚úÖ –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ—Ç–∫—Ä—ã—Ç–æ');
              
              await page.screenshot({ path: '02_modal.png', fullPage: true });
              
              // –ù–∞—Ö–æ–¥–∏–º select –≤–Ω—É—Ç—Ä–∏ —Ñ–æ—Ä–º—ã –∏ –º–µ–Ω—è–µ–º —Ç–∏–ø –Ω–∞ CNAME
              console.log('üìù –í—ã–±–∏—Ä–∞—é CNAME...');
              
              // –ò—â–µ–º select –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
              const modal = await page.$('[class*="modal"], [role="dialog"]');
              if (modal) {
                const select = await modal.$('select');
                if (select) {
                  await select.selectOption('CNAME');
                  console.log('‚úÖ CNAME –≤—ã–±—Ä–∞–Ω —á–µ—Ä–µ–∑ select');
                } else {
                  // –ï—Å–ª–∏ –Ω–µ—Ç select, –∏—â–µ–º –∫–∞—Å—Ç–æ–º–Ω—ã–π dropdown
                  // –ö–ª–∏–∫–∞–µ–º –Ω–∞ –∫–Ω–æ–ø–∫—É —Å "A" –≤–Ω—É—Ç—Ä–∏ –º–æ–¥–∞–ª–∫–∏
                  const dropdown = await modal.$('button, [class*="select"]');
                  if (dropdown) {
                    await dropdown.click();
                    await page.waitForTimeout(500);
                    // –¢–µ–ø–µ—Ä—å –∫–ª–∏–∫–∞–µ–º –Ω–∞ CNAME –≤ –≤—ã–ø–∞–¥–∞—é—â–µ–º —Å–ø–∏—Å–∫–µ
                    await page.click('[class*="option"]:has-text("CNAME"), [class*="menu"] >> text=CNAME');
                    console.log('‚úÖ CNAME –≤—ã–±—Ä–∞–Ω —á–µ—Ä–µ–∑ dropdown');
                  }
                }
              } else {
                // Fallback - —á–µ—Ä–µ–∑ evaluate
                await page.evaluate(() => {
                  const select = document.querySelector('select');
                  if (select) {
                    select.value = 'CNAME';
                    select.dispatchEvent(new Event('change', { bubbles: true }));
                  }
                });
              }
              
              await page.waitForTimeout(1000);
              await page.screenshot({ path: '03_cname.png', fullPage: true });
              
              // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ö–æ—Å—Ç
              console.log('üìù –ó–∞–ø–æ–ª–Ω—è—é —Ö–æ—Å—Ç: portal');
              // –ü–æ–ª–µ —Ö–æ—Å—Ç–∞ - –ø–µ—Ä–≤—ã–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π input –≤ –º–æ–¥–∞–ª–∫–µ
              const hostInputs = await page.$$('[class*="modal"] input, [role="dialog"] input');
              for (const input of hostInputs) {
                const type = await input.getAttribute('type');
                const value = await input.inputValue();
                if (type !== 'hidden' && !value) {
                  await input.fill('portal');
                  console.log('‚úÖ –•–æ—Å—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω');
                  break;
                }
              }
              
              await page.waitForTimeout(500);
              
              // –ó–∞–ø–æ–ª–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ CNAME
              console.log('üìù –ó–∞–ø–æ–ª–Ω—è—é –∑–Ω–∞—á–µ–Ω–∏–µ: cname.vercel-dns.com');
              const allInputs = await page.$$('[class*="modal"] input, [role="dialog"] input');
              let foundPortal = false;
              for (const input of allInputs) {
                const type = await input.getAttribute('type');
                const value = await input.inputValue();
                if (value === 'portal') {
                  foundPortal = true;
                  continue;
                }
                if (foundPortal && type !== 'hidden' && !value) {
                  await input.fill('cname.vercel-dns.com');
                  console.log('‚úÖ –ó–Ω–∞—á–µ–Ω–∏–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ');
                  break;
                }
              }
              
              await page.screenshot({ path: '04_filled.png', fullPage: true });
              
              // –°–æ—Ö—Ä–∞–Ω—è–µ–º - –∏—â–µ–º –∫–Ω–æ–ø–∫—É –≤–Ω—É—Ç—Ä–∏ –º–æ–¥–∞–ª–∫–∏
              console.log('üíæ –°–æ—Ö—Ä–∞–Ω—è—é...');
              const saveBtn = await page.$('[class*="modal"] button:has-text("–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"), [role="dialog"] button:has-text("–°–æ—Ö—Ä–∞–Ω–∏—Ç—å")');
              if (saveBtn) {
                await saveBtn.click();
                console.log('‚úÖ –ö–Ω–æ–ø–∫–∞ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞–∂–∞—Ç–∞');
              } else {
                console.log('‚ùå –ö–Ω–æ–ø–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –ø—Ä–æ–±—É—é —á–µ—Ä–µ–∑ evaluate');
                await page.evaluate(() => {
                  const btns = document.querySelectorAll('button');
                  for (const btn of btns) {
                    if (btn.textContent?.includes('–°–æ—Ö—Ä–∞–Ω–∏—Ç—å')) {
                      btn.click();
                      break;
                    }
                  }
                });
              }
              
              await page.waitForTimeout(4000);
              await page.screenshot({ path: '05_result.png', fullPage: true });
              
              // –ü—Ä–æ–≤–µ—Ä—è–µ–º
              const result = await page.content();
              if (result.includes('portal') && !result.includes('–ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å')) {
                console.log('‚úÖ‚úÖ‚úÖ –£–°–ü–ï–•! –ó–∞–ø–∏—Å—å portal –¥–æ–±–∞–≤–ª–µ–Ω–∞!');
              }
              
            } catch (e) {
              console.error('‚ùå', e.message);
              await page.screenshot({ path: 'error.png', fullPage: true });
            }
            
            await browser.close();
          })();
          SCRIPT
          
          node setup_dns.js
      
      - name: Upload screenshots
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: screenshots
          path: "*.png"
