name: Setup DNS

on:
  workflow_dispatch:

jobs:
  setup-dns:
    runs-on: ubuntu-latest
    steps:
      - name: Install Playwright
        run: |
          npm init -y
          npm install playwright
          npx playwright install chromium
      
      - name: Add CNAME record
        run: |
          cat > setup_dns.js << 'SCRIPT'
          const { chromium } = require('playwright');

          (async () => {
            const browser = await chromium.launch({ headless: true });
            const page = await browser.newPage();
            
            try {
              console.log('üåê –û—Ç–∫—Ä—ã–≤–∞—é Timeweb...');
              await page.goto('https://hosting.timeweb.ru/login', { timeout: 60000 });
              await page.waitForTimeout(2000);
              
              console.log('üîë –õ–æ–≥–∏–Ω—é—Å—å...');
              await page.fill('input[name="username"]', 'cp02586');
              await page.fill('input[name="password"]', '6CNgRdxX222');
              await page.click('button[type="submit"]');
              await page.waitForTimeout(5000);
              
              console.log('üîç –û—Ç–∫—Ä—ã–≤–∞—é DNS...');
              await page.goto('https://hosting.timeweb.ru/domains/settings/dns-editor?fqdn=artvision.pro');
              await page.waitForTimeout(3000);
              
              // –ü—Ä–æ–≤–µ—Ä—è–µ–º portal
              let content = await page.content();
              if (content.includes('portal.artvision.pro')) {
                console.log('‚úÖ –ó–∞–ø–∏—Å—å portal –£–ñ–ï —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!');
                await page.screenshot({ path: 'already_exists.png', fullPage: true });
                await browser.close();
                return;
              }
              
              console.log('‚ûï –û—Ç–∫—Ä—ã–≤–∞—é —Ñ–æ—Ä–º—É...');
              await page.click('button:has-text("–î–æ–±–∞–≤–∏—Ç—å")');
              await page.waitForTimeout(2000);
              await page.screenshot({ path: '01_form.png', fullPage: true });
              
              // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º HTML –º–æ–¥–∞–ª–∫–∏
              console.log('üîç –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é —Ñ–æ—Ä–º—É...');
              const modalHTML = await page.evaluate(() => {
                const modal = document.querySelector('[class*="modal"], [role="dialog"], .popup, [class*="dialog"]');
                return modal ? modal.innerHTML.substring(0, 3000) : 'Modal not found';
              });
              console.log('Modal HTML:', modalHTML.substring(0, 1000));
              
              // –ò—â–µ–º –≤—Å–µ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –≤ –º–æ–¥–∞–ª–∫–µ
              const elements = await page.evaluate(() => {
                const modal = document.querySelector('[class*="modal"], [role="dialog"]') || document;
                const els = modal.querySelectorAll('select, input, button, [class*="select"], [class*="dropdown"], [role="listbox"], [role="combobox"]');
                return Array.from(els).map(e => ({
                  tag: e.tagName,
                  class: e.className,
                  id: e.id,
                  name: e.name,
                  role: e.role,
                  text: e.textContent?.substring(0, 50)
                }));
              });
              console.log('Elements:', JSON.stringify(elements, null, 2));
              
              // –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ —Ä–µ–∞–ª—å–Ω—ã–π select
              const hasSelect = await page.$('select');
              if (hasSelect) {
                console.log('üìù –ù–∞—à—ë–ª select, –≤—ã–±–∏—Ä–∞—é CNAME...');
                await page.selectOption('select', 'CNAME');
              } else {
                // –ü—Ä–æ–±—É–µ–º –∫–ª–∏–∫–Ω—É—Ç—å –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º
                console.log('üìù –ü—Ä–æ–±—É—é –∫–ª–∏–∫ –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º dropdown...');
                // –í –º–æ–¥–∞–ª–∫–µ dropdown –æ–±—ã—á–Ω–æ —Å–ª–µ–≤–∞ –≤–≤–µ—Ä—Ö—É
                const box = await page.locator('[class*="modal"]').boundingBox();
                if (box) {
                  // –ö–ª–∏–∫–∞–µ–º –ø—Ä–∏–º–µ—Ä–Ω–æ –≥–¥–µ dropdown —Ç–∏–ø–∞
                  await page.mouse.click(box.x + 100, box.y + 120);
                  await page.waitForTimeout(1000);
                  await page.screenshot({ path: '02_dropdown_click.png', fullPage: true });
                  
                  // –ò—â–µ–º CNAME –≤ –ø–æ—è–≤–∏–≤—à–µ–º—Å—è —Å–ø–∏—Å–∫–µ
                  await page.click('text=CNAME', { timeout: 5000 }).catch(() => {
                    console.log('CNAME –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–±—É—é –¥—Ä—É–≥–æ–π —Å–ø–æ—Å–æ–±');
                  });
                }
              }
              
              await page.waitForTimeout(1000);
              await page.screenshot({ path: '03_after_type.png', fullPage: true });
              
              // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è —á–µ—Ä–µ–∑ Tab navigation
              console.log('üìù –ó–∞–ø–æ–ª–Ω—è—é –ø–æ–ª—è...');
              
              // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ input –≤ –º–æ–¥–∞–ª–∫–µ
              const inputs = await page.$$('[class*="modal"] input, [role="dialog"] input');
              console.log('–ù–∞–π–¥–µ–Ω–æ inputs:', inputs.length);
              
              for (let i = 0; i < inputs.length; i++) {
                const placeholder = await inputs[i].getAttribute('placeholder');
                const name = await inputs[i].getAttribute('name');
                const type = await inputs[i].getAttribute('type');
                console.log(`Input ${i}: placeholder="${placeholder}", name="${name}", type="${type}"`);
                
                if (placeholder?.includes('–•–æ—Å—Ç') || name?.includes('host') || name?.includes('name')) {
                  await inputs[i].fill('portal');
                  console.log('  ‚Üí –ó–∞–ø–æ–ª–Ω–∏–ª portal');
                } else if (type !== 'hidden' && !placeholder?.includes('TTL')) {
                  await inputs[i].fill('cname.vercel-dns.com');
                  console.log('  ‚Üí –ó–∞–ø–æ–ª–Ω–∏–ª cname.vercel-dns.com');
                }
              }
              
              await page.screenshot({ path: '04_filled.png', fullPage: true });
              
              // –°–æ—Ö—Ä–∞–Ω—è–µ–º
              console.log('üíæ –°–æ—Ö—Ä–∞–Ω—è—é...');
              await page.click('button:has-text("–°–æ—Ö—Ä–∞–Ω–∏—Ç—å")');
              await page.waitForTimeout(3000);
              await page.screenshot({ path: '05_result.png', fullPage: true });
              
              content = await page.content();
              if (content.includes('portal')) {
                console.log('‚úÖ –£–°–ü–ï–•!');
              }
              
            } catch (e) {
              console.error('‚ùå –û—à–∏–±–∫–∞:', e.message);
              await page.screenshot({ path: 'error.png', fullPage: true });
            }
            
            await browser.close();
          })();
          SCRIPT
          
          node setup_dns.js
      
      - name: Upload screenshots
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: screenshots
          path: "*.png"
