name: Setup DNS

on:
  workflow_dispatch:

jobs:
  setup-dns:
    runs-on: ubuntu-latest
    steps:
      - name: Install Playwright
        run: |
          npm init -y
          npm install playwright
          npx playwright install chromium
      
      - name: Add CNAME record
        run: |
          cat > setup_dns.js << 'SCRIPT'
          const { chromium } = require('playwright');

          (async () => {
            const browser = await chromium.launch({ headless: true });
            const page = await browser.newPage();
            
            try {
              console.log('üåê –õ–æ–≥–∏–Ω—é—Å—å...');
              await page.goto('https://hosting.timeweb.ru/login');
              await page.waitForTimeout(2000);
              await page.fill('input[name="username"]', 'cp02586');
              await page.fill('input[name="password"]', '6CNgRdxX222');
              await page.click('button[type="submit"]');
              await page.waitForTimeout(5000);
              console.log('‚úÖ –í–æ—à–ª–∏');
              
              // –ü–†–Ø–ú–û–ô URL –Ω–∞ DNS —Ä–µ–¥–∞–∫—Ç–æ—Ä
              console.log('üîç –û—Ç–∫—Ä—ã–≤–∞—é DNS —Ä–µ–¥–∞–∫—Ç–æ—Ä...');
              await page.goto('https://hosting.timeweb.ru/domains/settings/dns-editor?fqdn=artvision.pro');
              await page.waitForTimeout(4000);
              
              // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø–æ–ø–∞–ø—ã
              for (let i = 0; i < 5; i++) {
                await page.keyboard.press('Escape');
                await page.waitForTimeout(200);
              }
              try { await page.click('button:has-text("–ó–∞–∫—Ä—ã—Ç—å")', { timeout: 1000 }); } catch {}
              await page.waitForTimeout(1000);
              
              await page.screenshot({ path: '01_dns_editor.png', fullPage: true });
              console.log('URL:', page.url());
              
              // –ü—Ä–æ–≤–µ—Ä—è–µ–º portal
              const html = await page.content();
              if (html.includes('portal.artvision.pro') || html.includes('>portal<') || html.match(/portal\s*<\/td>/)) {
                console.log('‚ö†Ô∏è –ó–∞–ø–∏—Å—å portal –£–ñ–ï –°–£–©–ï–°–¢–í–£–ï–¢!');
                await browser.close();
                return;
              }
              
              // –ù–∞–∂–∏–º–∞–µ–º "–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å"
              console.log('‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å...');
              await page.click('button:has-text("–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å")', { force: true });
              await page.waitForTimeout(2000);
              await page.screenshot({ path: '02_form_opened.png', fullPage: true });
              
              // –ö–ª–∏–∫–∞–µ–º –Ω–∞ dropdown —Ç–∏–ø–∞ (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç "A")
              console.log('üìù –û—Ç–∫—Ä—ã–≤–∞—é dropdown —Ç–∏–ø–∞...');
              // Dropdown –≤–Ω—É—Ç—Ä–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
              const typeButton = await page.$('.modal select, .modal [class*="select"], div[class*="modal"] select');
              if (typeButton) {
                await typeButton.click();
              } else {
                // –ò—â–µ–º –ø–æ —Ç–µ–∫—Å—Ç—É "A" –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
                await page.click('.modal button:has-text("A"), [class*="modal"] button:has-text("A")', { force: true });
              }
              await page.waitForTimeout(500);
              
              // –ï—Å–ª–∏ —ç—Ç–æ –æ–±—ã—á–Ω—ã–π select
              const selectEl = await page.$('select');
              if (selectEl) {
                console.log('üìù –í—ã–±–∏—Ä–∞—é CNAME —á–µ—Ä–µ–∑ select...');
                await selectEl.selectOption('CNAME');
              } else {
                // –ï—Å–ª–∏ —ç—Ç–æ –∫–∞—Å—Ç–æ–º–Ω—ã–π dropdown - –∫–ª–∏–∫–∞–µ–º –Ω–∞ –æ–ø—Ü–∏—é CNAME
                console.log('üìù –í—ã–±–∏—Ä–∞—é CNAME —á–µ—Ä–µ–∑ –∫–ª–∏–∫...');
                await page.click('text=CNAME', { force: true });
              }
              await page.waitForTimeout(1000);
              
              await page.screenshot({ path: '03_cname_selected.png', fullPage: true });
              
              // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ö–æ—Å—Ç - –ø–µ—Ä–≤—ã–π input –≤ –º–æ–¥–∞–ª–∫–µ
              console.log('üìù –ó–∞–ø–æ–ª–Ω—è—é —Ö–æ—Å—Ç: portal');
              const hostInput = await page.$('.modal input[type="text"]:first-of-type, [class*="modal"] input:not([type="hidden"]):first-of-type');
              if (hostInput) {
                await hostInput.fill('portal');
              } else {
                // Fallback - –∑–∞–ø–æ–ª–Ω—è–µ–º —á–µ—Ä–µ–∑ evaluate
                await page.evaluate(() => {
                  const inputs = document.querySelectorAll('input:not([type="hidden"])');
                  for (const input of inputs) {
                    if (!input.value) {
                      input.value = 'portal';
                      input.dispatchEvent(new Event('input', { bubbles: true }));
                      break;
                    }
                  }
                });
              }
              await page.waitForTimeout(500);
              
              // –ó–∞–ø–æ–ª–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ CNAME
              console.log('üìù –ó–∞–ø–æ–ª–Ω—è—é –∑–Ω–∞—á–µ–Ω–∏–µ: cname.vercel-dns.com');
              await page.evaluate(() => {
                const inputs = document.querySelectorAll('input:not([type="hidden"])');
                let foundFirst = false;
                for (const input of inputs) {
                  if (input.value === 'portal') {
                    foundFirst = true;
                    continue;
                  }
                  if (foundFirst && !input.value) {
                    input.value = 'cname.vercel-dns.com';
                    input.dispatchEvent(new Event('input', { bubbles: true }));
                    break;
                  }
                }
              });
              await page.waitForTimeout(500);
              
              await page.screenshot({ path: '04_filled.png', fullPage: true });
              
              // –°–æ—Ö—Ä–∞–Ω—è–µ–º
              console.log('üíæ –°–æ—Ö—Ä–∞–Ω—è—é...');
              await page.click('button:has-text("–°–æ—Ö—Ä–∞–Ω–∏—Ç—å")', { force: true });
              await page.waitForTimeout(4000);
              
              await page.screenshot({ path: '05_result.png', fullPage: true });
              
              // –ü—Ä–æ–≤–µ—Ä—è–µ–º
              const result = await page.content();
              if (result.includes('portal')) {
                console.log('‚úÖ‚úÖ‚úÖ –£–°–ü–ï–•! –ó–∞–ø–∏—Å—å portal –¥–æ–±–∞–≤–ª–µ–Ω–∞!');
              } else {
                console.log('‚ùì –ü—Ä–æ–≤–µ—Ä—å —Å–∫—Ä–∏–Ω—à–æ—Ç 05_result.png');
              }
              
            } catch (e) {
              console.error('‚ùå –û—à–∏–±–∫–∞:', e.message);
              await page.screenshot({ path: 'error.png', fullPage: true });
            }
            
            await browser.close();
          })();
          SCRIPT
          
          node setup_dns.js
      
      - name: Upload screenshots
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: screenshots
          path: "*.png"
