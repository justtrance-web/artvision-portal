name: Setup DNS

on:
  workflow_dispatch:

jobs:
  setup-dns:
    runs-on: ubuntu-latest
    steps:
      - name: Install Playwright
        run: |
          npm init -y
          npm install playwright
          npx playwright install chromium
      
      - name: Add CNAME record
        run: |
          cat > setup_dns.js << 'SCRIPT'
          const { chromium } = require('playwright');

          (async () => {
            const browser = await chromium.launch({ headless: true });
            const page = await browser.newPage();
            
            try {
              console.log('üåê –û—Ç–∫—Ä—ã–≤–∞—é Timeweb...');
              await page.goto('https://hosting.timeweb.ru/login', { timeout: 60000 });
              await page.waitForTimeout(2000);
              
              console.log('üîë –õ–æ–≥–∏–Ω—é—Å—å...');
              await page.fill('input[name="username"]', 'cp02586');
              await page.fill('input[name="password"]', '6CNgRdxX222');
              await page.click('button[type="submit"]');
              await page.waitForTimeout(5000);
              
              console.log('üîç –û—Ç–∫—Ä—ã–≤–∞—é DNS...');
              await page.goto('https://hosting.timeweb.ru/domains/settings/dns-editor?fqdn=artvision.pro');
              await page.waitForTimeout(3000);
              
              // –ó–∞–∫—Ä—ã–≤–∞–µ–º popup
              try {
                await page.click('button:has-text("–ó–∞–∫—Ä—ã—Ç—å")', { timeout: 2000 });
              } catch(e) {}
              
              // –ó–∞–∫—Ä—ã–≤–∞–µ–º NPS –æ–ø—Ä–æ—Å –µ—Å–ª–∏ –µ—Å—Ç—å
              try {
                const closeX = await page.$('.close, [aria-label="close"], button:has-text("√ó")');
                if (closeX) await closeX.click();
              } catch(e) {}
              
              await page.screenshot({ path: '01_dns.png', fullPage: true });
              
              console.log('‚ûï –î–æ–±–∞–≤–ª—è—é –∑–∞–ø–∏—Å—å...');
              await page.click('text=–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å');
              await page.waitForTimeout(2000);
              await page.screenshot({ path: '02_form.png', fullPage: true });
              
              // –ö–ª–∏–∫–∞–µ–º –Ω–∞ dropdown —Ç–∏–ø–∞ (—Ç–∞–º –≥–¥–µ "A")
              console.log('üìù –û—Ç–∫—Ä—ã–≤–∞—é dropdown —Ç–∏–ø–∞...');
              
              // –ù–∞—Ö–æ–¥–∏–º dropdown —Å —Ç–µ–∫—Å—Ç–æ–º "A" –≤ —Ñ–æ—Ä–º–µ
              const typeButton = await page.$('.modal div:has-text("A") >> nth=0');
              if (!typeButton) {
                // –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –ø–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ
                await page.click('.modal >> text=A >> nth=0');
              } else {
                await typeButton.click();
              }
              await page.waitForTimeout(1000);
              await page.screenshot({ path: '03_dropdown.png', fullPage: true });
              
              // –í—ã–±–∏—Ä–∞–µ–º CNAME –∏–∑ —Å–ø–∏—Å–∫–∞
              console.log('üìù –í—ã–±–∏—Ä–∞—é CNAME...');
              await page.click('text=CNAME');
              await page.waitForTimeout(1000);
              await page.screenshot({ path: '04_cname_selected.png', fullPage: true });
              
              // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ö–æ—Å—Ç
              console.log('üìù –ó–∞–ø–æ–ª–Ω—è—é portal...');
              const hostInput = await page.$('input:near(:text("–•–æ—Å—Ç"))');
              if (hostInput) {
                await hostInput.fill('portal');
              } else {
                // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ - –ø–µ—Ä–≤—ã–π –≤–∏–¥–∏–º—ã–π input –≤ –º–æ–¥–∞–ª–∫–µ
                await page.fill('.modal input:visible >> nth=0', 'portal');
              }
              await page.waitForTimeout(500);
              
              // –ó–∞–ø–æ–ª–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ CNAME
              console.log('üìù –ó–∞–ø–æ–ª–Ω—è—é cname.vercel-dns.com...');
              // –ü–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ CNAME –ø–æ—è–≤–∏—Ç—Å—è –ø–æ–ª–µ –¥–ª—è –∑–Ω–∞—á–µ–Ω–∏—è
              const cnameInput = await page.$('input:near(:text("–ó–Ω–∞—á–µ–Ω–∏–µ")), input:near(:text("Target")), input:near(:text("–î–æ–º–µ–Ω"))');
              if (cnameInput) {
                await cnameInput.fill('cname.vercel-dns.com');
              } else {
                // –í—Ç–æ—Ä–æ–π input –≤ –º–æ–¥–∞–ª–∫–µ
                await page.fill('.modal input:visible >> nth=1', 'cname.vercel-dns.com');
              }
              
              await page.screenshot({ path: '05_filled.png', fullPage: true });
              
              // –°–æ—Ö—Ä–∞–Ω—è–µ–º
              console.log('üíæ –°–æ—Ö—Ä–∞–Ω—è—é...');
              await page.click('button:has-text("–°–æ—Ö—Ä–∞–Ω–∏—Ç—å")');
              await page.waitForTimeout(3000);
              await page.screenshot({ path: '06_result.png', fullPage: true });
              
              // –ü—Ä–æ–≤–µ—Ä—è–µ–º
              const content = await page.content();
              if (content.includes('portal')) {
                console.log('‚úÖ –ó–∞–ø–∏—Å—å portal –¥–æ–±–∞–≤–ª–µ–Ω–∞!');
              }
              
            } catch (e) {
              console.error('‚ùå –û—à–∏–±–∫–∞:', e.message);
              await page.screenshot({ path: 'error.png', fullPage: true });
            }
            
            await browser.close();
          })();
          SCRIPT
          
          node setup_dns.js
      
      - name: Upload screenshots
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: screenshots
          path: "*.png"
