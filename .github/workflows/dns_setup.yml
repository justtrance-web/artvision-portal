name: Setup DNS

on:
  workflow_dispatch:

jobs:
  setup-dns:
    runs-on: ubuntu-latest
    steps:
      - name: Install Playwright
        run: |
          npm init -y
          npm install playwright
          npx playwright install chromium
      
      - name: Add CNAME record
        run: |
          cat > setup_dns.js << 'SCRIPT'
          const { chromium } = require('playwright');

          (async () => {
            const browser = await chromium.launch({ headless: true });
            const page = await browser.newPage();
            
            try {
              console.log('üåê –û—Ç–∫—Ä—ã–≤–∞—é Timeweb...');
              await page.goto('https://hosting.timeweb.ru/login', { timeout: 60000 });
              await page.waitForTimeout(2000);
              
              console.log('üîë –õ–æ–≥–∏–Ω—é—Å—å...');
              await page.fill('input[name="username"]', 'cp02586');
              await page.fill('input[name="password"]', '6CNgRdxX222');
              await page.click('button[type="submit"]');
              await page.waitForTimeout(5000);
              
              console.log('üîç –û—Ç–∫—Ä—ã–≤–∞—é DNS...');
              await page.goto('https://hosting.timeweb.ru/domains/settings/dns-editor?fqdn=artvision.pro');
              await page.waitForTimeout(3000);
              
              // –ü—Ä–æ–≤–µ—Ä—è–µ–º portal
              let content = await page.content();
              if (content.includes('portal.artvision.pro')) {
                console.log('‚úÖ –ó–∞–ø–∏—Å—å portal –£–ñ–ï —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!');
                await browser.close();
                return;
              }
              
              console.log('‚ûï –û—Ç–∫—Ä—ã–≤–∞—é —Ñ–æ—Ä–º—É...');
              await page.click('button:has-text("–î–æ–±–∞–≤–∏—Ç—å")');
              await page.waitForTimeout(2000);
              
              // –í—ã–≤–æ–¥–∏–º –≤—Å–µ –∫–Ω–æ–ø–∫–∏ –≤ –¥–∏–∞–ª–æ–≥–µ
              const buttons = await page.evaluate(() => {
                return Array.from(document.querySelectorAll('[class*="dialog"] button')).map(b => ({
                  class: b.className,
                  text: b.textContent?.trim().substring(0, 30),
                  dataTestId: b.getAttribute('data-test-id')
                }));
              });
              console.log('Buttons in dialog:', JSON.stringify(buttons, null, 2));
              
              // –ö–ª–∏–∫–∞–µ–º –Ω–∞ –∫–Ω–æ–ø–∫—É —Å data-test-id –∏–ª–∏ –∫–ª–∞—Å—Å button
              console.log('üìù –ö–ª–∏–∫–∞—é –Ω–∞ dropdown...');
              await page.click('[data-test-id="Type-selected-value"]', { timeout: 5000 }).catch(async () => {
                console.log('  data-test-id –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª, –ø—Ä–æ–±—É—é —Ä–æ–¥–∏—Ç–µ–ª—è...');
                // –ö–ª–∏–∫–∞–µ–º –Ω–∞ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫—É—é –∫–Ω–æ–ø–∫—É
                await page.evaluate(() => {
                  const el = document.querySelector('[data-test-id="Type-selected-value"]');
                  if (el) el.parentElement.click();
                });
              });
              
              await page.waitForTimeout(1000);
              await page.screenshot({ path: '02_dropdown.png', fullPage: true });
              
              // –ò—â–µ–º CNAME –≤ –≤—ã–ø–∞–≤—à–µ–º —Å–ø–∏—Å–∫–µ
              console.log('üìù –ò—â—É CNAME...');
              const options = await page.evaluate(() => {
                return Array.from(document.querySelectorAll('[class*="option"], [role="option"], li')).map(o => ({
                  text: o.textContent?.trim(),
                  class: o.className
                }));
              });
              console.log('Options:', JSON.stringify(options.slice(0, 10), null, 2));
              
              // –ö–ª–∏–∫–∞–µ–º –Ω–∞ CNAME
              await page.evaluate(() => {
                const opts = document.querySelectorAll('[class*="option"], [role="option"], li');
                for (const opt of opts) {
                  if (opt.textContent?.includes('CNAME')) {
                    opt.click();
                    return;
                  }
                }
              });
              
              await page.waitForTimeout(1000);
              await page.screenshot({ path: '03_after_cname.png', fullPage: true });
              
              // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è
              console.log('üìù –ó–∞–ø–æ–ª–Ω—è—é –ø–æ–ª—è...');
              
              // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ text inputs
              const inputs = await page.$$('input[type="text"]:visible, input:not([type="hidden"]):visible');
              console.log('–ù–∞–π–¥–µ–Ω–æ inputs:', inputs.length);
              
              // –ü–µ—Ä–≤—ã–π - —Ö–æ—Å—Ç, –≤—Ç–æ—Ä–æ–π - –∑–Ω–∞—á–µ–Ω–∏–µ
              if (inputs.length >= 2) {
                await inputs[0].fill('portal');
                await inputs[1].fill('cname.vercel-dns.com');
              }
              
              await page.screenshot({ path: '04_filled.png', fullPage: true });
              
              // –°–æ—Ö—Ä–∞–Ω—è–µ–º
              console.log('üíæ –°–æ—Ö—Ä–∞–Ω—è—é...');
              await page.click('button:has-text("–°–æ—Ö—Ä–∞–Ω–∏—Ç—å")');
              await page.waitForTimeout(3000);
              await page.screenshot({ path: '05_result.png', fullPage: true });
              
              content = await page.content();
              if (content.includes('portal')) {
                console.log('‚úÖ –£–°–ü–ï–•!');
              } else {
                console.log('‚ö†Ô∏è –ü—Ä–æ–≤–µ—Ä—å —Å–∫—Ä–∏–Ω—à–æ—Ç—ã');
              }
              
            } catch (e) {
              console.error('‚ùå –û—à–∏–±–∫–∞:', e.message);
              await page.screenshot({ path: 'error.png', fullPage: true });
            }
            
            await browser.close();
          })();
          SCRIPT
          
          node setup_dns.js
      
      - name: Upload screenshots
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: screenshots
          path: "*.png"
