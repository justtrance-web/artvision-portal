name: Railway Deploy Check

on:
  schedule:
    - cron: '*/30 * * * *'  # –ö–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç
  workflow_dispatch:  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫

jobs:
  check-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Check Railway Status
        id: check
        run: |
          RESPONSE=$(curl -s -X POST https://backboard.railway.app/graphql/v2 \
            -H "Authorization: Bearer ${{ secrets.RAILWAY_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{
              "query": "mutation { variableCollectionUpsert(input: { projectId: \"22feb938-3d8e-4ef2-8014-60d770e9020f\", environmentId: \"884b4b73-6051-48a4-a14c-bbfb760d878f\", serviceId: \"2da0c1a7-a6be-41a1-a03d-fc1387b28dcf\", variables: { TELEGRAM_BOT_TOKEN: \"${{ secrets.TELEGRAM_BOT_TOKEN }}\", ASANA_TOKEN: \"${{ secrets.ASANA_TOKEN }}\", ADMIN_IDS: \"161261652\", ASANA_WORKSPACE: \"860693669973770\", ASANA_PROJECT: \"1212305892582815\" } }) }"
            }')
          
          if echo "$RESPONSE" | grep -q "error"; then
            echo "status=blocked" >> $GITHUB_OUTPUT
            echo "‚ùå Still blocked"
          else
            echo "status=ready" >> $GITHUB_OUTPUT
            echo "‚úÖ Deployed!"
          fi

      - name: Notify Telegram
        if: steps.check.outputs.status == 'ready'
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=161261652" \
            -d "text=üöÄ Railway —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω! –ë–æ—Ç –∑–∞–¥–µ–ø–ª–æ–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç."
          
          # –û—Ç–∫–ª—é—á–∞–µ–º workflow –ø–æ—Å–ª–µ —É—Å–ø–µ—Ö–∞
          echo "Deployment complete!"
