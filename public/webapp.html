<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Artvision Portal</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --bg-primary: #1a1a2e;
      --bg-secondary: #16213e;
      --bg-card: rgba(255,255,255,0.05);
      --border: rgba(255,255,255,0.08);
      --text-primary: #ffffff;
      --text-secondary: rgba(255,255,255,0.5);
      --accent: #3b82f6;
      --accent-light: #60a5fa;
      --success: #4ade80;
      --warning: #fbbf24;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      padding: 16px;
      padding-bottom: 100px;
    }
    .hidden { display: none !important; }
    
    /* Loading */
    #loadingOverlay {
      position: fixed;
      inset: 0;
      background: var(--bg-primary);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .spinner {
      width: 48px;
      height: 48px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    /* Header */
    .header {
      text-align: center;
      margin-bottom: 24px;
    }
    .header h1 {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .header p {
      color: var(--text-secondary);
      font-size: 14px;
    }
    
    /* Cards */
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
    }
    .card-title {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }
    .card-value {
      font-size: 32px;
      font-weight: 700;
    }
    
    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 24px;
    }
    .stat-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      text-align: center;
    }
    .stat-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--accent-light);
    }
    .stat-label {
      font-size: 12px;
      color: var(--text-secondary);
      margin-top: 4px;
    }
    
    /* Ideas List */
    .ideas-list {
      margin-top: 24px;
    }
    .idea-item {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
    }
    .idea-title {
      font-weight: 600;
      margin-bottom: 8px;
    }
    .idea-status {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 12px;
      background: var(--bg-secondary);
    }
    .idea-status.pending { background: #fbbf24; color: #000; }
    .idea-status.approved { background: #4ade80; color: #000; }
    .idea-status.done { background: #3b82f6; color: #fff; }
    
    /* Button */
    .btn {
      display: block;
      width: 100%;
      padding: 16px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 16px;
    }
    .btn:active { opacity: 0.8; }
    
    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-secondary);
    }
    .empty-state .icon {
      font-size: 48px;
      margin-bottom: 16px;
    }
  </style>
</head>
<body>
  <!-- Loading -->
  <div id="loadingOverlay">
    <div class="spinner"></div>
    <p style="margin-top: 16px; color: var(--text-secondary)">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
  </div>

  <!-- Main Content -->
  <div id="mainContent" class="hidden">
    <div class="header">
      <h1>üëã –ü—Ä–∏–≤–µ—Ç, <span id="userName">User</span>!</h1>
      <p>Artvision Portal</p>
    </div>
    
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value" id="totalIdeas">0</div>
        <div class="stat-label">–í—Å–µ–≥–æ –∏–¥–µ–π</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="approvedIdeas">0</div>
        <div class="stat-label">–û–¥–æ–±—Ä–µ–Ω–æ</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="pendingIdeas">0</div>
        <div class="stat-label">–ù–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="doneIdeas">0</div>
        <div class="stat-label">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</div>
      </div>
    </div>
    
    <div class="card">
      <div class="card-title">–ú–æ–∏ –∏–¥–µ–∏</div>
      <div id="ideasList"></div>
    </div>
    
    <button class="btn" onclick="proposeIdea()">üí° –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –∏–¥–µ—é</button>
  </div>

  <!-- Auth Screen -->
  <div id="authScreen" class="hidden">
    <div class="empty-state">
      <div class="icon">üîê</div>
      <h2>–í–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ Telegram</h2>
      <p style="margin-top: 8px">–û—Ç–∫—Ä–æ–π—Ç–µ –±–æ—Ç–∞ @avportalbot –∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–û—Ç–∫—Ä—ã—Ç—å –ø–æ—Ä—Ç–∞–ª"</p>
    </div>
  </div>

  <script>
    const SUPABASE_URL = 'https://gjwdlbwznkwjghquhhyz.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdqd2RsYnd6bmt3amdocXVoaHl6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY0NTEzNjksImV4cCI6MjA4MjAyNzM2OX0.pQTxrgsKygh3S83AvVv9Lg0KgebXBwKbD5ID-gsmdDI';
    
    const tg = window.Telegram?.WebApp;
    let currentUser = null;

    async function init() {
      try {
        if (tg && tg.initDataUnsafe?.user) {
          tg.ready();
          tg.expand();
          
          currentUser = tg.initDataUnsafe.user;
          await loadData(currentUser.id, currentUser.first_name);
        } else {
          // Dev mode or not in Telegram
          document.getElementById('loadingOverlay').classList.add('hidden');
          document.getElementById('authScreen').classList.remove('hidden');
        }
      } catch (error) {
        console.error('Init error:', error);
        showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
      }
    }

    async function loadData(telegramId, firstName) {
      try {
        // Fetch ideas stats
        const ideasResponse = await fetch(
          `${SUPABASE_URL}/rest/v1/portal_ideas?select=id,title,status,created_at&author_telegram_id=eq.${telegramId}&order=created_at.desc`,
          {
            headers: {
              'apikey': SUPABASE_KEY,
              'Authorization': `Bearer ${SUPABASE_KEY}`
            }
          }
        );
        
        const ideas = await ideasResponse.json();
        
        // Fetch all stats
        const allIdeasResponse = await fetch(
          `${SUPABASE_URL}/rest/v1/portal_ideas?select=status`,
          {
            headers: {
              'apikey': SUPABASE_KEY,
              'Authorization': `Bearer ${SUPABASE_KEY}`
            }
          }
        );
        
        const allIdeas = await allIdeasResponse.json();
        
        // Update UI
        document.getElementById('userName').textContent = firstName;
        document.getElementById('totalIdeas').textContent = allIdeas.length;
        document.getElementById('pendingIdeas').textContent = allIdeas.filter(i => i.status === 'pending').length;
        document.getElementById('approvedIdeas').textContent = allIdeas.filter(i => i.status === 'approved').length;
        document.getElementById('doneIdeas').textContent = allIdeas.filter(i => i.status === 'done').length;
        
        // Render ideas list
        const ideasList = document.getElementById('ideasList');
        if (ideas.length === 0) {
          ideasList.innerHTML = '<div class="empty-state"><div class="icon">üí°</div><p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∏–¥–µ–π</p></div>';
        } else {
          ideasList.innerHTML = ideas.map(idea => `
            <div class="idea-item">
              <div class="idea-title">${escapeHtml(idea.title)}</div>
              <span class="idea-status ${idea.status}">${getStatusText(idea.status)}</span>
            </div>
          `).join('');
        }
        
        // Show content
        document.getElementById('loadingOverlay').classList.add('hidden');
        document.getElementById('mainContent').classList.remove('hidden');
        
      } catch (error) {
        console.error('Load error:', error);
        showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
      }
    }

    function getStatusText(status) {
      const texts = {
        'pending': '‚è≥ –ù–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏',
        'approved': '‚úÖ –û–¥–æ–±—Ä–µ–Ω–æ',
        'rejected': '‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω–æ',
        'done': 'üéâ –í—ã–ø–æ–ª–Ω–µ–Ω–æ'
      };
      return texts[status] || status;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function proposeIdea() {
      if (tg) {
        tg.close();
        // Bot will handle /idea command
      } else {
        alert('–û—Ç–∫—Ä–æ–π—Ç–µ –±–æ—Ç–∞ @avportalbot –∏ –Ω–∞–ø–∏—à–∏—Ç–µ /idea');
      }
    }

    function showError(msg) {
      document.getElementById('loadingOverlay').innerHTML = `
        <div style="color:#f87171;font-size:48px">‚ö†Ô∏è</div>
        <div style="margin-top:16px">${msg}</div>
        <button onclick="location.reload()" style="margin-top:16px;padding:10px 20px;background:#3b82f6;color:#fff;border:none;border-radius:8px;cursor:pointer">–û–±–Ω–æ–≤–∏—Ç—å</button>
      `;
    }

    // Start
    init();
  </script>
</body>
</html>
