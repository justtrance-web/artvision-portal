<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Artvision Portal</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg-primary: #1a1a2e;
      --bg-secondary: #16213e;
      --bg-card: rgba(255,255,255,0.05);
      --border: rgba(255,255,255,0.08);
      --text-primary: #ffffff;
      --text-secondary: rgba(255,255,255,0.5);
      --accent: #3b82f6;
      --accent-light: #60a5fa;
      --success: #4ade80;
      --warning: #fbbf24;
      --danger: #f87171;
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
      background: linear-gradient(180deg, var(--bg-primary) 0%, var(--bg-secondary) 50%, #0f0f23 100%);
      min-height: 100vh;
      color: var(--text-primary);
      padding-bottom: 160px;
    }

    /* === AUTH SCREEN === */
    .auth-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
      text-align: center;
    }
    .auth-screen.hidden { display: none; }
    .auth-logo { font-size: 64px; margin-bottom: 20px; }
    .auth-title { font-size: 24px; font-weight: 700; margin-bottom: 8px; }
    .auth-subtitle { color: var(--text-secondary); margin-bottom: 32px; }
    .auth-btn {
      background: linear-gradient(90deg, #0088cc 0%, #00a8e8 100%);
      color: #fff;
      border: none;
      padding: 14px 32px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* === MAIN APP === */
    .app { display: none; }
    .app.active { display: block; }

    /* === MODE SWITCHER === */
    .mode-switcher {
      display: flex;
      background: var(--bg-card);
      border-radius: 12px;
      padding: 4px;
      margin: 12px 16px;
      border: 1px solid var(--border);
    }
    .mode-btn {
      flex: 1;
      padding: 10px;
      border: none;
      background: transparent;
      color: var(--text-secondary);
      font-size: 14px;
      font-weight: 600;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .mode-btn.active {
      background: var(--accent);
      color: #fff;
    }
    
    /* === HEADER === */
    .header {
      padding: 16px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      background: rgba(26, 26, 46, 0.95);
      backdrop-filter: blur(20px);
      z-index: 100;
      border-bottom: 1px solid var(--border);
    }
    
    .header-left { display: flex; align-items: center; gap: 14px; flex: 1; min-width: 0; cursor: pointer; }
    
    .avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      font-weight: 600;
      flex-shrink: 0;
    }
    
    .client-info { flex: 1; min-width: 0; }
    .client-name { font-size: 18px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .client-domain { font-size: 14px; color: var(--text-secondary); margin-top: 2px; }
    
    .header-btn {
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      opacity: 0.6;
      background: none;
      border: none;
      color: #fff;
      cursor: pointer;
      border-radius: 12px;
      transition: all 0.2s;
    }
    .header-btn:active { background: var(--bg-card); transform: scale(0.95); }
    .header-btn.loading { animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* === SITE SELECTOR === */
    .site-selector {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.8);
      z-index: 200;
      display: none;
      align-items: flex-end;
    }
    .site-selector.open { display: flex; }
    
    .site-selector-content {
      background: var(--bg-primary);
      width: 100%;
      max-height: 70vh;
      border-radius: 20px 20px 0 0;
      padding: 20px;
      overflow-y: auto;
      animation: slideUp 0.3s ease;
    }
    @keyframes slideUp { from { transform: translateY(100%); } }
    
    .site-selector-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .site-selector-title { font-size: 18px; font-weight: 600; }
    .site-selector-close { background: none; border: none; color: var(--text-secondary); font-size: 24px; cursor: pointer; }
    
    .site-item {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 14px;
      border-radius: 12px;
      cursor: pointer;
      border: 1px solid transparent;
      margin-bottom: 8px;
    }
    .site-item:hover { background: var(--bg-card); }
    .site-item.active { background: var(--bg-card); border-color: var(--accent); }
    
    .site-avatar {
      width: 44px; height: 44px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      font-weight: 600;
    }
    
    .site-info { flex: 1; }
    .site-name { font-size: 16px; font-weight: 600; }
    .site-domain { font-size: 13px; color: var(--text-secondary); }
    .site-services { display: flex; gap: 6px; margin-top: 6px; flex-wrap: wrap; }
    .site-service { font-size: 11px; padding: 2px 8px; background: rgba(59,130,246,0.2); color: var(--accent-light); border-radius: 6px; }

    /* === CONTENT === */
    .content { padding: 0 16px; }
    .page { display: none; }
    .page.active { display: block; animation: fadeIn 0.3s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } }

    /* === STATS === */
    .stats-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 16px 0; }
    
    .stat-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 18px 20px;
    }
    
    .stat-label { font-size: 15px; color: var(--text-secondary); margin-bottom: 8px; }
    .stat-value { font-size: 36px; font-weight: 700; letter-spacing: -1px; }
    
    .stat-change { display: flex; align-items: center; gap: 4px; margin-top: 6px; font-size: 16px; font-weight: 600; }
    .stat-change.up { color: var(--success); }
    .stat-change.down { color: var(--danger); }
    .stat-change svg { width: 14px; height: 14px; }

    /* === POSITION CARD === */
    .position-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 12px;
    }
    
    .position-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
    .position-label { font-size: 15px; color: var(--text-secondary); }
    .position-value { font-size: 42px; font-weight: 700; letter-spacing: -1px; }
    
    .chart-container { height: 120px; margin-top: 16px; }
    .chart-labels { display: flex; justify-content: space-between; margin-top: 8px; }
    .chart-label { text-align: center; font-size: 11px; }
    .chart-label-day { font-weight: 600; color: var(--text-primary); opacity: 0.7; }
    .chart-label-date { margin-top: 2px; color: var(--text-secondary); }

    /* === QUERIES === */
    .queries-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 12px;
    }
    
    .queries-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .queries-title { font-size: 18px; font-weight: 600; }
    .queries-all { font-size: 15px; color: var(--accent-light); text-decoration: none; }
    
    .query-item { display: flex; align-items: center; gap: 14px; padding: 14px 0; border-bottom: 1px solid var(--border); }
    .query-item:last-child { border-bottom: none; padding-bottom: 0; }
    
    .query-position {
      width: 48px; height: 48px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      font-weight: 700;
      flex-shrink: 0;
    }
    .query-position.top3 { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }
    .query-position.top10 { background: rgba(74, 222, 128, 0.15); color: var(--success); }
    .query-position.top20 { background: rgba(96, 165, 250, 0.15); color: var(--accent-light); }
    .query-position.below { background: rgba(248, 113, 113, 0.15); color: var(--danger); }
    
    .query-info { flex: 1; min-width: 0; }
    .query-text { font-size: 16px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .query-stats { font-size: 14px; color: var(--text-secondary); margin-top: 3px; }
    
    .query-change { font-size: 15px; font-weight: 600; display: flex; align-items: center; gap: 2px; }
    .query-change.up { color: var(--success); }
    .query-change.down { color: var(--danger); }
    .query-change.neutral { color: var(--text-secondary); }

    /* === AGENCY DASHBOARD === */
    .agency-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 16px 0; }
    
    .agency-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 16px;
    }
    .agency-card.full { grid-column: span 2; }
    
    .agency-label { font-size: 13px; color: var(--text-secondary); margin-bottom: 6px; }
    .agency-value { font-size: 28px; font-weight: 700; }
    .agency-value.mrr { color: var(--success); }

    .client-list { margin-top: 12px; }
    .client-row {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      margin-bottom: 8px;
      cursor: pointer;
    }
    .client-row:hover { border-color: var(--accent); }
    
    .client-avatar { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: 600; }
    .client-details { flex: 1; }
    .client-row-name { font-size: 15px; font-weight: 600; }
    .client-row-domain { font-size: 12px; color: var(--text-secondary); }
    .client-mrr { font-size: 14px; font-weight: 600; color: var(--success); }

    /* === REPORTS === */
    .report-item {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 16px 20px;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 14px;
    }
    .report-icon { font-size: 32px; }
    .report-info { flex: 1; }
    .report-title { font-size: 16px; font-weight: 600; }
    .report-date { font-size: 13px; color: var(--text-secondary); margin-top: 2px; }
    .report-btn { background: var(--accent); color: #fff; border: none; padding: 8px 16px; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; }

    /* === TIPS === */
    .tip-card {
      background: linear-gradient(135deg, rgba(59,130,246,0.15) 0%, rgba(139,92,246,0.15) 100%);
      border: 1px solid rgba(59,130,246,0.3);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 12px;
    }
    .tip-card.high { background: linear-gradient(135deg, rgba(251,191,36,0.15) 0%, rgba(249,115,22,0.15) 100%); border-color: rgba(251,191,36,0.3); }
    
    .tip-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
    .tip-icon { font-size: 24px; }
    .tip-title { font-size: 16px; font-weight: 600; }
    .tip-text { font-size: 14px; color: var(--text-secondary); line-height: 1.5; }
    .tip-action { margin-top: 12px; background: var(--accent); color: #fff; border: none; padding: 10px 20px; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; width: 100%; }

    /* === TAB BAR === */
    .tab-bar {
      position: fixed;
      bottom: 70px;
      left: 0; right: 0;
      background: rgba(15, 15, 35, 0.98);
      backdrop-filter: blur(20px);
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: space-around;
      padding: 10px 0 12px;
      z-index: 100;
    }
    
    .tab-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      color: var(--text-secondary);
      font-size: 11px;
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px 12px;
      border-radius: 8px;
    }
    .tab-item.active { color: var(--accent-light); }
    .tab-item svg { width: 24px; height: 24px; }

    /* === CTA BUTTON === */
    .cta-wrap {
      position: fixed;
      bottom: 0;
      left: 0; right: 0;
      padding: 12px 16px 24px;
      background: linear-gradient(180deg, transparent 0%, rgba(15, 15, 35, 0.98) 30%);
      z-index: 100;
    }
    
    .cta-btn {
      width: 100%;
      height: 54px;
      border-radius: 14px;
      background: linear-gradient(90deg, #3b82f6 0%, #2563eb 100%);
      border: none;
      color: #fff;
      font-size: 17px;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(59, 130, 246, 0.4);
    }
    .cta-btn:active { transform: scale(0.98); }

    .section-title { font-size: 14px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; margin: 20px 0 12px; }

    /* === LOADING === */
    .loading-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: var(--bg-primary);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 300;
    }
    .loading-overlay.hidden { display: none; }
    .loading-spinner { width: 40px; height: 40px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
    .loading-text { margin-top: 16px; color: var(--text-secondary); }
  </style>
</head>
<body>

  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
    <div class="loading-text">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
  </div>

  <div class="auth-screen hidden" id="authScreen">
    <div class="auth-logo">üöÄ</div>
    <div class="auth-title">Artvision Portal</div>
    <div class="auth-subtitle">–í–æ–π–¥–∏—Ç–µ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–±–∏–Ω–µ—Ç—É</div>
    <button class="auth-btn" onclick="telegramLogin()">
      <svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm4.64 6.8c-.15 1.58-.8 5.42-1.13 7.19-.14.75-.42 1-.68 1.03-.58.05-1.02-.38-1.58-.75-.88-.58-1.38-.94-2.23-1.5-.99-.65-.35-1.01.22-1.59.15-.15 2.71-2.48 2.76-2.69a.2.2 0 00-.05-.18c-.06-.05-.14-.03-.21-.02-.09.02-1.49.95-4.22 2.79-.4.27-.76.41-1.08.4-.36-.01-1.04-.2-1.55-.37-.63-.2-1.12-.31-1.08-.66.02-.18.27-.36.74-.55 2.92-1.27 4.86-2.11 5.83-2.51 2.78-1.16 3.35-1.36 3.73-1.36.08 0 .27.02.39.12.1.08.13.19.14.27-.01.06.01.24 0 .38z"/></svg>
      –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Telegram
    </button>
  </div>

  <div class="app" id="mainApp">
    <div class="mode-switcher" id="modeSwitcher" style="display: none;">
      <button class="mode-btn active" onclick="setMode('agent')" data-mode="agent">üè¢ –ê–≥–µ–Ω—Ç—Å—Ç–≤–æ</button>
      <button class="mode-btn" onclick="setMode('client')" data-mode="client">üë§ –ö–ª–∏–µ–Ω—Ç</button>
    </div>

    <header class="header">
      <div class="header-left" onclick="openSiteSelector()">
        <div class="avatar" id="avatar">–¢</div>
        <div class="client-info">
          <div class="client-name" id="clientName">–¢–≤–æ—Ä–∏–º –°–æ–≤–µ—Ä—à–µ–Ω—Å—Ç–≤–æ</div>
          <div class="client-domain" id="clientDomain">tvorimsovershenstvo.ru ‚ñæ</div>
        </div>
      </div>
      <button class="header-btn" id="refreshBtn" onclick="refresh()">‚Üª</button>
    </header>

    <div class="content">
      <div class="page active" id="page-overview">
        <div class="stats-row">
          <div class="stat-card">
            <div class="stat-label">–ü–æ–∫–∞–∑—ã</div>
            <div class="stat-value" id="statShows">‚Äî</div>
            <div class="stat-change up" id="changeShows"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M18 15l-6-6-6 6"/></svg><span>‚Äî</span></div>
          </div>
          <div class="stat-card">
            <div class="stat-label">–ö–ª–∏–∫–∏</div>
            <div class="stat-value" id="statClicks">‚Äî</div>
            <div class="stat-change up" id="changeClicks"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M18 15l-6-6-6 6"/></svg><span>‚Äî</span></div>
          </div>
        </div>

        <div class="position-card">
          <div class="position-header">
            <div>
              <div class="position-label">–°—Ä–µ–¥–Ω—è—è –ø–æ–∑–∏—Ü–∏—è</div>
              <div class="position-value" id="statPosition">‚Äî</div>
            </div>
            <div class="stat-change up" id="changePosition"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" style="width:14px;height:14px"><path d="M18 15l-6-6-6 6"/></svg><span>‚Äî</span></div>
          </div>
          <div class="chart-container"><canvas id="positionsChart"></canvas></div>
          <div class="chart-labels" id="chartLabels"></div>
        </div>

        <div class="queries-card">
          <div class="queries-header">
            <div class="queries-title">–¢–æ–ø –∑–∞–ø—Ä–æ—Å—ã</div>
            <a href="#" class="queries-all" onclick="setTab('positions'); return false;">–í—Å–µ ‚Üí</a>
          </div>
          <div id="topQueries"></div>
        </div>
      </div>

      <div class="page" id="page-agency">
        <div class="agency-stats">
          <div class="agency-card"><div class="agency-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤</div><div class="agency-value" id="agencyClients">‚Äî</div></div>
          <div class="agency-card"><div class="agency-label">MRR</div><div class="agency-value mrr" id="agencyMRR">‚Äî</div></div>
        </div>
        <div class="section-title">–ö–ª–∏–µ–Ω—Ç—ã</div>
        <div class="client-list" id="clientList"></div>
      </div>

      <div class="page" id="page-positions">
        <div class="section-title">–í—Å–µ –∑–∞–ø—Ä–æ—Å—ã</div>
        <div id="allQueries"></div>
      </div>

      <div class="page" id="page-reports">
        <div class="section-title">SEO –û—Ç—á—ë—Ç—ã</div>
        <div id="reportsList"></div>
      </div>

      <div class="page" id="page-tips">
        <div class="section-title">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</div>
        <div id="tipsList"></div>
      </div>
    </div>

    <div class="site-selector" id="siteSelector" onclick="closeSiteSelector(event)">
      <div class="site-selector-content" onclick="event.stopPropagation()">
        <div class="site-selector-header">
          <div class="site-selector-title">–í—ã–±–µ—Ä–∏—Ç–µ —Å–∞–π—Ç</div>
          <button class="site-selector-close" onclick="closeSiteSelector()">√ó</button>
        </div>
        <div id="siteList"></div>
      </div>
    </div>

    <nav class="tab-bar">
      <button class="tab-item active" onclick="setTab('overview')" data-tab="overview">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v18h18"/><path d="M18 9l-5 5-4-4-3 3"/></svg><span>–û–±–∑–æ—Ä</span>
      </button>
      <button class="tab-item" onclick="setTab('positions')" data-tab="positions">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 17l6-6 4 4 8-8"/><path d="M17 7h4v4"/></svg><span>–ü–æ–∑–∏—Ü–∏–∏</span>
      </button>
      <button class="tab-item" onclick="setTab('reports')" data-tab="reports">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M9 9h6M9 13h6M9 17h4"/></svg><span>–û—Ç—á—ë—Ç—ã</span>
      </button>
      <button class="tab-item" onclick="setTab('tips')" data-tab="tips">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21h6M12 3a6 6 0 0 0-3 11.2V17h6v-2.8A6 6 0 0 0 12 3z"/></svg><span>–°–æ–≤–µ—Ç—ã</span>
      </button>
    </nav>

    <div class="cta-wrap">
      <button class="cta-btn" onclick="openChat()">üí¨ –ù–∞–ø–∏—Å–∞—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä—É</button>
    </div>
  </div>

  <script>
    const CONFIG = {
      botUsername: 'avportalbot',
      supportChat: 'justtrance',
      usersDB: 'https://raw.githubusercontent.com/justtrance-web/artvision-data/main/portal/users.json'
    };

    let STATE = { user: null, mode: 'client', currentSite: null, sites: {}, data: null, chart: null };
    const tg = window.Telegram?.WebApp;

    async function init() {
      if (tg && tg.initDataUnsafe?.user) {
        tg.ready(); tg.expand();
        await loadUserData(tg.initDataUnsafe.user.id, tg.initDataUnsafe.user.username);
      } else {
        document.getElementById('loadingOverlay').classList.add('hidden');
        document.getElementById('authScreen').classList.remove('hidden');
      }
    }

    async function loadUserData(telegramId, username) {
      try {
        const response = await fetch(CONFIG.usersDB);
        const db = await response.json();
        STATE.sites = db.sites;
        
        let user = null;
        for (const agent of db.users.agents) {
          if (agent.telegram_id === telegramId || (agent.telegram_username && agent.telegram_username.toLowerCase() === username?.toLowerCase())) {
            user = { ...agent, isAgent: true }; break;
          }
        }
        if (!user) {
          for (const client of db.users.clients) {
            if (client.telegram_id === telegramId || (client.telegram_username && client.telegram_username.toLowerCase() === username?.toLowerCase())) {
              user = { ...client, isAgent: false }; break;
            }
          }
        }
        if (!user) user = { name: username || '–ì–æ—Å—Ç—å', role: 'guest', isAgent: false, sites: Object.keys(db.sites).slice(0, 1) };
        
        STATE.user = user;
        setupUI();
      } catch (error) {
        console.error('Load error:', error);
        showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
      }
    }

    function setupUI() {
      document.getElementById('loadingOverlay').classList.add('hidden');
      document.getElementById('mainApp').classList.add('active');
      
      if (STATE.user.isAgent) {
        document.getElementById('modeSwitcher').style.display = 'flex';
        STATE.mode = 'agent';
        setMode('agent');
      } else {
        STATE.mode = 'client';
        const sites = STATE.user.sites[0] === '*' ? Object.keys(STATE.sites) : STATE.user.sites;
        if (sites.length > 0) selectSite(sites[0]);
      }
    }

    function setMode(mode) {
      STATE.mode = mode;
      document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.mode === mode));
      if (mode === 'agent') showAgencyDashboard();
      else {
        const sites = Object.keys(STATE.sites).filter(s => STATE.sites[s].status === 'active');
        if (sites.length > 0) selectSite(sites[0]);
        setTab('overview');
      }
    }

    function showAgencyDashboard() {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById('page-agency').classList.add('active');
      
      const activeSites = Object.entries(STATE.sites).filter(([_, s]) => s.status === 'active');
      const totalMRR = activeSites.reduce((sum, [_, s]) => sum + (s.mrr || 0), 0);
      
      document.getElementById('agencyClients').textContent = activeSites.length;
      document.getElementById('agencyMRR').textContent = totalMRR.toLocaleString() + ' ‚ÇΩ';
      
      document.getElementById('clientList').innerHTML = activeSites.map(([domain, site]) => `
        <div class="client-row" onclick="selectSite('${domain}'); setMode('client');">
          <div class="client-avatar" style="background: ${site.color}">${site.name.charAt(0)}</div>
          <div class="client-details">
            <div class="client-row-name">${site.name}</div>
            <div class="client-row-domain">${domain}</div>
          </div>
          <div class="client-mrr">${(site.mrr || 0).toLocaleString()} ‚ÇΩ</div>
        </div>
      `).join('');
    }

    function openSiteSelector() {
      if (!STATE.user.isAgent && STATE.user.sites.length <= 1) return;
      const availableSites = STATE.user.sites[0] === '*' ? Object.keys(STATE.sites) : STATE.user.sites;
      const legend = { 'seo': 'SEO', 'ppc': 'PPC', 'reviews': '–û—Ç–∑—ã–≤—ã', 'maps': '–ö–∞—Ä—Ç—ã', 'seo_tz': '–¢–ó', 'pages': '–°—Ç—Ä–∞–Ω–∏—Ü—ã', 'content': '–ö–æ–Ω—Ç–µ–Ω—Ç' };
      
      document.getElementById('siteList').innerHTML = availableSites.map(domain => {
        const site = STATE.sites[domain];
        if (!site) return '';
        const services = (site.services || []).map(s => `<span class="site-service">${legend[s] || s}</span>`).join('');
        return `
          <div class="site-item ${STATE.currentSite === domain ? 'active' : ''}" onclick="selectSite('${domain}')">
            <div class="site-avatar" style="background: ${site.color}">${site.name.charAt(0)}</div>
            <div class="site-info">
              <div class="site-name">${site.name}</div>
              <div class="site-domain">${domain}</div>
              <div class="site-services">${services}</div>
            </div>
          </div>
        `;
      }).join('');
      
      document.getElementById('siteSelector').classList.add('open');
    }

    function closeSiteSelector(event) {
      if (event && event.target !== event.currentTarget) return;
      document.getElementById('siteSelector').classList.remove('open');
    }

    async function selectSite(domain) {
      STATE.currentSite = domain;
      const site = STATE.sites[domain];
      if (!site) return;
      
      document.getElementById('avatar').textContent = site.name.charAt(0);
      document.getElementById('avatar').style.background = site.color;
      document.getElementById('clientName').textContent = site.name;
      document.getElementById('clientDomain').textContent = domain + (STATE.user.isAgent ? ' ‚ñæ' : '');
      
      closeSiteSelector();
      STATE.data = generateDemoData(site);
      renderOverview();
    }

    function generateDemoData(site) {
      const today = new Date();
      const days = [];
      const dayNames = ['–í—Å', '–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±'];
      
      for (let i = 6; i >= 0; i--) {
        const d = new Date(today); d.setDate(d.getDate() - i);
        days.push({
          dayName: dayNames[d.getDay()],
          date: d.getDate().toString().padStart(2, '0') + '.' + (d.getMonth() + 1).toString().padStart(2, '0'),
          position: Math.round((8 + Math.random() * 6 - i * 0.3) * 10) / 10
        });
      }
      
      return {
        stats: {
          shows: { value: Math.floor(50 + Math.random() * 100), change: Math.floor(10 + Math.random() * 20) },
          clicks: { value: Math.floor(3 + Math.random() * 10), change: Math.floor(5 + Math.random() * 15) },
          position: { value: days[days.length - 1].position, change: Math.floor(5 + Math.random() * 10) }
        },
        positionHistory: days,
        queries: [
          { q: site.name.toLowerCase(), pos: 1.3, shows: 9, clicks: 3, change: 2 },
          { q: site.name.split(' ')[0].toLowerCase() + ' —Å–ø–±', pos: 4.2, shows: 7, clicks: 1, change: 1 },
          { q: '—É—Å–ª—É–≥–∏ ' + site.name.split(' ')[0].toLowerCase(), pos: 8.5, shows: 5, clicks: 0, change: -1 },
          { q: '–∑–∞–∫–∞–∑–∞—Ç—å ' + site.name.split(' ')[0].toLowerCase(), pos: 12.3, shows: 4, clicks: 0, change: 0 },
          { q: site.name.split(' ')[0].toLowerCase() + ' —Ü–µ–Ω–∞', pos: 15.8, shows: 6, clicks: 0, change: -2 },
        ],
        reports: [
          { title: 'SEO –æ—Ç—á—ë—Ç ‚Äî –î–µ–∫–∞–±—Ä—å 2025', date: '28.12.2025', type: 'seo' },
          { title: '–ö–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω Q1 2026', date: '20.12.2025', type: 'plan' },
        ],
        tips: [
          { title: '–î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É —É—Å–ª—É–≥–∏', text: '–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è —Å–µ–º–∞–Ω—Ç–∏–∫–∏', priority: 'high', action: '–°–æ–∑–¥–∞—Ç—å –¢–ó' },
          { title: '–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å Title', text: '–°–æ–∫—Ä–∞—Ç–∏—Ç–µ Title –Ω–∞ –≥–ª–∞–≤–Ω–æ–π –¥–æ 60 —Å–∏–º–≤–æ–ª–æ–≤', priority: 'medium', action: '–ü–æ–¥—Ä–æ–±–Ω–µ–µ' },
        ]
      };
    }

    function renderQueryItem(q) {
      let posClass = q.pos <= 3 ? 'top3' : q.pos <= 10 ? 'top10' : q.pos <= 20 ? 'top20' : 'below';
      let changeClass = q.change > 0 ? 'up' : q.change < 0 ? 'down' : 'neutral';
      let changeIcon = q.change > 0 ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" style="width:12px;height:12px"><path d="M18 15l-6-6-6 6"/></svg>' : q.change < 0 ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" style="width:12px;height:12px"><path d="M6 9l6 6 6-6"/></svg>' : '‚Äî';
      
      return `<div class="query-item"><div class="query-position ${posClass}">${Math.round(q.pos)}</div><div class="query-info"><div class="query-text">${q.q}</div><div class="query-stats">${q.shows} –ø–æ–∫–∞–∑–æ–≤ ¬∑ ${q.clicks} –∫–ª–∏–∫–æ–≤</div></div><div class="query-change ${changeClass}">${changeIcon}${q.change !== 0 ? Math.abs(q.change) : ''}</div></div>`;
    }

    function renderOverview() {
      if (!STATE.data) return;
      const { stats, positionHistory, queries } = STATE.data;
      
      document.getElementById('statShows').textContent = stats.shows.value.toLocaleString();
      document.getElementById('statClicks').textContent = stats.clicks.value.toLocaleString();
      document.getElementById('statPosition').textContent = stats.position.value;
      
      document.querySelector('#changeShows span').textContent = stats.shows.change + '%';
      document.querySelector('#changeClicks span').textContent = stats.clicks.change + '%';
      document.querySelector('#changePosition span').textContent = stats.position.change + '%';
      
      document.getElementById('topQueries').innerHTML = queries.slice(0, 3).map(q => renderQueryItem(q)).join('');
      document.getElementById('chartLabels').innerHTML = positionHistory.map(d => `<div class="chart-label"><div class="chart-label-day">${d.dayName}</div><div class="chart-label-date">${d.date}</div></div>`).join('');
      
      renderPositionsChart();
    }

    function renderPositionsChart() {
      if (!STATE.data) return;
      const ctx = document.getElementById('positionsChart').getContext('2d');
      if (STATE.chart) STATE.chart.destroy();
      
      const positions = STATE.data.positionHistory.map(d => d.position);
      STATE.chart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: STATE.data.positionHistory.map(d => d.dayName),
          datasets: [{ data: positions, backgroundColor: positions.map(p => p <= 10 ? '#4ade80' : p <= 20 ? '#60a5fa' : '#f87171'), borderRadius: 6, barThickness: 28 }]
        },
        options: {
          responsive: true, maintainAspectRatio: false,
          scales: { y: { reverse: true, min: 1, max: 25, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { display: false } }, x: { grid: { display: false }, ticks: { display: false } } },
          plugins: { legend: { display: false }, tooltip: { enabled: true } }
        }
      });
    }

    function renderPositions() { if (STATE.data) document.getElementById('allQueries').innerHTML = STATE.data.queries.map(q => renderQueryItem(q)).join(''); }
    function renderReports() {
      if (!STATE.data) return;
      const icons = { seo: 'üìä', plan: 'üìã', audit: 'üîç' };
      document.getElementById('reportsList').innerHTML = STATE.data.reports.map(r => `<div class="report-item"><div class="report-icon">${icons[r.type] || 'üìÑ'}</div><div class="report-info"><div class="report-title">${r.title}</div><div class="report-date">${r.date}</div></div><button class="report-btn">–û—Ç–∫—Ä—ã—Ç—å</button></div>`).join('');
    }
    function renderTips() {
      if (!STATE.data) return;
      document.getElementById('tipsList').innerHTML = STATE.data.tips.map(tip => `<div class="tip-card ${tip.priority === 'high' ? 'high' : ''}"><div class="tip-header"><div class="tip-icon">${tip.priority === 'high' ? 'üî•' : 'üí°'}</div><div class="tip-title">${tip.title}</div></div><div class="tip-text">${tip.text}</div><button class="tip-action">${tip.action}</button></div>`).join('');
    }

    function setTab(tabId) {
      if (STATE.mode === 'agent' && tabId === 'overview') { showAgencyDashboard(); return; }
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById('page-' + tabId).classList.add('active');
      document.querySelectorAll('.tab-item').forEach(t => t.classList.toggle('active', t.dataset.tab === tabId));
      if (tabId === 'overview') renderOverview();
      if (tabId === 'positions') renderPositions();
      if (tabId === 'reports') renderReports();
      if (tabId === 'tips') renderTips();
    }

    function refresh() {
      document.getElementById('refreshBtn').classList.add('loading');
      setTimeout(() => { document.getElementById('refreshBtn').classList.remove('loading'); if (STATE.currentSite) selectSite(STATE.currentSite); }, 1000);
    }

    function openChat() { const url = 'https://t.me/' + CONFIG.supportChat; if (tg) tg.openTelegramLink(url); else window.open(url, '_blank'); }
    function telegramLogin() { window.location.href = 'https://t.me/' + CONFIG.botUsername + '?start=login'; }
    function showError(msg) { document.getElementById('loadingOverlay').innerHTML = `<div style="color:#f87171;font-size:48px">‚ö†Ô∏è</div><div style="margin-top:16px">${msg}</div><button onclick="location.reload()" style="margin-top:16px;padding:10px 20px;background:#3b82f6;color:#fff;border:none;border-radius:8px;cursor:pointer">–û–±–Ω–æ–≤–∏—Ç—å</button>`; }

    init();
  </script>
</body>
</html>
