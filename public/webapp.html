<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#0f172a">
    <title>Artvision Portal</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f172a;
            color: white;
            min-height: 100vh;
            padding-bottom: env(safe-area-inset-bottom, 20px);
        }
        .loading { display: flex; align-items: center; justify-content: center; min-height: 100vh; }
        .spinner { width: 40px; height: 40px; border: 3px solid #334155; border-top-color: #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .metric-card { background: rgba(30, 41, 59, 0.5); backdrop-filter: blur(10px); border: 1px solid rgba(51, 65, 85, 0.5); }
        .query-row { border-bottom: 1px solid rgba(51, 65, 85, 0.3); }
        .query-row:last-child { border-bottom: none; }
        .nav-item { transition: all 0.2s; }
        .nav-item.active { color: #3b82f6; }
        .safe-bottom { padding-bottom: calc(70px + env(safe-area-inset-bottom, 0px)); }
    </style>
</head>
<body>
    <div id="app">
        <div class="loading">
            <div class="text-center">
                <div class="spinner mx-auto mb-3"></div>
                <p class="text-slate-400 text-sm">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
            </div>
        </div>
    </div>

    <script>
        // Config
        const API_URL = 'https://artvision-portal.vercel.app/api/webapp/data';
        const MANAGER_LINK = 'https://t.me/avpro_ru';
        
        // State
        let data = null;
        let activeTab = 'dashboard';
        let telegramUser = null;
        
        // Init Telegram
        if (window.Telegram?.WebApp) {
            const tg = window.Telegram.WebApp;
            tg.ready();
            tg.expand();
            telegramUser = tg.initDataUnsafe?.user;
            
            // Main button
            tg.MainButton.setText('üí¨ –ù–∞–ø–∏—Å–∞—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä—É');
            tg.MainButton.show();
            tg.MainButton.onClick(() => tg.openTelegramLink(MANAGER_LINK));
        }
        
        // Fetch data
        async function fetchData() {
            try {
                const tgId = telegramUser?.id || 'demo';
                const response = await fetch(`${API_URL}?telegram_id=${tgId}`);
                data = await response.json();
                render();
            } catch (error) {
                console.error('Fetch error:', error);
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
            }
        }
        
        // Render
        function render() {
            if (!data) return;
            
            const app = document.getElementById('app');
            app.innerHTML = `
                <!-- Header -->
                <header class="sticky top-0 z-50 bg-slate-900/95 backdrop-blur border-b border-slate-800 px-4 py-3">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center font-bold shrink-0">A</div>
                            <div class="min-w-0">
                                <h1 class="font-semibold text-white leading-tight truncate">${data.client.name}</h1>
                                <p class="text-slate-400 text-xs">${data.client.domain}</p>
                            </div>
                        </div>
                        <button onclick="refresh()" class="w-9 h-9 flex items-center justify-center text-slate-400 hover:text-white rounded-lg hover:bg-slate-800">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                        </button>
                    </div>
                </header>
                
                <!-- Content -->
                <main class="px-4 py-4 safe-bottom">
                    ${activeTab === 'dashboard' ? renderDashboard() : ''}
                    ${activeTab === 'positions' ? renderPositions() : ''}
                    ${activeTab === 'reports' ? renderReports() : ''}
                    ${activeTab === 'tips' ? renderTips() : ''}
                </main>
                
                <!-- Nav -->
                <nav class="fixed bottom-0 left-0 right-0 bg-slate-900/95 backdrop-blur border-t border-slate-800" style="padding-bottom: env(safe-area-inset-bottom, 0px)">
                    <div class="flex justify-around py-2 px-2">
                        <button onclick="setTab('dashboard')" class="nav-item flex flex-col items-center gap-0.5 py-2 px-3 rounded-xl ${activeTab === 'dashboard' ? 'active' : 'text-slate-500'}">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
                            <span class="text-[10px]">–û–±–∑–æ—Ä</span>
                        </button>
                        <button onclick="setTab('positions')" class="nav-item flex flex-col items-center gap-0.5 py-2 px-3 rounded-xl ${activeTab === 'positions' ? 'active' : 'text-slate-500'}">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>
                            <span class="text-[10px]">–ü–æ–∑–∏—Ü–∏–∏</span>
                        </button>
                        <button onclick="setTab('reports')" class="nav-item flex flex-col items-center gap-0.5 py-2 px-3 rounded-xl ${activeTab === 'reports' ? 'active' : 'text-slate-500'}">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                            <span class="text-[10px]">–û—Ç—á—ë—Ç—ã</span>
                        </button>
                        <button onclick="setTab('tips')" class="nav-item flex flex-col items-center gap-0.5 py-2 px-3 rounded-xl ${activeTab === 'tips' ? 'active' : 'text-slate-500'}">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>
                            <span class="text-[10px]">–°–æ–≤–µ—Ç—ã</span>
                        </button>
                    </div>
                </nav>
            `;
        }
        
        function renderDashboard() {
            const m = data.metrics;
            return `
                <div class="space-y-4">
                    <!-- Metrics -->
                    <div class="grid grid-cols-2 gap-3">
                        ${metricCard('–ü–æ–∫–∞–∑—ã', m.shows, m.showsChange)}
                        ${metricCard('–ö–ª–∏–∫–∏', m.clicks, m.clicksChange)}
                    </div>
                    
                    <!-- Position -->
                    <div class="metric-card rounded-2xl p-4">
                        <div class="flex items-center justify-between mb-2">
                            <p class="text-slate-400 text-sm">–°—Ä–µ–¥–Ω—è—è –ø–æ–∑–∏—Ü–∏—è</p>
                            <div class="flex items-center gap-1 text-sm ${m.positionChange < 0 ? 'text-emerald-400' : 'text-red-400'}">
                                ${m.positionChange < 0 ? '‚Üë' : '‚Üì'} ${Math.abs(m.positionChange)}%
                            </div>
                        </div>
                        <p class="text-3xl font-bold text-white">${m.avgPosition}</p>
                    </div>
                    
                    <!-- Top Queries -->
                    <div class="metric-card rounded-2xl p-4">
                        <div class="flex items-center justify-between mb-3">
                            <p class="font-semibold">–¢–æ–ø –∑–∞–ø—Ä–æ—Å—ã</p>
                            <button onclick="setTab('positions')" class="text-blue-400 text-sm">–í—Å–µ ‚Üí</button>
                        </div>
                        ${data.topQueries.slice(0, 3).map(queryRow).join('')}
                    </div>
                    
                    <!-- Tip -->
                    ${data.recommendations[0] ? `
                    <div class="bg-gradient-to-br from-amber-500/10 to-orange-500/10 rounded-2xl p-4 border border-amber-500/20">
                        <div class="flex items-center gap-2 mb-2">
                            <span>üí°</span>
                            <p class="font-semibold">–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª —Ä–æ—Å—Ç–∞</p>
                        </div>
                        <p class="text-slate-300 text-sm">${data.recommendations[0].query}</p>
                        <p class="text-amber-400 font-medium mt-1">+${data.recommendations[0].potential.toLocaleString()} –ø–æ–∫–∞–∑–æ–≤/–º–µ—Å</p>
                    </div>
                    ` : ''}
                    
                    ${data.updatedAt ? `<p class="text-center text-slate-500 text-xs">–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${new Date(data.updatedAt).toLocaleString('ru')}</p>` : ''}
                </div>
            `;
        }
        
        function renderPositions() {
            return `
                <div class="space-y-4">
                    <h2 class="text-lg font-bold">–í—Å–µ –∑–∞–ø—Ä–æ—Å—ã</h2>
                    <div class="metric-card rounded-2xl p-4">
                        ${data.topQueries.length ? data.topQueries.map(queryRow).join('') : '<p class="text-slate-400 text-center py-8">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>'}
                    </div>
                </div>
            `;
        }
        
        function renderReports() {
            return `
                <div class="space-y-4">
                    <h2 class="text-lg font-bold">–û—Ç—á—ë—Ç—ã</h2>
                    <div class="metric-card rounded-2xl p-6 text-center">
                        <div class="w-12 h-12 bg-slate-700 rounded-xl flex items-center justify-center mx-auto mb-3">
                            <svg class="w-6 h-6 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                        </div>
                        <p class="text-slate-400 mb-4">–û—Ç—á—ë—Ç—ã –∑–∞ –º–µ—Å—è—Ü</p>
                        <button onclick="requestReport()" class="bg-blue-500/20 text-blue-400 px-4 py-2 rounded-xl text-sm">
                            –ó–∞–ø—Ä–æ—Å–∏—Ç—å –æ—Ç—á—ë—Ç
                        </button>
                    </div>
                </div>
            `;
        }
        
        function renderTips() {
            return `
                <div class="space-y-4">
                    <h2 class="text-lg font-bold">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</h2>
                    ${data.recommendations.map(r => `
                        <div class="metric-card rounded-2xl p-4">
                            <p class="font-medium mb-1">${r.query}</p>
                            <div class="flex items-center justify-between">
                                <span class="text-emerald-400 text-sm">+${r.potential.toLocaleString()} –ø–æ–∫–∞–∑–æ–≤</span>
                                <span class="text-xs px-2 py-1 rounded ${
                                    r.difficulty === 'low' ? 'bg-green-500/20 text-green-400' :
                                    r.difficulty === 'medium' ? 'bg-yellow-500/20 text-yellow-400' :
                                    'bg-red-500/20 text-red-400'
                                }">
                                    ${r.difficulty === 'low' ? '–õ–µ–≥–∫–æ' : r.difficulty === 'medium' ? '–°—Ä–µ–¥–Ω–µ' : '–°–ª–æ–∂–Ω–æ'}
                                </span>
                            </div>
                        </div>
                    `).join('')}
                    
                    <div class="bg-blue-500/10 rounded-2xl p-4 border border-blue-500/20">
                        <div class="flex items-center gap-2 mb-2">
                            <span>üí¨</span>
                            <p class="font-semibold">–ù—É–∂–Ω–∞ –ø–æ–º–æ—â—å?</p>
                        </div>
                        <p class="text-slate-300 text-sm mb-3">–û–±—Å—É–¥–∏–º —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è</p>
                        <button onclick="contactManager()" class="bg-blue-500 text-white px-4 py-2 rounded-xl text-sm w-full">
                            –ù–∞–ø–∏—Å–∞—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä—É
                        </button>
                    </div>
                </div>
            `;
        }
        
        function metricCard(label, value, change) {
            const isPositive = change > 0;
            return `
                <div class="metric-card rounded-2xl p-4">
                    <p class="text-slate-400 text-sm mb-1">${label}</p>
                    <p class="text-2xl font-bold text-white">${value.toLocaleString()}</p>
                    <div class="flex items-center gap-1 mt-1 ${isPositive ? 'text-emerald-400' : 'text-red-400'}">
                        ${isPositive ? '‚Üë' : '‚Üì'} ${Math.abs(change)}%
                    </div>
                </div>
            `;
        }
        
        function queryRow(q) {
            const changeColor = q.change < 0 ? 'text-emerald-400' : q.change > 0 ? 'text-red-400' : 'text-slate-500';
            return `
                <div class="query-row flex items-center gap-3 py-3">
                    <div class="w-10 h-10 rounded-xl bg-slate-700/50 flex items-center justify-center font-bold text-white shrink-0">
                        ${Math.round(q.position)}
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-white font-medium truncate text-sm">${q.query}</p>
                        <p class="text-slate-500 text-xs">${q.shows.toLocaleString()} –ø–æ–∫ ‚Ä¢ ${q.clicks} –∫–ª</p>
                    </div>
                    ${q.change !== 0 ? `
                        <div class="flex items-center shrink-0 ${changeColor}">
                            ${q.change < 0 ? '‚Üë' : '‚Üì'} ${Math.abs(q.change)}
                        </div>
                    ` : ''}
                </div>
            `;
        }
        
        function setTab(tab) {
            activeTab = tab;
            render();
        }
        
        function refresh() {
            document.getElementById('app').innerHTML = '<div class="loading"><div class="text-center"><div class="spinner mx-auto mb-3"></div><p class="text-slate-400 text-sm">–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...</p></div></div>';
            fetchData();
        }
        
        function requestReport() {
            const tg = window.Telegram?.WebApp;
            if (tg) {
                tg.openTelegramLink(MANAGER_LINK + '?text=–•–æ—á—É –ø–æ–ª—É—á–∏—Ç—å –æ—Ç—á—ë—Ç –∑–∞ –º–µ—Å—è—Ü');
            } else {
                window.open(MANAGER_LINK, '_blank');
            }
        }
        
        function contactManager() {
            const tg = window.Telegram?.WebApp;
            if (tg) {
                tg.openTelegramLink(MANAGER_LINK);
            } else {
                window.open(MANAGER_LINK, '_blank');
            }
        }
        
        function showError(msg) {
            document.getElementById('app').innerHTML = `
                <div class="loading">
                    <div class="text-center p-4">
                        <p class="text-white text-lg mb-2">${msg}</p>
                        <button onclick="refresh()" class="bg-blue-500 text-white px-4 py-2 rounded-xl mt-4">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
                    </div>
                </div>
            `;
        }
        
        // Start
        fetchData();
    </script>
</body>
</html>
