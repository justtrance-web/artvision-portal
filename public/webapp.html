<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Artvision Portal</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg-primary: #1a1a2e;
      --bg-secondary: #16213e;
      --bg-card: rgba(255,255,255,0.05);
      --border: rgba(255,255,255,0.08);
      --text-primary: #ffffff;
      --text-secondary: rgba(255,255,255,0.5);
      --accent: #3b82f6;
      --accent-light: #60a5fa;
      --success: #4ade80;
      --warning: #fbbf24;
      --danger: #f87171;
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
      background: linear-gradient(180deg, var(--bg-primary) 0%, var(--bg-secondary) 50%, #0f0f23 100%);
      min-height: 100vh;
      color: var(--text-primary);
      padding-bottom: 160px;
    }
    
    /* === HEADER === */
    .header {
      padding: 16px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      background: rgba(26, 26, 46, 0.95);
      backdrop-filter: blur(20px);
      z-index: 100;
      border-bottom: 1px solid var(--border);
    }
    
    .header-left { display: flex; align-items: center; gap: 14px; }
    
    .avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      font-weight: 600;
    }
    
    .client-name { font-size: 18px; font-weight: 600; }
    .client-domain { font-size: 14px; color: var(--text-secondary); margin-top: 2px; }
    
    .refresh-btn {
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      opacity: 0.6;
      background: none;
      border: none;
      color: #fff;
      cursor: pointer;
      border-radius: 12px;
      transition: all 0.2s;
    }
    .refresh-btn:active { background: var(--bg-card); transform: scale(0.95); }
    .refresh-btn.loading { animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* === CONTENT === */
    .content { padding: 0 16px; }
    .page { display: none; }
    .page.active { display: block; }

    /* === STATS === */
    .stats-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 16px 0; }
    
    .stat-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 18px 20px;
    }
    
    .stat-label { font-size: 15px; color: var(--text-secondary); margin-bottom: 8px; }
    .stat-value { font-size: 36px; font-weight: 700; letter-spacing: -1px; }
    
    .stat-change {
      display: flex;
      align-items: center;
      gap: 4px;
      margin-top: 6px;
      font-size: 16px;
      font-weight: 600;
    }
    .stat-change.up { color: var(--success); }
    .stat-change.down { color: var(--danger); }
    .stat-change svg { width: 14px; height: 14px; }

    /* === POSITION CARD === */
    .position-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 12px;
    }
    
    .position-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
    .position-label { font-size: 15px; color: var(--text-secondary); }
    .position-value { font-size: 42px; font-weight: 700; letter-spacing: -1px; }
    
    .chart-container { height: 120px; margin-top: 16px; }
    .chart-labels { display: flex; justify-content: space-between; margin-top: 10px; font-size: 13px; color: var(--text-secondary); }

    /* === QUERIES === */
    .queries-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 12px;
    }
    
    .queries-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .queries-title { font-size: 18px; font-weight: 600; }
    .queries-all { font-size: 15px; color: var(--accent-light); text-decoration: none; }
    
    .query-item {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 14px 0;
      border-bottom: 1px solid var(--border);
    }
    .query-item:last-child { border-bottom: none; padding-bottom: 0; }
    
    .query-position {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: rgba(96, 165, 250, 0.15);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      font-weight: 700;
      color: var(--accent-light);
      flex-shrink: 0;
    }
    .query-position.top10 { background: rgba(74, 222, 128, 0.15); color: var(--success); }
    .query-position.top20 { background: rgba(251, 191, 36, 0.15); color: var(--warning); }
    .query-position.below { background: rgba(248, 113, 113, 0.15); color: var(--danger); }
    
    .query-info { flex: 1; min-width: 0; }
    .query-text { font-size: 16px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .query-stats { font-size: 14px; color: var(--text-secondary); margin-top: 3px; }
    
    .query-change { font-size: 15px; font-weight: 600; display: flex; align-items: center; gap: 2px; }
    .query-change.up { color: var(--success); }
    .query-change.down { color: var(--danger); }

    /* === REPORTS === */
    .report-item {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 16px 20px;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 14px;
    }
    
    .report-icon { font-size: 32px; }
    .report-info { flex: 1; }
    .report-title { font-size: 16px; font-weight: 600; }
    .report-date { font-size: 13px; color: var(--text-secondary); margin-top: 2px; }
    .report-btn {
      background: var(--accent);
      color: #fff;
      border: none;
      padding: 8px 16px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }

    /* === TIPS === */
    .tip-card {
      background: linear-gradient(135deg, rgba(59,130,246,0.15) 0%, rgba(139,92,246,0.15) 100%);
      border: 1px solid rgba(59,130,246,0.3);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 12px;
    }
    
    .tip-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
    .tip-icon { font-size: 24px; }
    .tip-title { font-size: 16px; font-weight: 600; }
    .tip-text { font-size: 14px; color: var(--text-secondary); line-height: 1.5; }
    .tip-action {
      margin-top: 12px;
      background: var(--accent);
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
    }

    /* === DOCUMENTS (–∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π –∫–∞–±–∏–Ω–µ—Ç) === */
    .doc-item {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 16px 20px;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 14px;
    }
    .doc-icon { font-size: 28px; }
    .doc-info { flex: 1; }
    .doc-title { font-size: 15px; font-weight: 600; }
    .doc-meta { font-size: 13px; color: var(--text-secondary); margin-top: 2px; }
    .doc-status { padding: 4px 10px; border-radius: 8px; font-size: 12px; font-weight: 600; }
    .doc-status.paid { background: rgba(74,222,128,0.15); color: var(--success); }
    .doc-status.pending { background: rgba(251,191,36,0.15); color: var(--warning); }

    /* === AGENCY: Projects Grid === */
    .projects-grid { display: grid; gap: 12px; margin-top: 16px; }
    
    .project-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 16px;
    }
    
    .project-header { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
    .project-avatar { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 18px; }
    .project-name { font-size: 16px; font-weight: 600; }
    .project-domain { font-size: 13px; color: var(--text-secondary); }
    
    .project-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
    .project-stat { text-align: center; }
    .project-stat-value { font-size: 18px; font-weight: 700; }
    .project-stat-label { font-size: 11px; color: var(--text-secondary); }

    /* === AGENCY: Presale Pipeline === */
    .pipeline-stage { margin-bottom: 20px; }
    .stage-header { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; }
    .stage-dot { width: 10px; height: 10px; border-radius: 50%; }
    .stage-name { font-size: 14px; font-weight: 600; color: var(--text-secondary); }
    .stage-count { font-size: 12px; color: var(--text-secondary); margin-left: auto; }
    
    .lead-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px;
      margin-bottom: 8px;
    }
    .lead-name { font-size: 15px; font-weight: 600; }
    .lead-info { font-size: 13px; color: var(--text-secondary); margin-top: 4px; }
    .lead-value { font-size: 14px; font-weight: 600; color: var(--success); margin-top: 6px; }

    /* === TAB BAR === */
    .tab-bar {
      position: fixed;
      bottom: 70px;
      left: 0;
      right: 0;
      background: rgba(15, 15, 35, 0.98);
      backdrop-filter: blur(20px);
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: space-around;
      padding: 10px 0 12px;
      z-index: 100;
    }
    
    .tab-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      color: var(--text-secondary);
      font-size: 11px;
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px 12px;
      border-radius: 8px;
      transition: all 0.2s;
    }
    .tab-item.active { color: var(--accent-light); }
    .tab-item svg { width: 24px; height: 24px; }

    /* === CTA BUTTON === */
    .cta-wrap {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 12px 16px 24px;
      background: linear-gradient(180deg, transparent 0%, rgba(15, 15, 35, 0.98) 30%);
      z-index: 100;
    }
    
    .cta-btn {
      width: 100%;
      height: 54px;
      border-radius: 14px;
      background: linear-gradient(90deg, #3b82f6 0%, #2563eb 100%);
      border: none;
      color: #fff;
      font-size: 17px;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(59, 130, 246, 0.4);
      transition: transform 0.2s;
    }
    .cta-btn:active { transform: scale(0.98); }

    /* === ROLE SWITCHER === */
    .role-switcher {
      display: flex;
      background: var(--bg-card);
      border-radius: 12px;
      padding: 4px;
      margin: 16px 0;
      border: 1px solid var(--border);
    }
    .role-btn {
      flex: 1;
      padding: 10px;
      border: none;
      background: none;
      color: var(--text-secondary);
      font-size: 14px;
      font-weight: 600;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .role-btn.active {
      background: var(--accent);
      color: #fff;
    }

    /* === SECTION TITLE === */
    .section-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin: 20px 0 12px;
    }

    /* === EMPTY STATE === */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-secondary);
    }
    .empty-state-icon { font-size: 48px; margin-bottom: 12px; }
    .empty-state-text { font-size: 15px; }
  </style>
</head>
<body>

  <!-- HEADER -->
  <header class="header">
    <div class="header-left">
      <div class="avatar" id="avatar">A</div>
      <div>
        <div class="client-name" id="clientName">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        <div class="client-domain" id="clientDomain"></div>
      </div>
    </div>
    <button class="refresh-btn" id="refreshBtn" onclick="refresh()">‚Üª</button>
  </header>

  <div class="content">
    
    <!-- Role Switcher (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–≥–µ–Ω—Ç—Å—Ç–≤–∞) -->
    <div class="role-switcher" id="roleSwitcher" style="display:none;">
      <button class="role-btn active" onclick="setRole('client')">üë§ –ö–ª–∏–µ–Ω—Ç</button>
      <button class="role-btn" onclick="setRole('agency')">üè¢ –ê–≥–µ–Ω—Ç—Å—Ç–≤–æ</button>
    </div>

    <!-- ========== CLIENT PAGES ========== -->
    
    <!-- PAGE: Overview -->
    <div class="page active" id="page-overview">
      <div class="stats-row">
        <div class="stat-card">
          <div class="stat-label">–ü–æ–∫–∞–∑—ã</div>
          <div class="stat-value" id="statShows">‚Äî</div>
          <div class="stat-change up" id="changeShows">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M18 15l-6-6-6 6"/></svg>
            <span>‚Äî</span>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-label">–ö–ª–∏–∫–∏</div>
          <div class="stat-value" id="statClicks">‚Äî</div>
          <div class="stat-change up" id="changeClicks">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M18 15l-6-6-6 6"/></svg>
            <span>‚Äî</span>
          </div>
        </div>
      </div>

      <div class="position-card">
        <div class="position-header">
          <div>
            <div class="position-label">–°—Ä–µ–¥–Ω—è—è –ø–æ–∑–∏—Ü–∏—è</div>
            <div class="position-value" id="statPosition">‚Äî</div>
          </div>
          <div class="stat-change up" id="changePosition">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" style="width:14px;height:14px"><path d="M18 15l-6-6-6 6"/></svg>
            <span>‚Äî</span>
          </div>
        </div>
        <div class="chart-container">
          <canvas id="positionsChart"></canvas>
        </div>
        <div class="chart-labels">
          <span>–ù–µ–¥–µ–ª—è –Ω–∞–∑–∞–¥</span>
          <span>–°–µ–≥–æ–¥–Ω—è</span>
        </div>
      </div>

      <div class="queries-card">
        <div class="queries-header">
          <div class="queries-title">–¢–æ–ø –∑–∞–ø—Ä–æ—Å—ã</div>
          <a href="#" class="queries-all" onclick="setTab('positions'); return false;">–í—Å–µ ‚Üó</a>
        </div>
        <div id="topQueries"></div>
      </div>
    </div>

    <!-- PAGE: Positions -->
    <div class="page" id="page-positions">
      <div class="section-title">–í—Å–µ –∑–∞–ø—Ä–æ—Å—ã</div>
      <div id="allQueries"></div>
    </div>

    <!-- PAGE: Reports -->
    <div class="page" id="page-reports">
      <div class="section-title">–û—Ç—á—ë—Ç—ã</div>
      <div id="reportsList"></div>
      
      <div class="section-title">–î–æ–∫—É–º–µ–Ω—Ç—ã</div>
      <div id="docsList"></div>
    </div>

    <!-- PAGE: Tips -->
    <div class="page" id="page-tips">
      <div class="section-title">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ä–æ—Å—Ç—É</div>
      <div id="tipsList"></div>
    </div>

    <!-- ========== AGENCY PAGES ========== -->
    
    <!-- PAGE: Projects -->
    <div class="page" id="page-projects">
      <div class="section-title">–ê–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã</div>
      <div class="projects-grid" id="activeProjects"></div>
      
      <div class="section-title">Presale</div>
      <div class="projects-grid" id="presaleProjects"></div>
    </div>

    <!-- PAGE: Finances -->
    <div class="page" id="page-finances">
      <div class="stats-row">
        <div class="stat-card">
          <div class="stat-label">MRR</div>
          <div class="stat-value" id="statMRR">‚Äî</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">–ü—Ä–æ–µ–∫—Ç–æ–≤</div>
          <div class="stat-value" id="statProjectsCount">‚Äî</div>
        </div>
      </div>
      <div class="position-card">
        <div class="position-label">–î–æ—Ö–æ–¥ –ø–æ –ø—Ä–æ–µ–∫—Ç–∞–º</div>
        <div class="chart-container">
          <canvas id="revenueChart"></canvas>
        </div>
      </div>
    </div>

    <!-- PAGE: Pipeline -->
    <div class="page" id="page-pipeline">
      <div class="section-title">–í–æ—Ä–æ–Ω–∫–∞ –ø—Ä–æ–¥–∞–∂</div>
      <div id="pipelineStages"></div>
    </div>

  </div>

  <!-- TAB BAR -->
  <nav class="tab-bar" id="tabBar">
    <!-- Tabs will be rendered by JS -->
  </nav>

  <!-- CTA BUTTON -->
  <div class="cta-wrap">
    <button class="cta-btn" onclick="openChat()">
      üí¨ –ù–∞–ø–∏—Å–∞—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä—É
    </button>
  </div>

  <script>
    // === CONFIG ===
    const SUPABASE_URL = 'https://gjwdlbwznkwjghquhhyz.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdqd2RsYnd6bmt3amdocXVoaHl6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY0NTEzNjksImV4cCI6MjA4MjAyNzM2OX0.pQTxrgsKygh3S83AvVv9Lg0KgebXBwKbD5ID-gsmdDI';
    
    const AGENCY_USERS = ['antonkamer', 'PandaCaffe', 'mig555555', 'akpersik'];
    
    // === STATE ===
    let state = {
      role: 'client', // 'client' or 'agency'
      currentTab: 'overview',
      isAgencyUser: false,
      client: null,
      data: null,
      loading: true
    };

    // === TELEGRAM ===
    const tg = window.Telegram?.WebApp;
    if (tg) {
      tg.ready();
      tg.expand();
      
      const user = tg.initDataUnsafe?.user;
      if (user && AGENCY_USERS.includes(user.username)) {
        state.isAgencyUser = true;
        state.role = 'agency';
      }
    }

    // === TABS CONFIG ===
    const CLIENT_TABS = [
      { id: 'overview', icon: 'chart', label: '–û–±–∑–æ—Ä' },
      { id: 'positions', icon: 'trend', label: '–ü–æ–∑–∏—Ü–∏–∏' },
      { id: 'reports', icon: 'doc', label: '–û—Ç—á—ë—Ç—ã' },
      { id: 'tips', icon: 'bulb', label: '–°–æ–≤–µ—Ç—ã' }
    ];
    
    const AGENCY_TABS = [
      { id: 'projects', icon: 'grid', label: '–ü—Ä–æ–µ–∫—Ç—ã' },
      { id: 'finances', icon: 'money', label: '–§–∏–Ω–∞–Ω—Å—ã' },
      { id: 'pipeline', icon: 'funnel', label: 'Presale' }
    ];

    // === ICONS ===
    const ICONS = {
      chart: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v18h18"/><path d="M18 9l-5 5-4-4-3 3"/></svg>',
      trend: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 17l6-6 4 4 8-8"/><path d="M17 7h4v4"/></svg>',
      doc: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M9 9h6M9 13h6M9 17h4"/></svg>',
      bulb: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21h6M12 3a6 6 0 0 0-3 11.2V17h6v-2.8A6 6 0 0 0 12 3z"/></svg>',
      grid: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>',
      money: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v12M8 10h8M8 14h8"/></svg>',
      funnel: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 4h18l-7 8v6l-4 2V12L3 4z"/></svg>'
    };

    // === API CONFIG ===
    const API_BASE = 'https://artvision-portal.vercel.app/api/webmaster';
    
    const CLIENTS_CONFIG = {
      'tvorimsovershenstvo.ru': { name: '–¢–≤–æ—Ä–∏–º –°–æ–≤–µ—Ä—à–µ–Ω—Å—Ç–≤–æ', avatar: '–¢–°', color: '#667eea' },
      'vlpco.ru': { name: 'VLPco', avatar: 'VL', color: '#ec4899' },
      'burenie-skv.ru': { name: '–ë—É—Ä–µ–Ω–∏–µ –°–ö–í', avatar: '–ë–°', color: '#06b6d4' },
      'otido.ru': { name: 'Otido', avatar: 'OT', color: '#f59e0b' },
      'extru-tech.ru': { name: 'Extru-Tech', avatar: 'ET', color: '#10b981' }
    };
    
    async function fetchWebmasterData(domain) {
      try {
        const res = await fetch(`${API_BASE}?domain=${domain}`);
        const data = await res.json();
        
        if (data.error) {
          console.error('API error:', data.error);
          return null;
        }
        
        const config = CLIENTS_CONFIG[domain] || { name: data.name, avatar: data.name[0], color: data.color };
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—á–∞–π–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–ª—è –¥–µ–º–æ (–≤ —Ä–µ–∞–ª–µ –Ω—É–∂–Ω–æ —Å—Ä–∞–≤–Ω–∏–≤–∞—Ç—å —Å –ø—Ä–æ—à–ª—ã–º –ø–µ—Ä–∏–æ–¥–æ–º)
        const queries = data.queries.map(q => ({
          ...q,
          change: Math.floor(Math.random() * 6) - 2
        }));
        
        return {
          client: { name: config.name, domain, avatar: config.avatar },
          stats: {
            shows: { value: data.stats.shows, change: Math.floor(Math.random() * 30) },
            clicks: { value: data.stats.clicks, change: Math.floor(Math.random() * 25) },
            position: { value: data.stats.position, change: Math.floor(Math.random() * 15) }
          },
          positions: [15, 14, 13, 12, 11, 10, Math.round(data.stats.position)],
          queries
        };
      } catch (e) {
        console.error('Fetch error:', e);
        return null;
      }
    }
    
    // === DEMO DATA (fallback) ===
    const DEMO_DATA = {
      client: {
        name: "–¢–≤–æ—Ä–∏–º –°–æ–≤–µ—Ä—à–µ–Ω—Å—Ç–≤–æ",
        domain: "tvorimsovershenstvo.ru",
        avatar: "–¢–°"
      },
      stats: {
        shows: { value: 71, change: 23 },
        clicks: { value: 6, change: 15 },
        position: { value: 8.1, change: 8 }
      },
      positions: [14, 13, 12, 11, 10, 9, 8],
      queries: [
        { q: "—Ç–≤–æ—Ä–∏–º —Å–æ–≤–µ—Ä—à–µ–Ω—Å—Ç–≤–æ —Å—Ç–æ–º–∞—Ç–æ–ª–æ–≥–∏—è", pos: 1.3, shows: 9, clicks: 3, change: 2 },
        { q: "—Ç–≤–æ—Ä–∏–º —Å–æ–≤–µ—Ä—à–µ–Ω—Å—Ç–≤–æ", pos: 1.9, shows: 8, clicks: 1, change: 1 },
        { q: "–∫–µ—Ä–∞–º–∏—á–µ—Å–∫–∏–µ –≤–∏–Ω–∏—Ä—ã e max", pos: 6, shows: 7, clicks: 0, change: -1 },
        { q: "–µ–≤—Å–µ–µ–Ω–∫–æ–≤–∞ –∏—Ä–∏–Ω–∞", pos: 8.6, shows: 5, clicks: 1, change: 3 },
        { q: "—Å—Ç–æ–º–∞—Ç–æ–ª–æ–≥–∏—è —Ç–≤–æ—Ä–∏–º", pos: 2.1, shows: 4, clicks: 1, change: 0 }
      ],
      reports: [
        { title: "SEO –æ—Ç—á—ë—Ç ‚Äî –î–µ–∫–∞–±—Ä—å", date: "25.12.2024", type: "seo" },
        { title: "–ö–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω Q1 2025", date: "20.12.2024", type: "plan" }
      ],
      docs: [
        { title: "–°—á—ë—Ç #2024-089", amount: "45 000 ‚ÇΩ", status: "pending" },
        { title: "–ê–∫—Ç #2024-088", amount: "45 000 ‚ÇΩ", status: "paid" }
      ],
      tips: [
        { title: "–î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É —É—Å–ª—É–≥–∏", text: "–°–æ–∑–¥–∞–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É ¬´–õ–µ—á–µ–Ω–∏–µ –ø—É–ª—å–ø–∏—Ç–∞¬ª ‚Äî –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª 120 –ø–æ–∫–∞–∑–æ–≤/–º–µ—Å", priority: "high" },
        { title: "–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å Title", text: "–ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ /implantation Title —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π, —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º —Å–æ–∫—Ä–∞—Ç–∏—Ç—å –¥–æ 60 —Å–∏–º–≤–æ–ª–æ–≤", priority: "medium" }
      ],
      projects: [
        { name: "–¢–≤–æ—Ä–∏–º –°–æ–≤–µ—Ä—à–µ–Ω—Å—Ç–≤–æ", domain: "tvorimsovershenstvo.ru", color: "#667eea", top10: 45, shows: 1247, clicks: 89, mrr: 45000 },
        { name: "Atribeaute", domain: "atribeaute.ru", color: "#10b981", top10: 156, shows: 8400, clicks: 312, mrr: 80000 },
        { name: "ANT Partners", domain: "ant-partners.ru", color: "#f59e0b", top10: 78, shows: 3200, clicks: 156, mrr: 35000 },
        { name: "VLPco", domain: "vlpco.ru", color: "#ec4899", top10: 92, shows: 4100, clicks: 198, mrr: 55000 },
        { name: "–ë—É—Ä–µ–Ω–∏–µ –°–ö–í", domain: "burenie-skv.ru", color: "#06b6d4", top10: 34, shows: 980, clicks: 67, mrr: 25000 }
      ],
      presale: [
        { name: "–ú–µ–¥–¶–µ–Ω—Ç—Ä –ó–¥–æ—Ä–æ–≤—å–µ", industry: "–ú–µ–¥–∏—Ü–∏–Ω–∞", value: "60 000 ‚ÇΩ/–º–µ—Å", stage: "proposal" },
        { name: "–ê–≤—Ç–æ–¢—Ä–µ–π–¥", industry: "–ê–≤—Ç–æ", value: "45 000 ‚ÇΩ/–º–µ—Å", stage: "meeting" },
        { name: "–°—Ç—Ä–æ–π–ú–∞—Å—Ç–µ—Ä", industry: "–°—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ", value: "35 000 ‚ÇΩ/–º–µ—Å", stage: "cold" }
      ]
    };

    // === RENDER FUNCTIONS ===
    function renderTabs() {
      const tabs = state.role === 'agency' ? AGENCY_TABS : CLIENT_TABS;
      const tabBar = document.getElementById('tabBar');
      
      tabBar.innerHTML = tabs.map(tab => `
        <button class="tab-item ${state.currentTab === tab.id ? 'active' : ''}" onclick="setTab('${tab.id}')">
          ${ICONS[tab.icon]}
          <span>${tab.label}</span>
        </button>
      `).join('');
    }

    function renderHeader() {
      const data = currentData || DEMO_DATA;
      document.getElementById('clientName').textContent = state.role === 'agency' ? 'Artvision Agency' : data.client.name;
      document.getElementById('clientDomain').textContent = state.role === 'agency' ? '5 –ø—Ä–æ–µ–∫—Ç–æ–≤' : data.client.domain;
      document.getElementById('avatar').textContent = state.role === 'agency' ? 'AV' : data.client.avatar[0];
      
      // Show role switcher for agency users
      document.getElementById('roleSwitcher').style.display = state.isAgencyUser ? 'flex' : 'none';
    }

    function renderOverview() {
      const d = currentData || DEMO_DATA;
      
      // Stats
      document.getElementById('statShows').textContent = d.stats.shows.value.toLocaleString();
      document.getElementById('statClicks').textContent = d.stats.clicks.value.toLocaleString();
      document.getElementById('statPosition').textContent = d.stats.position.value;
      
      document.querySelector('#changeShows span').textContent = d.stats.shows.change + '%';
      document.querySelector('#changeClicks span').textContent = d.stats.clicks.change + '%';
      document.querySelector('#changePosition span').textContent = d.stats.position.change + '%';
      
      // Top Queries
      document.getElementById('topQueries').innerHTML = d.queries.slice(0, 3).map(q => renderQueryItem(q)).join('');
      
      // Chart
      renderPositionsChart(d.positions);
    }

    function renderQueryItem(q) {
      const posClass = q.pos <= 10 ? 'top10' : q.pos <= 20 ? 'top20' : 'below';
      const changeClass = q.change >= 0 ? 'up' : 'down';
      const changeIcon = q.change >= 0 
        ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" style="width:12px;height:12px"><path d="M18 15l-6-6-6 6"/></svg>'
        : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" style="width:12px;height:12px"><path d="M6 9l6 6 6-6"/></svg>';
      
      return `
        <div class="query-item">
          <div class="query-position ${posClass}">${q.pos}</div>
          <div class="query-info">
            <div class="query-text">${q.q}</div>
            <div class="query-stats">${q.shows} –ø–æ–∫ ¬∑ ${q.clicks} –∫–ª</div>
          </div>
          <div class="query-change ${changeClass}">
            ${changeIcon}
            ${Math.abs(q.change)}
          </div>
        </div>
      `;
    }

    function renderPositions() {
      const d = currentData || DEMO_DATA;
      document.getElementById('allQueries').innerHTML = d.queries.map(q => renderQueryItem(q)).join('');
    }

    function renderReports() {
      const d = DEMO_DATA;
      
      document.getElementById('reportsList').innerHTML = d.reports.map(r => `
        <div class="report-item">
          <div class="report-icon">${r.type === 'seo' ? 'üìä' : 'üìã'}</div>
          <div class="report-info">
            <div class="report-title">${r.title}</div>
            <div class="report-date">${r.date}</div>
          </div>
          <button class="report-btn">–û—Ç–∫—Ä—ã—Ç—å</button>
        </div>
      `).join('');
      
      document.getElementById('docsList').innerHTML = d.docs.map(doc => `
        <div class="doc-item">
          <div class="doc-icon">${doc.status === 'paid' ? '‚úÖ' : 'üìÑ'}</div>
          <div class="doc-info">
            <div class="doc-title">${doc.title}</div>
            <div class="doc-meta">${doc.amount}</div>
          </div>
          <div class="doc-status ${doc.status}">${doc.status === 'paid' ? '–û–ø–ª–∞—á–µ–Ω' : '–û–∂–∏–¥–∞–µ—Ç'}</div>
        </div>
      `).join('');
    }

    function renderTips() {
      document.getElementById('tipsList').innerHTML = DEMO_DATA.tips.map(tip => `
        <div class="tip-card">
          <div class="tip-header">
            <div class="tip-icon">${tip.priority === 'high' ? 'üî•' : 'üí°'}</div>
            <div class="tip-title">${tip.title}</div>
          </div>
          <div class="tip-text">${tip.text}</div>
          <button class="tip-action">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</button>
        </div>
      `).join('');
    }

    async function renderProjects() {
      const container = document.getElementById('activeProjects');
      container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚è≥</div><div class="empty-state-text">–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–µ–∫—Ç–æ–≤...</div></div>';
      
      const projects = [];
      for (const domain of Object.keys(CLIENTS_CONFIG)) {
        try {
          const res = await fetch(`${API_BASE}?domain=${domain}`);
          const data = await res.json();
          if (data && !data.error) {
            projects.push({
              name: data.name || CLIENTS_CONFIG[domain].name,
              domain,
              color: data.color || CLIENTS_CONFIG[domain].color,
              top10: data.stats.top10 || 0,
              shows: data.stats.shows,
              clicks: data.stats.clicks,
              mrr: 45000
            });
          }
        } catch (e) {
          console.error(`Error loading ${domain}:`, e);
        }
      }
      
      if (projects.length === 0) {
        projects.push(...DEMO_DATA.projects);
      }
      
      container.innerHTML = projects.map(p => `
        <div class="project-card">
          <div class="project-header">
            <div class="project-avatar" style="background: ${p.color}">${p.name[0]}</div>
            <div>
              <div class="project-name">${p.name}</div>
              <div class="project-domain">${p.domain}</div>
            </div>
          </div>
          <div class="project-stats">
            <div class="project-stat">
              <div class="project-stat-value">${p.top10}</div>
              <div class="project-stat-label">TOP-10</div>
            </div>
            <div class="project-stat">
              <div class="project-stat-value">${p.shows > 1000 ? (p.shows/1000).toFixed(1) + 'K' : p.shows}</div>
              <div class="project-stat-label">–ü–æ–∫–∞–∑–æ–≤</div>
            </div>
            <div class="project-stat">
              <div class="project-stat-value">${p.clicks}</div>
              <div class="project-stat-label">–ö–ª–∏–∫–æ–≤</div>
            </div>
          </div>
        </div>
      `).join('');
      
      document.getElementById('presaleProjects').innerHTML = DEMO_DATA.presale.map(p => `
        <div class="lead-card">
          <div class="lead-name">${p.name}</div>
          <div class="lead-info">${p.industry}</div>
          <div class="lead-value">${p.value}</div>
        </div>
      `).join('');
    }

    function renderFinances() {
      const d = DEMO_DATA;
      const totalMRR = d.projects.reduce((sum, p) => sum + p.mrr, 0);
      
      document.getElementById('statMRR').textContent = (totalMRR / 1000).toFixed(0) + 'K ‚ÇΩ';
      document.getElementById('statProjectsCount').textContent = d.projects.length;
      
      // Revenue Chart
      const ctx = document.getElementById('revenueChart').getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: d.projects.map(p => p.name.split(' ')[0]),
          datasets: [{
            data: d.projects.map(p => p.mrr / 1000),
            backgroundColor: d.projects.map(p => p.color),
            borderRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#8e8e93' } },
            x: { grid: { display: false }, ticks: { color: '#8e8e93', font: { size: 10 } } }
          }
        }
      });
    }

    function renderPipeline() {
      const stages = [
        { id: 'cold', name: '–•–æ–ª–æ–¥–Ω—ã–µ', color: '#6b7280' },
        { id: 'meeting', name: '–í—Å—Ç—Ä–µ—á–∞', color: '#f59e0b' },
        { id: 'proposal', name: '–ö–ü –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ', color: '#3b82f6' },
        { id: 'negotiation', name: '–ü–µ—Ä–µ–≥–æ–≤–æ—Ä—ã', color: '#8b5cf6' },
        { id: 'closed', name: '–ó–∞–∫—Ä—ã—Ç–æ', color: '#10b981' }
      ];
      
      document.getElementById('pipelineStages').innerHTML = stages.map(stage => {
        const leads = DEMO_DATA.presale.filter(p => p.stage === stage.id);
        return `
          <div class="pipeline-stage">
            <div class="stage-header">
              <div class="stage-dot" style="background: ${stage.color}"></div>
              <div class="stage-name">${stage.name}</div>
              <div class="stage-count">${leads.length}</div>
            </div>
            ${leads.map(lead => `
              <div class="lead-card">
                <div class="lead-name">${lead.name}</div>
                <div class="lead-info">${lead.industry}</div>
                <div class="lead-value">${lead.value}</div>
              </div>
            `).join('')}
          </div>
        `;
      }).join('');
    }

    function renderPositionsChart(positions) {
      const ctx = document.getElementById('positionsChart').getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['', '', '', '', '', '', ''],
          datasets: [{
            data: positions,
            backgroundColor: positions.map(p => 
              p <= 10 ? '#4ade80' : p <= 20 ? '#60a5fa' : '#f87171'
            ),
            borderRadius: 6,
            barThickness: 28
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          indexAxis: 'x',
          scales: {
            y: {
              reverse: true,
              min: 1,
              max: 25,
              grid: { color: 'rgba(255,255,255,0.05)' },
              ticks: { display: false }
            },
            x: { grid: { display: false }, ticks: { display: false } }
          },
          plugins: { legend: { display: false }, tooltip: { enabled: false } }
        }
      });
    }

    // === ACTIONS ===
    function setTab(tabId) {
      state.currentTab = tabId;
      
      // Hide all pages
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      
      // Show selected page
      const page = document.getElementById('page-' + tabId);
      if (page) page.classList.add('active');
      
      renderTabs();
      
      // Render page content
      if (tabId === 'positions') renderPositions();
      if (tabId === 'reports') renderReports();
      if (tabId === 'tips') renderTips();
      if (tabId === 'projects') renderProjects();
      if (tabId === 'finances') renderFinances();
      if (tabId === 'pipeline') renderPipeline();
    }

    function setRole(role) {
      state.role = role;
      state.currentTab = role === 'agency' ? 'projects' : 'overview';
      
      // Update role buttons
      document.querySelectorAll('.role-btn').forEach(btn => {
        btn.classList.toggle('active', btn.textContent.includes(role === 'client' ? '–ö–ª–∏–µ–Ω—Ç' : '–ê–≥–µ–Ω—Ç—Å—Ç–≤–æ'));
      });
      
      renderHeader();
      renderTabs();
      setTab(state.currentTab);
    }

    async function refresh() {
      const btn = document.getElementById('refreshBtn');
      btn.classList.add('loading');
      
      const realData = await fetchWebmasterData('tvorimsovershenstvo.ru');
      if (realData) {
        currentData = { ...DEMO_DATA, ...realData };
      }
      
      btn.classList.remove('loading');
      renderOverview();
    }

    function openChat() {
      if (tg) {
        tg.openTelegramLink('https://t.me/artvision_support');
      } else {
        window.open('https://t.me/artvision_support', '_blank');
      }
    }

    // === INIT ===
    let currentData = DEMO_DATA;
    
    async function init() {
      renderHeader();
      renderTabs();
      renderOverview();
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
      const realData = await fetchWebmasterData('tvorimsovershenstvo.ru');
      if (realData) {
        currentData = { ...DEMO_DATA, ...realData };
        renderHeader();
        renderOverview();
      }
      
      // For agency users
      if (state.isAgencyUser) {
        setRole('agency');
      }
    }

    init();
  </script>
</body>
</html>
